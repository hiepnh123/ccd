<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiểm tra Học Phần - DNU</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            height: 100vh; /* Full viewport height */
            overflow: hidden; /* Prevent body scroll */
        }

        /* Header Styles */
        .main-header {
            background: linear-gradient(135deg, #2196F3 0%, #4CAF50 100%);
            color: white;
            padding: 30px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            width: 100%;
            box-sizing: border-box;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-text {
            text-align: center;
            flex: 1;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .main-title {
            font-size: 2.5em;
            font-weight: bold;
            margin: 0 0 10px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
        }

        .sub-title {
            font-size: 1.1em;
            margin: 0;
            opacity: 0.9;
            font-weight: 300;
            font-style: italic;
        }

        .login-btn, .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .login-btn:hover, .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .main-container {
            padding: 0;
            margin-top: 140px; /* Space for fixed header */
            height: calc(100vh - 140px); /* Full remaining height */
        }

        /* Login Modal */
        .login-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
            margin: 0 0 10px 0;
        }

        .password-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 15px 0;
            outline: none;
            transition: border-color 0.3s;
        }

        .password-input:focus {
            border-color: #4CAF50;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-submit-btn {
            background: #4CAF50;
            color: white;
        }

        .login-submit-btn:hover {
            background: #45a049;
        }

        .cancel-btn {
            background: #f44336;
            color: white;
        }

        .cancel-btn:hover {
            background: #d32f2f;
        }

        .error-message {
            color: #f44336;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        /* Tab Navigation */
        .tab-container {
            max-width: 1200px;
            margin: 0 auto;
            position: fixed;
            top: 140px; /* Below fixed header */
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            width: calc(100% - 40px); /* Account for padding */
            max-width: 1200px;
        }

        /* Hidden state for non-logged in users */
        .tab-container.not-logged-in .tab-nav {
            background: white;
            border-radius: 0px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            justify-content: center;
            align-items: center;
        }

        .tab-container.not-logged-in .tab-button {
            display: none !important;
        }

        .default-message {
            display: none;
            color: #666;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            padding: 15px 20px;
        }

        .tab-container.not-logged-in .default-message {
            display: block;
        }

        .tab-nav {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            border-right: 1px solid #ddd;
        }

        .tab-button:last-child {
            border-right: none;
        }

        .tab-button.active {
            background: #4CAF50;
            color: white;
        }

        .tab-button:hover:not(.active) {
            background: #e9ecef;
            color: #333;
        }

        /* Counter badge in tab */
        .counter {
            background: #ff4757;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
            min-width: 18px;
            text-align: center;
            display: inline-block;
        }

        .counter.zero {
            background: #ddd;
            color: #999;
        }

        /* Program Tab Styles */
        .program-section {
            padding: 30px;
            height: calc(100vh - 200px); /* Fixed height to enable scrolling */
            max-height: calc(100vh - 200px);
            overflow-y: auto; /* Always show scrollbar when needed */
            overflow-x: hidden;
        }

        .program-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .program-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .program-header p {
            color: #666;
            font-size: 14px;
        }

        .program-stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .program-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .action-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn.primary {
            background: #ff4757;
            color: white;
        }

        .action-btn.primary:hover {
            background: #ff3742;
            transform: translateY(-2px);
        }

        .action-btn.secondary {
            background: #2ed573;
            color: white;
        }

        .action-btn.secondary:hover {
            background: #26d065;
            transform: translateY(-2px);
        }

        .program-list {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .empty-state p {
            font-size: 14px;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 0;
            box-shadow: none;
            height: calc(100% - 120px);
            overflow: hidden;
        }

        .tab-content.active {
            display: block;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
            height: 100%;
            align-items: stretch;
            padding: 20px 20px 0 20px;
        }

        /* Phần tìm kiếm */
.search-section {
    flex: 1;
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    height: fit-content;
    align-self: flex-start; /* Align to top and maintain natural height */
}

        .search-section h2 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .search-container {
            position: relative;
            width: 100%;
        }

        .search-bar {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 25px;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-bar:focus {
            border-color: #4CAF50;
        }

        .search-button {
            width: 100%;
            margin-top: 15px;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .search-button:hover {
            background-color: #45a049;
        }

        /* Dropdown gợi ý */
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.2s ease;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover,
        .suggestion-item.highlighted {
            background-color: #f8f9fa;
            border-left: 3px solid #4CAF50;
            padding-left: 13px;
        }

        .suggestion-word {
            font-weight: 600;
            color: #2196F3;
            font-size: 14px;
        }

        .suggestion-category {
            font-size: 11px;
            color: #666;
            background: #e3f2fd;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
            display: inline-block;
            font-weight: 500;
        }

        .suggestion-description {
            font-size: 11px;
            color: #777;
            margin-top: 6px;
            line-height: 1.4;
        }

        .suggestion-description div {
            margin-top: 3px;
        }

        /* Styles for clickable department elements */
        .department-clickable {
            position: relative;
        }

        .department-clickable::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px;
            padding: 1px;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: exclude;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .department-clickable:hover::after {
            opacity: 1;
        }

        .highlight {
            background-color: #ffeb3b;
            font-weight: bold;
        }

        /* Import Tab Styles */
        .import-section {
            padding: 30px;
            height: calc(100vh - 200px); /* Fixed height to enable scrolling */
            max-height: calc(100vh - 200px);
            overflow-y: auto; /* Always show scrollbar when needed */
            overflow-x: hidden;
        }

        .import-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .import-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .import-header p {
            color: #666;
            font-size: 14px;
        }

        .upload-area {
            border: 2px dashed #4CAF50;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            background: #f9f9f9;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #f0f8ff;
            border-color: #2196F3;
        }

        .upload-area.drag-over {
            background: #e8f5e8;
            border-color: #4CAF50;
        }

        .upload-icon {
            font-size: 48px;
            color: #4CAF50;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: background-color 0.3s;
        }

        .upload-btn:hover {
            background: #45a049;
        }

        .preview-section {
            margin-top: 20px;
            display: none;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .preview-table th,
        .preview-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .preview-table tr:hover {
            background: #f8f9fa;
        }

        .import-actions {
            margin-top: 20px;
            text-align: center;
        }

        .import-final-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 10px;
            transition: background-color 0.3s;
        }

        .import-final-btn:hover {
            background: #1976D2;
        }

        .cancel-btn {
            background: #f44336;
        }

        .cancel-btn:hover {
            background: #d32f2f;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .format-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .format-info h4 {
            color: #1976D2;
            margin-bottom: 10px;
        }

        .format-info ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .format-info li {
            margin: 5px 0;
            color: #555;
        }

        /* Sheet Field Configuration Styles */
        .sheet-field-config {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ffeaa7;
            display: none; /* Ẩn ban đầu */
        }

        .sheet-field-config h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .config-item {
            margin-bottom: 15px;
        }

        .config-item label {
            display: block;
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
        }

        .sheet-field-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .sheet-field-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .config-note {
            margin-top: 8px;
            font-size: 13px;
            color: #6c757d;
            font-style: italic;
        }

        /* Sheet Selector Styles */
        .sheet-selector {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: none;
        }

        .sheet-selector h4 {
            color: #495057;
            margin-bottom: 15px;
        }

        .sheet-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .sheet-item {
            padding: 12px 16px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .sheet-item:hover {
            border-color: #4CAF50;
            background: #f8fff8;
        }

        .sheet-item.selected {
            border-color: #4CAF50;
            background: #4CAF50;
            color: white;
        }

        .sheet-item .sheet-name {
            font-weight: 600;
            font-size: 14px;
        }

        .sheet-item .sheet-info {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 4px;
        }

        .sheet-actions {
            text-align: center;
        }

        .process-sheet-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .process-sheet-btn:hover {
            background: #1976D2;
        }

        .process-sheet-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Multi-select styles */
        .sheet-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 18px;
            height: 18px;
            accent-color: #4CAF50;
        }

        .sheet-item {
            position: relative;
            padding-left: 35px;
        }

        .sheet-item.checked {
            border-color: #4CAF50;
            background: #f8fff8;
        }

        .multi-select-controls {
            margin-bottom: 15px;
            text-align: center;
        }

        .select-all-btn, .select-none-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            margin: 0 5px;
            transition: background-color 0.3s;
        }

        .select-all-btn:hover {
            background: #5a6268;
        }

        .select-none-btn:hover {
            background: #5a6268;
        }

        .selected-count {
            color: #4CAF50;
            font-weight: 600;
            margin-top: 10px;
        }

       /* Phần hiển thị kết quả */
.results-section {
    flex: 2;
    background: white;
    padding: 30px 30px 0 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: visible;
    height: 100%;
    display: flex;
    flex-direction: column;
}

        .results-section h2 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        #resultsContainer {
            flex: 1;
            overflow-y: auto; /* Changed from scroll to auto - only show scrollbar when needed */
            overflow-x: hidden;
            max-height: calc(100vh - 320px); /* Adjusted for flat design */
            min-height: calc(100vh - 320px); /* Ensure container always takes full available height */
            padding-bottom: 30px;
            padding-right: 5px;
        }

        /* Custom scrollbar styling for better visibility */
        #resultsContainer::-webkit-scrollbar {
            width: 12px;
        }

        #resultsContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        #resultsContainer::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 6px;
        }

        #resultsContainer::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .no-results {
            text-align: center;
            color: #666;
            font-style: italic;
            margin-top: 50px;
        }

        .result-item {
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #fafafa;
            transition: background-color 0.3s;
        }

        .result-item:hover {
            background-color: #f0f0f0;
        }

        .result-title {
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 5px;
        }

        .result-description {
            color: #666;
            line-height: 1.4;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-title {
                font-size: 1.8em;
            }
            
            .sub-title {
                font-size: 1em;
            }
            
            .main-header {
                padding: 20px 15px;
            }
            
            .container {
                flex-direction: column;
                height: auto;
            }
            
            .search-section, .results-section {
                flex: none;
            }
        }

        /* Settings Styles */
        .settings-section {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            height: calc(100vh - 200px); /* Fixed height to enable scrolling */
            max-height: calc(100vh - 200px);
            overflow-y: auto; /* Always show scrollbar when needed */
            overflow-x: hidden;
        }

        .settings-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }

        .settings-header h2 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }

        .settings-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }

        .display-config {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .display-config h3 {
            color: #333;
            margin: 0 0 25px 0;
            font-size: 24px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .config-group {
            margin-bottom: 35px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .config-group h4 {
            color: #495057;
            margin: 0 0 8px 0;
            font-size: 18px;
        }

        .config-desc {
            color: #6c757d;
            margin: 0 0 15px 0;
            font-size: 14px;
            font-style: italic;
        }

        .field-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: border-color 0.3s;
        }

        .field-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .badge-config {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .checkbox-label:hover {
            background: #e3f2fd;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        .fields-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .fields-order-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
            border: 2px dashed #dee2e6;
        }

        .field-order-item {
            background: #667eea;
            color: white;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: move;
            user-select: none;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .field-order-item:hover {
            transform: translateX(5px);
            background: #5a6fd8;
        }

        .field-order-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .drag-handle {
            font-size: 16px;
        }

        .settings-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .settings-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 180px;
        }

        .settings-btn.primary {
            background: #28a745;
            color: white;
        }

        .settings-btn.primary:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .settings-btn.secondary {
            background: #ffc107;
            color: #212529;
        }

        .settings-btn.secondary:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .settings-btn.info {
            background: #17a2b8;
            color: white;
        }

        .settings-btn.info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .settings-status {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-status.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .settings-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .settings-status.info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .settings-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .settings-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .fields-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Main Header -->
    <div class="main-header">
        <div class="header-content">
            <div class="header-text">
                <h1 class="main-title">TRANG TRA CỨU HỌC PHẦN</h1>
                <p class="sub-title">Trung tâm phát triển CTĐT - Đại học Đại Nam</p>
            </div>
            <div class="header-actions">
                <button id="loginBtn" class="login-btn" onclick="openLoginModal()">
                    🔐 Admin Login
                </button>
                <button id="logoutBtn" class="logout-btn" onclick="logout()" style="display: none;">
                    🚪 Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Tab Navigation -->
        <div class="tab-container" id="tabContainer">
        <div class="tab-nav">
            <div class="default-message" id="defaultMessage">
                📚 Liên hệ ccd@dainam.edu.vn nếu cần tư vấn thêm
            </div>
            <button class="tab-button active" onclick="switchTab('search')" id="searchTabBtn">
                🔍 Tìm Kiếm
            </button>
            <button class="tab-button" onclick="switchTab('program')" id="programTabBtn">
                📋 Chương trình đào tạo <span id="programCounter" class="counter">0</span>
            </button>
            <button class="tab-button" onclick="switchTab('import')" id="importTabBtn" style="display: none;">
                📁 Tạo Database
            </button>
            <button class="tab-button" onclick="switchTab('settings')" id="settingsTabBtn" style="display: none;">
                ⚙️ Cài đặt Hiển thị
            </button>
        </div>

        <!-- Tab 1: Tìm kiếm -->
        <div id="searchTab" class="tab-content active">
            <div class="container">
                <!-- Phần tìm kiếm -->
                <div class="search-section">
                    <h2>🔍 Tìm Kiếm Học Phần</h2>
                    <div class="search-container">
                        <input type="text" id="searchInput" class="search-bar" placeholder="Nhập từ khóa tìm kiếm..." autocomplete="off">
                        <div id="suggestionsDropdown" class="suggestions-dropdown"></div>
                    </div>
                    <button onclick="performSearch()" class="search-button">Tìm Kiếm</button>
                </div>

                <!-- Phần hiển thị kết quả -->
                <div class="results-section">
                    <h2>📊 Kết Quả Tìm Kiếm</h2>
                    <div id="resultsContainer">
                        <div class="no-results">
                            Đang tải dữ liệu...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Program Builder -->
        <div id="programTab" class="tab-content">
            <div class="program-section">
                <div class="program-header">
                    <h2>📋 Chương trình đào tạo</h2>
                    <p>Tập hợp các học phần để xây dựng chương trình đào tạo hoàn chỉnh</p>
                </div>
                
                <div class="program-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalSubjects">0</div>
                        <div class="stat-label">Học phần</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalCredits">0</div>
                        <div class="stat-label">Tín chỉ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalDepartments">0</div>
                        <div class="stat-label">Đơn vị</div>
                    </div>
                </div>
                
                <div class="program-actions">
                    <button class="action-btn primary" onclick="clearProgram()">
                        🗑️ Xóa tất cả
                    </button>
                    <button class="action-btn secondary" onclick="exportProgram()">
                        📤 Xuất danh sách
                    </button>
                </div>
                
                <div class="program-list" id="programList">
                    <div class="empty-state">
                        <div class="empty-icon">📝</div>
                        <h3>Chưa có học phần nào</h3>
                        <p>Vào tab "Tìm Kiếm" để thêm học phần vào chương trình đào tạo</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Import Excel -->
        <div id="importTab" class="tab-content">
            <div class="import-section">
                <div class="import-header">
                    <h2>� Tạo Database JSON Từ Excel</h2>
                    <p>Upload file Excel (.xlsx) để tạo file data.json mới cho việc upload lên host</p>
                </div>

                <!-- Upload Area -->
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📁</div>
                    <h3>Kéo thả file Excel vào đây</h3>
                    <p>hoặc</p>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        Chọn File Excel
                    </button>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
                    <p style="margin-top: 15px; color: #666; font-size: 12px;">Hỗ trợ: .xlsx, .xls (tối đa 10MB)</p>
                </div>

                <!-- Status Messages -->
                <div id="statusMessage" class="status-message"></div>

                <!-- Sheet Selector -->
                <div id="sheetSelector" class="sheet-selector">
                    <h4>📊 Chọn Sheet để Import: <span class="selected-count" id="selectedCount">(0 sheet đã chọn)</span></h4>
                    
                    <div class="multi-select-controls">
                        <button class="select-all-btn" onclick="selectAllSheets()">✅ Chọn Tất Cả</button>
                        <button class="select-none-btn" onclick="selectNoSheets()">❌ Bỏ Chọn Tất Cả</button>
                    </div>
                    
                    <div id="sheetList" class="sheet-list"></div>
                    <div class="sheet-actions">
                        <button id="processSheetBtn" class="process-sheet-btn" onclick="processSelectedSheets()" disabled>
                            ✅ Xử Lý Sheet Đã Chọn
                        </button>
                    </div>
                </div>

                <!-- Sheet Field Name Configuration -->
                <div class="sheet-field-config">
                    <h4>🏷️ Cấu hình tên trường từ Sheet:</h4>
                    <div class="config-item">
                        <label for="sheetFieldName">Tên trường lấy từ tên Sheet (chỉ áp dụng khi file có nhiều sheet):</label>
                        <input type="text" id="sheetFieldName" class="sheet-field-input" 
                               value="Đơn vị quản lý học phần" 
                               placeholder="Nhập tên trường mong muốn...">
                        <p class="config-note">💡 Khi file Excel có nhiều sheet, giá trị tên sheet sẽ được lưu vào trường này</p>
                    </div>
                </div>

                <!-- Format Info -->
                <div class="format-info">
                    <h4>📋 Định dạng file Excel:</h4>
                    <ul>
                        <li><strong>Dòng đầu tiên:</strong> Tên các cột (STT, Mã HP, Tên Tiếng Việt, Tên Tiếng Anh, v.v.)</li>
                        <li><strong>Các dòng tiếp theo:</strong> Dữ liệu tương ứng với từng cột</li>
                        <li><strong>Tự động phát hiện:</strong> Hệ thống sẽ sử dụng tên header làm tên trường hiển thị</li>
                        <li><strong>Tags/Keywords:</strong> Nếu tên cột chứa "tag" hoặc "keyword", sẽ tự động xử lý như danh sách</li>
                    </ul>
                    <p style="margin-top: 10px; color: #666;"><strong>Ví dụ:</strong> STT | Mã HP | Tên Tiếng Việt | Tên Tiếng Anh</p>
                </div>

                <!-- Preview Section -->
                <div id="previewSection" class="preview-section">
                    <h3>🔍 Preview Dữ Liệu:</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table id="previewTable" class="preview-table">
                            <thead id="previewTableHead">
                                <!-- Headers sẽ được tạo động từ Excel -->
                            </thead>
                            <tbody id="previewTableBody"></tbody>
                        </table>
                    </div>
                    
                    <div class="import-actions">
                        <button class="import-final-btn" onclick="generateJSON()">
                            💾 Tải File data.json
                        </button>
                        <button class="import-final-btn cancel-btn" onclick="cancelImport()">
                            ❌ Hủy
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 4: Display Settings -->
        <div id="settingsTab" class="tab-content">
            <div class="settings-section">
                <div class="settings-header">
                    <h2>⚙️ Cài đặt Hiển thị</h2>
                    <p>Cấu hình cách hiển thị các trường dữ liệu trong kết quả tìm kiếm</p>
                </div>

                <!-- Display Configuration -->
                <div class="display-config">
                    <h3>📋 Cấu hình Hiển thị Trường</h3>
                    
                    <!-- Primary Field Setting -->
                    <div class="config-group">
                        <h4>🏆 Trường chính (Title)</h4>
                        <p class="config-desc">Trường hiển thị làm tiêu đề chính của mỗi kết quả</p>
                        <select id="primaryFieldSelect" class="field-select">
                            <option value="">Chọn trường chính...</option>
                        </select>
                    </div>

                    <!-- Secondary Field Setting -->
                    <div class="config-group">
                        <h4>🥈 Trường phụ (Subtitle)</h4>
                        <p class="config-desc">Trường hiển thị bên cạnh tiêu đề chính</p>
                        <select id="secondaryFieldSelect" class="field-select">
                            <option value="">Chọn trường phụ...</option>
                        </select>
                    </div>

                    <!-- Badge Fields Settings -->
                    <div class="config-group">
                        <h4>🏷️ Các Badge Hiển thị</h4>
                        <p class="config-desc">Các trường hiển thị dưới dạng badge có thể click</p>
                        
                        <div class="badge-config">
                            <label class="checkbox-label">
                                <input type="checkbox" id="showCreditBadge" checked>
                                <span>Hiển thị Badge Tín chỉ</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="showDepartmentBadge" checked>
                                <span>Hiển thị Badge Đơn vị quản lý</span>
                            </label>
                        </div>
                    </div>

                    <!-- Fields to Hide Settings -->
                    <div class="config-group">
                        <h4>🙈 Các Trường Ẩn</h4>
                        <p class="config-desc">Chọn các trường không muốn hiển thị trong phần chi tiết</p>
                        <div id="fieldsToHideContainer" class="fields-container">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Fields Display Order -->
                    <div class="config-group">
                        <h4>🔄 Thứ tự Hiển thị Trường</h4>
                        <p class="config-desc">Kéo thả để sắp xếp thứ tự hiển thị các trường</p>
                        <div id="fieldsOrderContainer" class="fields-order-container">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Settings Actions -->
                <div class="settings-actions">
                    <button class="settings-btn primary" onclick="saveDisplaySettings()">
                        💾 Lưu Cài đặt
                    </button>
                    <button class="settings-btn secondary" onclick="resetDisplaySettings()">
                        ♾️ Khôi phục Mặc định
                    </button>
                    <button class="settings-btn info" onclick="previewDisplaySettings()">
                        👁️ Xem trước
                    </button>
                </div>

                <!-- Settings Status -->
                <div id="settingsStatus" class="settings-status"></div>
            </div>
        </div>
    </div>
    <!-- End Main Container -->

    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔐 Admin Login</h2>
                <p style="color: #666; font-size: 14px;">Nhập mật khẩu để truy cập chức năng quản trị</p>
            </div>
            <div class="modal-body">
                <input type="password" id="passwordInput" class="password-input" placeholder="Nhập mật khẩu admin..." maxlength="50">
                <div id="errorMessage" class="error-message">Mật khẩu không đúng!</div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn login-submit-btn" onclick="attemptLogin()">🔓 Đăng Nhập</button>
                <button class="modal-btn cancel-btn" onclick="closeLoginModal()">❌ Hủy</button>
            </div>
        </div>
    </div>

    <script>
        let dictionaryData = [];
        let currentHighlightIndex = -1;
        let pendingImportData = [];
        let dataStructure = {}; // Store dynamic field structure
        let excelWorkbook = null; // Store loaded Excel workbook
        let selectedSheetNames = []; // Store multiple selected sheet names
        let isLoggedIn = false; // Authentication state
        const ADMIN_PASSWORD = "admin@133"; // Change this to your desired password
        let detectedSheetFieldName = null; // Trường được phát hiện tự động chứa thông tin sheet
        let detectedCreditFieldName = null; // Trường được phát hiện tự động chứa thông tin số tín chỉ
        
        // Program Builder variables
        let selectedProgram = []; // Array to store selected subjects
        let programStats = { subjects: 0, credits: 0, departments: 0 }; // Program statistics

        // Display Settings variables
        let displayConfig = {
            primaryField: 'Tên tiếng Việt',
            secondaryField: 'Mã HP', 
            showCreditBadge: true,
            showDepartmentBadge: true,
            fieldsToHide: ['STT', 'Số thứ tự', 'Đơn vị quản lý', 'Quản lý', 'id'],
            fieldsOrder: [] // Will be populated from dataStructure
        };
        
        const DEFAULT_CONFIG = {
            primaryField: 'Tên tiếng Việt',
            secondaryField: 'Mã HP',
            showCreditBadge: true,
            showDepartmentBadge: true,
            fieldsToHide: ['STT', 'Số thứ tự', 'Đơn vị quản lý', 'Quản lý', 'id'],
            fieldsOrder: []
        };

        // Helper function to escape HTML attributes
        function escapeHtml(text) {
            return String(text).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        // Helper function to ensure field detection is done
        function ensureFieldDetection() {
            if (!detectedCreditFieldName) {
                detectCreditFieldName();
            }
            if (!detectedSheetFieldName) {
                detectSheetFieldName();
            }
            
            // If dataStructure is empty but we have selectedProgram data, build basic structure
            if (Object.keys(dataStructure).length === 0 && selectedProgram.length > 0) {
                const firstItem = selectedProgram[0];
                Object.keys(firstItem).forEach(key => {
                    dataStructure[key] = {
                        displayName: key,
                        type: Array.isArray(firstItem[key]) ? 'array' : 'string'
                    };
                });
            }
        }

        // Function to auto-detect credit field name
        function detectCreditFieldName() {
            // Use dictionaryData first, fallback to selectedProgram
            let dataSource = dictionaryData;
            if (!dataSource || dataSource.length === 0) {
                if (selectedProgram && selectedProgram.length > 0) {
                    dataSource = selectedProgram;
                } else {
                    detectedCreditFieldName = null;
                    return null;
                }
            }

            const firstItem = dataSource[0];
            const allFields = Object.keys(firstItem).filter(key => key !== 'id');
            
            // Tìm field có tên gợi ý về tín chỉ
            const possibleNames = [
                'Số TC', 'Số tín chỉ', 'Tín chỉ', 'TC', 'Credit', 'Credits', 'ECTS'
            ];
            
            for (let fieldName of allFields) {
                if (possibleNames.some(name => fieldName.toLowerCase().includes(name.toLowerCase()))) {
                    detectedCreditFieldName = fieldName;
                    console.log('Detected credit field by name:', fieldName);
                    return fieldName;
                }
            }
            
            // Nếu không tìm thấy dựa trên tên, tìm field có giá trị số nhỏ (thường là 1-6 tín chỉ)
            for (let fieldName of allFields) {
                const fieldValues = dataSource.map(item => item[fieldName]).filter(val => val != null);
                const uniqueValues = [...new Set(fieldValues)];
                
                // Kiểm tra xem field này có phải chứa số tín chỉ không
                const allNumbers = uniqueValues.every(val => {
                    const num = Number(val);
                    return !isNaN(num) && num > 0 && num <= 10; // Tín chỉ thường từ 1-10
                });
                
                if (allNumbers && uniqueValues.length <= 8) { // Không quá nhiều unique values
                    detectedCreditFieldName = fieldName;
                    console.log('Detected credit field by pattern:', fieldName, 'with values:', uniqueValues);
                    return fieldName;
                }
            }
            
            detectedCreditFieldName = null;
            console.log('No credit field detected');
            return null;
        }

        // Function to auto-detect sheet field name
        function detectSheetFieldName() {
            // Use dictionaryData first, fallback to selectedProgram
            let dataSource = dictionaryData;
            if (!dataSource || dataSource.length === 0) {
                if (selectedProgram && selectedProgram.length > 0) {
                    dataSource = selectedProgram;
                } else {
                    detectedSheetFieldName = null;
                    return null;
                }
            }

            // Lấy item đầu tiên để phân tích
            const firstItem = dataSource[0];
            const allFields = Object.keys(firstItem).filter(key => key !== 'id');
            
            // Tìm field có tên gợi ý về đơn vị/khoa/sheet
            const possibleNames = [
                'Đơn vị quản lý học phần', 'Quản lý', 'Khoa', 'Phòng ban', 'Bộ môn', 'Đơn vị', 
                'Department', 'Faculty', 'Unit', 'Division', 'Sheet', 'Thằng chó con ngựa'
            ];
            
            for (let fieldName of allFields) {
                // Kiểm tra xem có phải field chứa thông tin đơn vị không
                if (possibleNames.some(name => fieldName.toLowerCase().includes(name.toLowerCase()))) {
                    detectedSheetFieldName = fieldName;
                    console.log('Detected sheet field by name:', fieldName);
                    return fieldName;
                }
            }
            
            // Nếu không tìm thấy dựa trên tên, thử tìm field có values giống tên sheet
            // (để dự phòng cho trường hợp tên field được đặt tùy chỉnh)
            // Detect credit field để exclude nó khỏi sheet field detection
            const creditField = detectCreditFieldName();
            
            for (let fieldName of allFields) {
                // Skip credit field và các field có patterns không phải sheet field
                if (fieldName === creditField) continue;
                
                // Skip fields có patterns của ID, code, tên course
                if (fieldName.toLowerCase().includes('stt') || 
                    fieldName.toLowerCase().includes('mã') ||
                    fieldName.toLowerCase().includes('tên') ||
                    fieldName.toLowerCase().includes('name') ||
                    fieldName.toLowerCase().includes('title') ||
                    fieldName.toLowerCase().includes('code')) {
                    continue;
                }
                
                const fieldValues = dataSource.map(item => item[fieldName]).filter(val => val);
                const uniqueValues = [...new Set(fieldValues)];
                
                // Nếu field này có ít unique values và tất cả values đều là string ngắn
                // thì có thể đây là field chứa thông tin sheet/đơn vị
                if (uniqueValues.length <= 10 && uniqueValues.length > 0) {
                    const allShortStrings = uniqueValues.every(val => 
                        typeof val === 'string' && val.length < 100 && val.length > 0
                    );
                    if (allShortStrings) {
                        detectedSheetFieldName = fieldName;
                        console.log('Detected sheet field by pattern:', fieldName, 'with values:', uniqueValues);
                        return fieldName;
                    }
                }
            }
            
            detectedSheetFieldName = null;
            return null;
        }



        // Function to display filtered results
        function displayFilteredResults(results, fieldName, fieldValue) {
            ensureFieldDetection();
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <h3>😔 Không tìm thấy kết quả</h3>
                        <p>Không có học phần nào có <strong>${fieldName}</strong> là "<strong>${fieldValue}</strong>"</p>
                    </div>
                `;
                return;
            }

            const totalItems = results.length;
            let filteredHTML = `
                <div style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; color: white;">
                    <h3 style="margin: 0 0 8px 0; font-size: 18px;">🔍 ${fieldName}: ${fieldValue}</h3>
                    <p style="margin: 0; font-size: 14px; opacity: 0.9;">Tổng cộng: <strong>${totalItems}</strong> học phần</p>
                </div>
            `;

            // Hiển thị từng item
            filteredHTML += results.map(item => {
                const fields = getOrderedFields();
                let resultHTML = '<div class="result-item">';
                
                // Hiển thị trường theo cài đặt display config
                const primaryField = getPrimaryField();
                const primaryValue = item[primaryField];
                const secondaryField = getSecondaryField();
                const secondaryValue = item[secondaryField];
                
                resultHTML += `<div class="result-title" style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">${String(primaryValue)}`;
                if (secondaryValue && secondaryField !== primaryField) {
                    resultHTML += ` <span style="font-size: 14px; color: #666; font-weight: bold;">- ${secondaryValue}</span>`;
                }
                resultHTML += `</div>`;
                
                // Section cho các badges quan trọng và nút thêm - sử dụng justify-between để tách badge và nút
                resultHTML += `<div style="margin: 10px 0; display: flex; justify-content: space-between; align-items: center; gap: 8px;">`;
                
                // Container cho các badge (bên trái)
                resultHTML += `<div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">`;
                
                // Badge trường được filter (hiển thị với màu xanh da trời)
                if (item[fieldName]) {
                    resultHTML += `<span style="background: #007bff; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 600; display: inline-block;">🔍 ${fieldName}: ${item[fieldName]}</span>`;
                }
                
                // Badge Credit (nếu có và khác với trường đang filter)
                const creditField = detectCreditFieldName();
                if (creditField && item[creditField] && fieldName !== creditField) {
                    resultHTML += `<span class="clickable-badge credit-badge" data-field="${escapeHtml(creditField)}" data-value="${escapeHtml(item[creditField])}" style="background: #ff9800; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-block;" onmouseover="this.style.background='#f57f17'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#ff9800'; this.style.transform='scale(1)'" title="Click để lọc theo ${creditField}: ${item[creditField]}">📊 ${item[creditField]} TC</span>`;
                }
                
                // Badge Đơn vị quản lý (nếu có và khác với trường đang filter)
                const departmentField = 'Quản lý';
                if (item[departmentField] && fieldName !== departmentField) {
                    resultHTML += `<span class="clickable-badge department-badge" data-field="${escapeHtml(departmentField)}" data-value="${escapeHtml(item[departmentField])}" style="background: #28a745; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-block;" onmouseover="this.style.background='#20c997'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#28a745'; this.style.transform='scale(1)'" title="Click để xem tất cả học phần của đơn vị này">📁 ${item[departmentField]}</span>`;
                }
                
                resultHTML += `</div>`; // Đóng container badge
                
                // Add to program button (bên phải) - thêm ngay vào đây thay vì đặt riêng
                ensureFieldDetection();
                // Sử dụng cùng primary/secondary field với hiển thị
                let checkPrimaryField = primaryField;
                let checkSecondaryField = secondaryField;
                
                const isAlreadyAdded = selectedProgram.some(programItem => 
                    programItem[checkPrimaryField] === item[checkPrimaryField] && 
                    (checkSecondaryField ? programItem[checkSecondaryField] === item[checkSecondaryField] : true)
                );
                
                if (isAlreadyAdded) {
                    resultHTML += `<button class="add-to-program-btn added" disabled style="background: #4caf50; color: white; border: none; padding: 6px 16px; border-radius: 20px; font-size: 12px; cursor: default; opacity: 0.8; flex-shrink: 0;">✓ Đã thêm</button>`;
                } else {
                    resultHTML += `<button class="add-to-program-btn" onclick="addToProgram(${JSON.stringify(item).replace(/"/g, '&quot;')}, event)" style="background: #2196f3; color: white; border: none; padding: 6px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s; flex-shrink: 0;" onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='#2196f3'">➕ Thêm vào danh sách</button>`;
                }
                
                resultHTML += `</div>`; // Đóng main flex container
                
                // Hiển thị các trường khác (theo cài đặt displayConfig)
                fields.forEach(fieldDisplayName => {
                    // Skip các field theo cấu hình displayConfig và field đang được filter
                    if (!shouldShowField(fieldDisplayName) || fieldDisplayName === fieldName) return;
                    
                    const value = item[fieldDisplayName];
                    const fieldDisplay = dataStructure[fieldDisplayName].displayName;
                    
                    if (value) {
                        if (Array.isArray(value)) {
                            // Hiển thị array (tags) - chỉ hiển thị, không có link
                            resultHTML += `<div style="margin-top: 12px;">`;
                            resultHTML += `<span style="font-size: 13px; color: #666; font-weight: 600;">${fieldDisplay}: </span>`;
                            resultHTML += value.map(tag => 
                                `<span style="background: #e3f2fd; padding: 3px 8px; border-radius: 12px; font-size: 12px; margin-right: 6px; color: #1976d2; display: inline-block; margin-top: 2px;">${tag}</span>`
                            ).join('');
                            resultHTML += `</div>`;
                        } else {
                            // Hiển thị text thường - chỉ hiển thị, không có link
                            resultHTML += `<div style="margin-top: 10px; font-size: 14px; line-height: 1.4;">`;
                            resultHTML += `<span style="color: #666; font-weight: 600;">${fieldDisplay}:</span> `;
                            resultHTML += `<span style="color: #333;">${String(value)}</span>`;
                            resultHTML += `</div>`;
                        }
                    }
                });

                // Button đã được thêm vào cùng hàng với badge ở trên

                resultHTML += '</div>';
                return resultHTML;
            }).join('');

            resultsContainer.innerHTML = filteredHTML;
        }

        // Authentication functions
        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
            document.getElementById('passwordInput').focus();
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('passwordInput').value = '';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function attemptLogin() {
            const password = document.getElementById('passwordInput').value;
            const errorMsg = document.getElementById('errorMessage');
            
            if (password === ADMIN_PASSWORD) {
                isLoggedIn = true;
                localStorage.setItem('isLoggedIn', 'true'); // Save login state
                closeLoginModal();
                updateUIForLoginState();
                showStatus('Đăng nhập thành công! Chào mừng Admin.', 'success');
            } else {
                errorMsg.style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }

        function logout() {
            isLoggedIn = false;
            localStorage.removeItem('isLoggedIn'); // Remove login state
            updateUIForLoginState();
            // Switch back to search tab
            switchTab('search');
            showStatus('Đã đăng xuất khỏi chế độ Admin.', 'error');
        }

        function updateUIForLoginState() {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const importTabBtn = document.getElementById('importTabBtn');
            const settingsTabBtn = document.getElementById('settingsTabBtn');
            const tabContainer = document.getElementById('tabContainer');
            const searchTabBtn = document.getElementById('searchTabBtn');
            
            if (isLoggedIn) {
                // Show admin controls
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                importTabBtn.style.display = 'block';
                settingsTabBtn.style.display = 'block';
                tabContainer.classList.remove('not-logged-in');
                
                // Show tab text
                searchTabBtn.style.color = '';
                importTabBtn.style.color = '';
                settingsTabBtn.style.color = '';
                
                // Populate settings UI when admin logs in
                if (Object.keys(dataStructure).length > 0) {
                    populateSettingsUI();
                }
            } else {
                // Hide admin controls
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                importTabBtn.style.display = 'none';
                settingsTabBtn.style.display = 'none';
                tabContainer.classList.add('not-logged-in');
                
                // Hide tab text
                searchTabBtn.style.color = 'transparent';
            }
        }

        // Enhanced tab switching with login check
        function switchTab(tabName) {
            // Check if trying to access admin tabs without login
            if ((tabName === 'import' || tabName === 'settings') && !isLoggedIn) {
                openLoginModal();
                return;
            }
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Update active button
            if (tabName === 'search') {
                document.getElementById('searchTabBtn').classList.add('active');
                // Refresh search results to update button states when switching to search tab
                refreshCurrentView();
            } else if (tabName === 'program') {
                document.getElementById('programTabBtn').classList.add('active');
                // Refresh program list when switching to program tab
                renderProgramList();
            } else if (tabName === 'import') {
                document.getElementById('importTabBtn').classList.add('active');
            } else if (tabName === 'settings') {
                document.getElementById('settingsTabBtn').classList.add('active');
                // Populate settings UI when switching to settings tab
                populateSettingsUI();
            }
        }

        // Password input enter key support
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    attemptLogin();
                }
            });
            
            // Close modal when clicking outside
            document.getElementById('loginModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeLoginModal();
                }
            });
            
            // Initialize UI state
            updateUIForLoginState();
        });

        // Original tab switching (keeping for compatibility)
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // Refresh content when switching tabs
            if (tabName === 'search') {
                // Refresh search results to update button states
                refreshCurrentView();
            } else if (tabName === 'program') {
                // Refresh program list
                renderProgramList();
            }
        }

        // Analyze JSON structure to get dynamic fields
        function analyzeDataStructure(data) {
            if (!data || !Array.isArray(data) || data.length === 0) {
                return {};
            }

            const structure = {};
            const firstItem = data[0];
            
            // Define desired field order - "Tên tiếng Việt" first, then others
            const fieldOrder = ['Tên tiếng Việt', 'Mã HP'];
            const allKeys = Object.keys(firstItem).filter(key => key !== 'id');
            
            // Add prioritized fields first
            fieldOrder.forEach(key => {
                if (allKeys.includes(key)) {
                    const value = firstItem[key];
                    structure[key] = {
                        type: Array.isArray(value) ? 'array' : typeof value,
                        displayName: formatFieldName(key),
                        searchable: true
                    };
                }
            });
            
            // Add remaining fields
            allKeys.forEach(key => {
                if (!fieldOrder.includes(key)) {
                    const value = firstItem[key];
                    structure[key] = {
                        type: Array.isArray(value) ? 'array' : typeof value,
                        displayName: formatFieldName(key),
                        searchable: true
                    };
                }
            });

            return structure;
        }

        // Analyze JSON structure with display config
        function analyzeDataStructureWithConfig(data) {
            if (!data || !Array.isArray(data) || data.length === 0) {
                return {};
            }

            const structure = {};
            const firstItem = data[0];
            
            // Use display config field order if available
            const fieldOrder = displayConfig.fieldsOrder.length > 0 
                ? displayConfig.fieldsOrder 
                : [displayConfig.primaryField, displayConfig.secondaryField];
            
            const allKeys = Object.keys(firstItem).filter(key => key !== 'id');
            
            // Add prioritized fields first
            fieldOrder.forEach(key => {
                if (allKeys.includes(key)) {
                    const value = firstItem[key];
                    structure[key] = {
                        type: Array.isArray(value) ? 'array' : typeof value,
                        displayName: formatFieldName(key),
                        searchable: true
                    };
                }
            });
            
            // Add remaining fields
            allKeys.forEach(key => {
                if (!fieldOrder.includes(key)) {
                    const value = firstItem[key];
                    structure[key] = {
                        type: Array.isArray(value) ? 'array' : typeof value,
                        displayName: formatFieldName(key),
                        searchable: true
                    };
                }
            });

            return structure;
        }

        // Format field names for display - sử dụng tên trường gốc
        function formatFieldName(fieldName) {
            // Không dùng mapping nữa, trả về tên trường gốc
            // Chỉ format chữ cái đầu thành hoa
            return fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
        }

        // Function to remove Vietnamese diacritics for fuzzy search
        function removeDiacritics(str) {
            return str.normalize('NFD')
                     .replace(/[\u0300-\u036f]/g, '') // Loại bỏ dấu
                     .replace(/đ/g, 'd').replace(/Đ/g, 'D'); // Chuyển đ thành d
        }

        // Display Settings Functions
        async function loadDisplaySettings() {
            try {
                const response = await fetch('display-config.json');
                if (response.ok) {
                    const config = await response.json();
                    displayConfig = { ...DEFAULT_CONFIG, ...config };
                    console.log('Display settings loaded:', displayConfig);
                } else {
                    console.log('No display config found, using defaults');
                    displayConfig = { ...DEFAULT_CONFIG };
                }
            } catch (error) {
                console.log('Error loading display config:', error);
                displayConfig = { ...DEFAULT_CONFIG };
            }
        }

        async function saveDisplaySettings() {
            try {
                const configData = {
                    primaryField: displayConfig.primaryField,
                    secondaryField: displayConfig.secondaryField,
                    showCreditBadge: displayConfig.showCreditBadge,
                    showDepartmentBadge: displayConfig.showDepartmentBadge,
                    fieldsToHide: displayConfig.fieldsToHide,
                    fieldsOrder: displayConfig.fieldsOrder,
                    lastUpdated: new Date().toISOString()
                };

                // Create a downloadable JSON file
                const blob = new Blob([JSON.stringify(configData, null, 2)], { 
                    type: 'application/json' 
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'display-config.json';
                a.click();
                URL.revokeObjectURL(url);

                showSettingsStatus('✅ Cài đặt đã được lưu! Tải file display-config.json và upload lên host cùng với các file khác.', 'success');
                
                // Also update current session
                updateDisplayConfigFromUI();
                refreshCurrentView();
                
            } catch (error) {
                console.error('Error saving display settings:', error);
                showSettingsStatus('❌ Lỗi khi lưu cài đặt: ' + error.message, 'error');
            }
        }

        function updateDisplayConfigFromUI() {
            displayConfig.primaryField = document.getElementById('primaryFieldSelect').value;
            displayConfig.secondaryField = document.getElementById('secondaryFieldSelect').value;
            displayConfig.showCreditBadge = document.getElementById('showCreditBadge').checked;
            displayConfig.showDepartmentBadge = document.getElementById('showDepartmentBadge').checked;
            
            // Update fields to hide
            const hideCheckboxes = document.querySelectorAll('#fieldsToHideContainer input[type="checkbox"]');
            displayConfig.fieldsToHide = [];
            hideCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    displayConfig.fieldsToHide.push(checkbox.value);
                }
            });

            // Update fields order
            const orderItems = document.querySelectorAll('#fieldsOrderContainer .field-order-item');
            displayConfig.fieldsOrder = Array.from(orderItems).map(item => item.dataset.field);
        }

        function resetDisplaySettings() {
            if (confirm('Bạn có chắc muốn khôi phục về cài đặt mặc định không?')) {
                displayConfig = { ...DEFAULT_CONFIG };
                populateSettingsUI();
                showSettingsStatus('🔄 Đã khôi phục cài đặt mặc định', 'info');
            }
        }

        function previewDisplaySettings() {
            updateDisplayConfigFromUI();
            switchTab('search');
            refreshCurrentView();
            showStatus('👁️ Đang xem trước với cài đặt mới. Quay lại Settings để điều chỉnh hoặc lưu.', 'info');
        }

        function populateSettingsUI() {
            if (Object.keys(dataStructure).length === 0) return;

            const fields = getOrderedFields();
            
            // Populate field selects
            const primarySelect = document.getElementById('primaryFieldSelect');
            const secondarySelect = document.getElementById('secondaryFieldSelect');
            
            primarySelect.innerHTML = '<option value="">Chọn trường chính...</option>';
            secondarySelect.innerHTML = '<option value="">Chọn trường phụ...</option>';
            
            fields.forEach(field => {
                primarySelect.innerHTML += `<option value="${field}" ${field === displayConfig.primaryField ? 'selected' : ''}>${field}</option>`;
                secondarySelect.innerHTML += `<option value="${field}" ${field === displayConfig.secondaryField ? 'selected' : ''}>${field}</option>`;
            });

            // Set badge checkboxes
            document.getElementById('showCreditBadge').checked = displayConfig.showCreditBadge;
            document.getElementById('showDepartmentBadge').checked = displayConfig.showDepartmentBadge;

            // Populate fields to hide
            const hideContainer = document.getElementById('fieldsToHideContainer');
            hideContainer.innerHTML = '';
            fields.forEach(field => {
                const isHidden = displayConfig.fieldsToHide.includes(field);
                hideContainer.innerHTML += `
                    <label class="checkbox-label">
                        <input type="checkbox" value="${field}" ${isHidden ? 'checked' : ''}>
                        <span>${field}</span>
                    </label>
                `;
            });

            // Populate fields order
            const orderContainer = document.getElementById('fieldsOrderContainer');
            orderContainer.innerHTML = '';
            
            const orderedFields = displayConfig.fieldsOrder.length > 0 
                ? displayConfig.fieldsOrder 
                : fields;
            
            orderedFields.forEach(field => {
                if (fields.includes(field)) {
                    const div = document.createElement('div');
                    div.className = 'field-order-item';
                    div.dataset.field = field;
                    div.draggable = true;
                    div.innerHTML = `
                        <span class="drag-handle">⋮⋮</span>
                        <span>${field}</span>
                    `;
                    orderContainer.appendChild(div);
                }
            });

            // Add drag and drop functionality
            addDragAndDropToFieldsOrder();
        }

        function addDragAndDropToFieldsOrder() {
            const container = document.getElementById('fieldsOrderContainer');
            let draggedElement = null;

            container.addEventListener('dragstart', function(e) {
                draggedElement = e.target;
                e.target.classList.add('dragging');
            });

            container.addEventListener('dragend', function(e) {
                e.target.classList.remove('dragging');
                draggedElement = null;
            });

            container.addEventListener('dragover', function(e) {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                if (afterElement == null) {
                    container.appendChild(draggedElement);
                } else {
                    container.insertBefore(draggedElement, afterElement);
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.field-order-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function showSettingsStatus(message, type) {
            const status = document.getElementById('settingsStatus');
            status.textContent = message;
            status.className = `settings-status ${type}`;
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    status.textContent = '';
                    status.className = 'settings-status';
                }, 5000);
            }
        }

        // Apply display config to field rendering
        function getOrderedFields() {
            const allFields = Object.keys(dataStructure);
            if (displayConfig.fieldsOrder.length > 0) {
                // Use configured order, add any missing fields at the end
                const orderedFields = [...displayConfig.fieldsOrder];
                allFields.forEach(field => {
                    if (!orderedFields.includes(field)) {
                        orderedFields.push(field);
                    }
                });
                return orderedFields.filter(field => allFields.includes(field));
            }
            return allFields;
        }

        function shouldShowField(fieldName) {
            return !displayConfig.fieldsToHide.includes(fieldName);
        }

        function getPrimaryField() {
            const fields = getOrderedFields();
            return displayConfig.primaryField && fields.includes(displayConfig.primaryField) 
                ? displayConfig.primaryField 
                : fields[0];
        }

        function getSecondaryField() {
            const fields = getOrderedFields();
            return displayConfig.secondaryField && fields.includes(displayConfig.secondaryField) 
                ? displayConfig.secondaryField 
                : fields[1];
        }

        // Get searchable value from field (with diacritics removed for fuzzy search)
        function getSearchableValue(item, fieldName) {
            const value = item[fieldName];
            let searchableText = '';
            
            if (Array.isArray(value)) {
                searchableText = value.join(' ');
            } else {
                searchableText = String(value || '');
            }
            
            // Return both original lowercase and no-diacritics version for fuzzy matching
            const lowercased = searchableText.toLowerCase();
            const noDiacritics = removeDiacritics(lowercased);
            return { original: lowercased, fuzzy: noDiacritics };
        }

        // Load dữ liệu từ file JSON
        async function loadData() {
            try {
                // Load display settings first
                await loadDisplaySettings();
                
                const response = await fetch('data.json');
                const data = await response.json();
                dictionaryData = data.dictionary;
                
                // Analyze structure after loading data
                dataStructure = analyzeDataStructureWithConfig(dictionaryData);
                console.log('Data structure detected:', dataStructure);
                
                // Tự động phát hiện các trường quan trọng
                const detectedSheetField = detectSheetFieldName();
                const detectedCreditField = detectCreditFieldName();
                console.log('Sheet field detected:', detectedSheetField);
                console.log('Credit field detected:', detectedCreditField);
                
                // Update default config with detected fields if not set
                if (!displayConfig.fieldsOrder.length) {
                    displayConfig.fieldsOrder = Object.keys(dataStructure);
                }
                
                // Populate settings UI if admin is logged in
                if (isLoggedIn) {
                    populateSettingsUI();
                }
                
                // Hiển thị toàn bộ dữ liệu khi vừa load xong
                displayAllData();
                
            } catch (error) {
                console.error('Lỗi load dữ liệu:', error);
                // Fallback data nếu không load được file JSON
                dictionaryData = [
                    {
                        id: 1,
                        word: "JavaScript",
                        category: "Ngôn ngữ lập trình",
                        description: "Ngôn ngữ lập trình thông dịch, hướng đối tượng với các hàm hạng nhất",
                        details: "JavaScript là ngôn ngữ lập trình được sử dụng rộng rãi để phát triển web",
                        tags: ["frontend", "backend", "web", "programming"]
                    }
                ];
                dataStructure = analyzeDataStructure(dictionaryData);
                displayAllData();
            }
        }

        // Debounce function để tránh gọi quá nhiều lần
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Highlight matching text
        function highlightText(text, searchTerm) {
            if (!searchTerm) return text;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // Tìm kiếm và hiển thị gợi ý
        function showSuggestions(searchTerm) {
            const dropdown = document.getElementById('suggestionsDropdown');
            
            if (!searchTerm || searchTerm.trim().length < 1) {
                dropdown.style.display = 'none';
                return;
            }

            // Kiểm tra dữ liệu đã tải chưa
            if (!dictionaryData || !Array.isArray(dictionaryData) || dictionaryData.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            const searchLower = searchTerm.toLowerCase().trim();
            const searchFuzzy = removeDiacritics(searchLower);
            
            // Tìm kiếm với độ ưu tiên: Mã HP > Tên tiếng Việt > Tên tiếng Anh > Các trường khác
            const results = dictionaryData.filter(item => {
                const maHP = getSearchableValue(item, 'Mã HP');
                const tenViet = getSearchableValue(item, 'Tên tiếng Việt');
                const tenAnh = getSearchableValue(item, 'Tên tiếng Anh');
                
                // Ưu tiên tìm kiếm trong các trường chính (với fuzzy search)
                return maHP.original.includes(searchLower) || maHP.fuzzy.includes(searchFuzzy) || 
                       tenViet.original.includes(searchLower) || tenViet.fuzzy.includes(searchFuzzy) || 
                       tenAnh.original.includes(searchLower) || tenAnh.fuzzy.includes(searchFuzzy) ||
                       // Tìm kiếm trong các trường khác
                       Object.keys(dataStructure).some(fieldName => {
                           if (['Mã HP', 'Tên tiếng Việt', 'Tên tiếng Anh'].includes(fieldName)) return false;
                           const searchableValue = getSearchableValue(item, fieldName);
                           return searchableValue.original.includes(searchLower) || searchableValue.fuzzy.includes(searchFuzzy);
                       });
            })
            // Sắp xếp kết quả theo độ ưu tiên
            .sort((a, b) => {
                const aCode = getSearchableValue(a, 'Mã HP');
                const bCode = getSearchableValue(b, 'Mã HP');
                const aViet = getSearchableValue(a, 'Tên tiếng Việt');
                const bViet = getSearchableValue(b, 'Tên tiếng Việt');
                
                // Ưu tiên mã HP khớp chính xác
                if (aCode.original === searchLower && bCode.original !== searchLower) return -1;
                if (bCode.original === searchLower && aCode.original !== searchLower) return 1;
                
                // Ưu tiên mã HP bắt đầu bằng search term (original hoặc fuzzy)
                if ((aCode.original.startsWith(searchLower) || aCode.fuzzy.startsWith(searchFuzzy)) && 
                    !(bCode.original.startsWith(searchLower) || bCode.fuzzy.startsWith(searchFuzzy))) return -1;
                if ((bCode.original.startsWith(searchLower) || bCode.fuzzy.startsWith(searchFuzzy)) && 
                    !(aCode.original.startsWith(searchLower) || aCode.fuzzy.startsWith(searchFuzzy))) return 1;
                
                // Ưu tiên tên tiếng Việt bắt đầu bằng search term (original hoặc fuzzy)
                if ((aViet.original.startsWith(searchLower) || aViet.fuzzy.startsWith(searchFuzzy)) && 
                    !(bViet.original.startsWith(searchLower) || bViet.fuzzy.startsWith(searchFuzzy))) return -1;
                if ((bViet.original.startsWith(searchLower) || bViet.fuzzy.startsWith(searchFuzzy)) && 
                    !(aViet.original.startsWith(searchLower) || aViet.fuzzy.startsWith(searchFuzzy))) return 1;
                
                return 0;
            })
            .slice(0, 8); // Giới hạn 8 kết quả

            if (results.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            dropdown.innerHTML = results.map((item, index) => {
                const maHP = item['Mã HP'] || '';
                const tenViet = item['Tên tiếng Việt'] || '';
                const tenAnh = item['Tên tiếng Anh'] || '';
                const donVi = detectedSheetFieldName ? (item[detectedSheetFieldName] || '') : '';
                const creditValue = detectedCreditFieldName ? (item[detectedCreditFieldName] || '') : '';
                
                // Xác định trường nào khớp với search term để highlight
                let primaryText = '';
                let matchedField = '';
                
                const maHPSearchable = getSearchableValue(item, 'Mã HP');
                const tenVietSearchable = getSearchableValue(item, 'Tên tiếng Việt');
                const tenAnhSearchable = getSearchableValue(item, 'Tên tiếng Anh');
                
                if (maHPSearchable.original.includes(searchLower) || maHPSearchable.fuzzy.includes(searchFuzzy)) {
                    primaryText = maHP;
                    matchedField = 'Mã HP';
                } else if (tenVietSearchable.original.includes(searchLower) || tenVietSearchable.fuzzy.includes(searchFuzzy)) {
                    primaryText = tenViet;
                    matchedField = 'Tên tiếng Việt';
                } else if (tenAnhSearchable.original.includes(searchLower) || tenAnhSearchable.fuzzy.includes(searchFuzzy)) {
                    primaryText = tenAnh;
                    matchedField = 'Tên tiếng Anh';
                } else {
                    primaryText = tenViet || maHP;
                    matchedField = 'Tên tiếng Việt';
                }
                
                return `
                    <div class="suggestion-item" data-index="${index}" data-word="${primaryText}" data-item-id="${item.id}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <span class="suggestion-word">${highlightText(String(primaryText), searchTerm)}</span>
                                <span class="suggestion-category">${maHP}</span>
                                ${creditValue ? `<span class="clickable-badge credit-badge" data-field="${escapeHtml(detectedCreditFieldName)}" data-value="${escapeHtml(creditValue)}" style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#f57f17'" onmouseout="this.style.background='#ff9800'" title="Click để lọc theo ${detectedCreditFieldName}: ${creditValue}">${creditValue} TC</span>` : ''}
                            </div>
                        </div>
                        <div class="suggestion-description">
                            ${matchedField !== 'Tên tiếng Việt' && tenViet ? `<div style="font-size: 11px; color: #555; margin-top: 2px;">${highlightText(tenViet, searchTerm)}</div>` : ''}
                            ${matchedField !== 'Tên tiếng Anh' && tenAnh ? `<div style="font-size: 10px; color: #777; font-style: italic; margin-top: 1px;">${highlightText(tenAnh, searchTerm)}</div>` : ''}
                            ${donVi ? `<div class="clickable-badge department-badge" data-field="${escapeHtml(detectedSheetFieldName)}" data-value="${escapeHtml(donVi)}" style="font-size: 9px; color: #999; margin-top: 2px; cursor: pointer;" onmouseover="this.style.color='#007bff'" onmouseout="this.style.color='#999'" title="Click để xem tất cả học phần của đơn vị này">📁 ${donVi}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            dropdown.style.display = 'block';
            currentHighlightIndex = -1;
        }

        // Thực hiện tìm kiếm và hiển thị kết quả chi tiết
        function performSearch(searchTerm = null, isExactMatch = false, selectedItemId = null) {
            const term = searchTerm || document.getElementById('searchInput').value.trim();
            const resultsContainer = document.getElementById('resultsContainer');

            // Nếu không có search term, hiển thị toàn bộ dữ liệu
            if (!term) {
                displayAllData();
                return;
            }

            // Check if term is in format "FieldName: FieldValue" (from badge clicks)
            const fieldSearchMatch = term.match(/^(.+?):\s*(.+)$/);
            if (fieldSearchMatch) {
                const fieldName = fieldSearchMatch[1].trim();
                const fieldValue = fieldSearchMatch[2].trim();
                console.log('Detected field search format:', fieldName, ':', fieldValue);
                
                // Use searchByField directly
                searchByField(fieldName, fieldValue);
                return;
            }

            let results = [];

            if (isExactMatch && selectedItemId) {
                // Nếu là exact match từ suggestion, chỉ hiển thị item được chọn
                results = dictionaryData.filter(item => item.id === selectedItemId);
            } else {
                // Tìm kiếm thông thường với fuzzy search
                const searchLower = term.toLowerCase();
                const searchFuzzy = removeDiacritics(searchLower);
                
                results = dictionaryData.filter(item => {
                    // Tìm kiếm trong tất cả các trường
                    return Object.keys(dataStructure).some(fieldName => {
                        const searchableValues = getSearchableValue(item, fieldName);
                        // Tìm kiếm cả bản gốc và bản không dấu
                        return searchableValues.original.includes(searchLower) || 
                               searchableValues.fuzzy.includes(searchFuzzy);
                    });
                });
            }

            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">Không tìm thấy kết quả nào phù hợp</div>';
            } else {
                resultsContainer.innerHTML = results.map(item => {
                    const fields = getOrderedFields();
                    let resultHTML = '<div class="result-item">';
                    
                    // Hiển thị trường theo cài đặt display config
                    const primaryField = getPrimaryField();
                    const primaryValue = item[primaryField];
                    const secondaryField = getSecondaryField();
                    const secondaryValue = item[secondaryField];
                    
                    resultHTML += `<div class="result-title" style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">${highlightText(String(primaryValue), term)}`;
                    if (secondaryValue && secondaryField !== primaryField) {
                        resultHTML += ` <span style="font-size: 14px; color: #666; font-weight: bold;">- ${secondaryValue}</span>`;
                    }
                    resultHTML += `</div>`;
                    
                    // Section cho các badges quan trọng (có thể click)
                    resultHTML += `<div style="margin: 10px 0; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">`;
                    
                    // Badges container (left side)
                    resultHTML += `<div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">`;
                    
                    // Badge Credit (nếu có)
                    if (detectedCreditFieldName && item[detectedCreditFieldName]) {
                        resultHTML += `<span class="clickable-badge credit-badge" data-field="${escapeHtml(detectedCreditFieldName)}" data-value="${escapeHtml(item[detectedCreditFieldName])}" style="background: #ff9800; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-block;" onmouseover="this.style.background='#f57f17'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#ff9800'; this.style.transform='scale(1)'" title="Click để lọc theo ${detectedCreditFieldName}: ${item[detectedCreditFieldName]}">📊 ${item[detectedCreditFieldName]} TC</span>`;
                    }
                    
                    // Badge Tên học phần (nếu có)
                    const departmentField = 'Quản lý';
                    if (item[departmentField]) {
                        resultHTML += `<span class="clickable-badge department-badge" data-field="${escapeHtml(departmentField)}" data-value="${escapeHtml(item[departmentField])}" style="background: #28a745; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-block;" onmouseover="this.style.background='#20c997'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#28a745'; this.style.transform='scale(1)'" title="Click để xem tất cả học phần của đơn vị này">📁 ${item[departmentField]}</span>`;
                    }
                    
                    resultHTML += `</div>`; // Close badges container
                    
                    // Nút thêm vào chương trình (right side)
                    ensureFieldDetection();
                    // Sử dụng cùng primary/secondary field với hiển thị
                    let btnCheckPrimaryField = primaryField;
                    let btnCheckSecondaryField = secondaryField;
                    
                    const btnIsAlreadyAdded = selectedProgram.some(programItem => 
                        programItem[btnCheckPrimaryField] === item[btnCheckPrimaryField] && 
                        (btnCheckSecondaryField ? programItem[btnCheckSecondaryField] === item[btnCheckSecondaryField] : true)
                    );
                    
                    if (btnIsAlreadyAdded) {
                        resultHTML += `<button class="add-to-program-btn added" disabled style="background: #4caf50; color: white; border: none; padding: 6px 16px; border-radius: 20px; font-size: 12px; cursor: default; opacity: 0.8;">✓ Đã thêm</button>`;
                    } else {
                        resultHTML += `<button class="add-to-program-btn" onclick="addToProgram(${JSON.stringify(item).replace(/"/g, '&quot;')}, event)" style="background: #2196f3; color: white; border: none; padding: 6px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='#2196f3'">➕ Thêm vào danh sách</button>`;
                    }
                    
                    resultHTML += `</div>`; // Close main badges section
                    
                    // Hiển thị các trường khác (theo cài đặt displayConfig)
                    fields.forEach(fieldName => {
                        // Skip các field theo cấu hình displayConfig
                        if (!shouldShowField(fieldName)) return;
                        
                        const value = item[fieldName];
                        const fieldDisplay = dataStructure[fieldName].displayName;
                        
                        if (value) {
                            if (Array.isArray(value)) {
                                // Hiển thị array (tags) - chỉ hiển thị, không có link
                                resultHTML += `<div style="margin-top: 12px;">`;
                                resultHTML += `<span style="font-size: 13px; color: #666; font-weight: 600;">${fieldDisplay}: </span>`;
                                resultHTML += value.map(tag => 
                                    `<span style="background: #e3f2fd; padding: 3px 8px; border-radius: 12px; font-size: 12px; margin-right: 6px; color: #1976d2; display: inline-block; margin-top: 2px;">${highlightText(String(tag), term)}</span>`
                                ).join('');
                                resultHTML += `</div>`;
                            } else {
                                // Hiển thị text thường - chỉ hiển thị, không có link
                                resultHTML += `<div style="margin-top: 10px; font-size: 14px; line-height: 1.4;">`;
                                resultHTML += `<span style="color: #666; font-weight: 600;">${fieldDisplay}:</span> `;
                                resultHTML += `<span style="color: #333;">${highlightText(String(value), term)}</span>`;
                                resultHTML += `</div>`;
                            }
                        }
                    });
                    
                    // Add to program button

                    
                    resultHTML += '</div>';
                    return resultHTML;
                }).join('');
            }

            // Ẩn dropdown sau khi tìm kiếm
            document.getElementById('suggestionsDropdown').style.display = 'none';
        }

        // Debounced search function - giảm delay để phản hồi nhanh hơn
        const debouncedSearch = debounce(showSuggestions, 150);

        // Hàm tìm kiếm theo bất kỳ trường nào
        function searchByField(fieldName, fieldValue) {
            const results = dictionaryData.filter(item => {
                const itemValue = item[fieldName];
                const normalizedItemValue = itemValue ? String(itemValue).trim() : '';
                const normalizedSearchValue = String(fieldValue).trim();
                
                return itemValue && normalizedItemValue === normalizedSearchValue;
            });

            const resultsContainer = document.getElementById('resultsContainer');
            const searchInput = document.getElementById('searchInput');
            
            // Cập nhật search input
            searchInput.value = `${fieldName}: ${fieldValue}`;
            
            // Ẩn dropdown suggestions
            document.getElementById('suggestionsDropdown').style.display = 'none';

            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <h3>😔 Không tìm thấy kết quả</h3>
                        <p>Không có học phần nào có <strong>${fieldName}</strong> là "<strong>${fieldValue}</strong>"</p>
                    </div>
                `;
                return;
            }

            // Hiển thị kết quả giống như displayFilteredResults
            displayFilteredResults(results, fieldName, fieldValue);
        }

        // Hàm tìm kiếm theo đơn vị quản lý học phần (backward compatibility)
        function searchByDepartment(departmentName) {
            if (detectedSheetFieldName) {
                searchByField(detectedSheetFieldName, departmentName);
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Helper function to decode HTML entities
            function decodeHtml(html) {
                const txt = document.createElement('textarea');
                txt.innerHTML = html;
                return txt.value;
            }
            
            // Thêm event delegation cho clickable badges
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('clickable-badge')) {
                    // Ngăn chặn event bubbling để không trigger suggestion item click
                    e.stopPropagation();
                    e.preventDefault();
                    
                    const fieldName = decodeHtml(e.target.getAttribute('data-field') || '');
                    const fieldValue = decodeHtml(e.target.getAttribute('data-value') || '');
                    
                    if (fieldName && fieldValue) {
                        searchByField(fieldName, fieldValue);
                    }
                }
            });

            const searchInput = document.getElementById('searchInput');
            const dropdown = document.getElementById('suggestionsDropdown');

            // Realtime search khi gõ
            searchInput.addEventListener('input', function(e) {
                const value = e.target.value;
                if (value.trim() === '') {
                    // Nếu search box trống, hiển thị toàn bộ dữ liệu
                    displayAllData();
                    dropdown.style.display = 'none';
                } else if (dictionaryData && dictionaryData.length > 0) {
                    // Chỉ hiển thị gợi ý khi dữ liệu đã được tải
                    debouncedSearch(value);
                } else {
                    // Nếu dữ liệu chưa tải, ẩn dropdown
                    dropdown.style.display = 'none';
                }
            });

            // Keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.suggestion-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentHighlightIndex = Math.min(currentHighlightIndex + 1, items.length - 1);
                    updateHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentHighlightIndex = Math.max(currentHighlightIndex - 1, -1);
                    updateHighlight(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentHighlightIndex >= 0 && items[currentHighlightIndex]) {
                        const word = items[currentHighlightIndex].dataset.word;
                        const itemId = parseInt(items[currentHighlightIndex].dataset.itemId);
                        searchInput.value = word;
                        dropdown.style.display = 'none';
                        performSearch(word, true, itemId); // true = isExactMatch, itemId = selected item ID
                    } else {
                        // Nếu không có item nào được highlight, thực hiện tìm kiếm thông thường
                        dropdown.style.display = 'none';
                        performSearch();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.style.display = 'none';
                    currentHighlightIndex = -1;
                }
            });

            // Click on suggestion
            dropdown.addEventListener('click', function(e) {
                const item = e.target.closest('.suggestion-item');
                if (item) {
                    const word = item.dataset.word;
                    const itemId = parseInt(item.dataset.itemId);
                    searchInput.value = word;
                    dropdown.style.display = 'none';
                    performSearch(word, true, itemId); // true = isExactMatch, itemId = selected item ID
                }
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    dropdown.style.display = 'none';
                    currentHighlightIndex = -1;
                }
            });
        });

        function updateHighlight(items) {
            items.forEach((item, index) => {
                if (index === currentHighlightIndex) {
                    item.classList.add('highlighted');
                } else {
                    item.classList.remove('highlighted');
                }
            });
        }

        // Hiển thị toàn bộ dữ liệu
        function displayAllData() {
            ensureFieldDetection();
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (!dictionaryData || dictionaryData.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">Chưa có dữ liệu nào được tải</div>';
                return;
            }

            const totalItems = dictionaryData.length;
            
            // Hiển thị header thông tin tổng quan
            let allDataHTML = `
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                    <h3 style="color: #2e7d32; margin: 0 0 5px 0;">📚 Toàn bộ danh sách học phần</h3>
                    <p style="color: #666; margin: 0; font-size: 14px;">Tổng cộng: <strong>${totalItems}</strong> học phần từ các đơn vị</p>
                </div>
            `;

            // Hiển thị từng item
            allDataHTML += dictionaryData.map(item => {
                const fields = getOrderedFields();
                let resultHTML = '<div class="result-item">';
                
                // Hiển thị trường đầu tiên làm title (sử dụng display config)
                const primaryField = getPrimaryField();
                const primaryValue = item[primaryField];
                const secondaryField = getSecondaryField();
                const secondaryValue = item[secondaryField];
                
                resultHTML += `<div class="result-title" style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">${String(primaryValue)}`;
                if (secondaryValue && secondaryField !== primaryField) {
                    resultHTML += ` <span style="font-size: 14px; color: #666; font-weight: bold;">- ${secondaryValue}</span>`;
                }
                resultHTML += `</div>`;
                
                // Section cho các badges quan trọng (có thể click)
                resultHTML += `<div style="margin: 10px 0; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">`;
                
                // Badges container (left side)
                resultHTML += `<div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">`;
                
                // Badge Credit (nếu có)
                if (detectedCreditFieldName && item[detectedCreditFieldName]) {
                    resultHTML += `<span class="clickable-badge credit-badge" data-field="${escapeHtml(detectedCreditFieldName)}" data-value="${escapeHtml(item[detectedCreditFieldName])}" style="background: #ff9800; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-block;" onmouseover="this.style.background='#f57f17'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#ff9800'; this.style.transform='scale(1)'" title="Click để lọc theo ${detectedCreditFieldName}: ${item[detectedCreditFieldName]}">📊 ${item[detectedCreditFieldName]} TC</span>`;
                }
                
                // Badge Tên học phần (nếu có)
                const departmentField = 'Quản lý';
                if (item[departmentField]) {
                    resultHTML += `<span class="clickable-badge department-badge" data-field="${escapeHtml(departmentField)}" data-value="${escapeHtml(item[departmentField])}" style="background: #28a745; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-block;" onmouseover="this.style.background='#20c997'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#28a745'; this.style.transform='scale(1)'" title="Click để xem tất cả học phần của đơn vị này">📁 ${item[departmentField]}</span>`;
                }
                
                resultHTML += `</div>`; // Close badges container
                
                // Nút thêm vào chương trình (right side)
                const isAlreadyAdded = selectedProgram.some(programItem => 
                    programItem[primaryField] === item[primaryField] && 
                    (secondaryField ? programItem[secondaryField] === item[secondaryField] : true)
                );
                
                if (isAlreadyAdded) {
                    resultHTML += `<button class="add-to-program-btn" style="background: #4caf50; color: white; border: none; padding: 6px 16px; border-radius: 20px; font-size: 12px; cursor: default; opacity: 0.7;">✓ Đã thêm</button>`;
                } else {
                    resultHTML += `<button class="add-to-program-btn" onclick="addToProgram(${JSON.stringify(item).replace(/"/g, '&quot;')}, event)" style="background: #2196f3; color: white; border: none; padding: 6px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#1976d2'" onmouseout="this.style.background='#2196f3'">➕ Thêm vào danh sách</button>`;
                }
                
                resultHTML += `</div>`;
                
                // Hiển thị các trường khác (theo cài đặt displayConfig)
                fields.forEach(fieldName => {
                    // Skip các field theo cấu hình displayConfig
                    if (!shouldShowField(fieldName)) return;
                    
                    const value = item[fieldName];
                    const fieldDisplay = dataStructure[fieldName].displayName;
                    
                    if (value) {
                        if (Array.isArray(value)) {
                            // Hiển thị array (tags) - chỉ hiển thị, không có link
                            resultHTML += `<div style="margin-top: 12px;">`;
                            resultHTML += `<span style="font-size: 13px; color: #666; font-weight: 600;">${fieldDisplay}: </span>`;
                            resultHTML += value.map(tag => 
                                `<span style="background: #e3f2fd; padding: 3px 8px; border-radius: 12px; font-size: 12px; margin-right: 6px; color: #1976d2; display: inline-block; margin-top: 2px;">${String(tag)}</span>`
                            ).join('');
                            resultHTML += `</div>`;
                        } else {
                            // Hiển thị text thường - chỉ hiển thị, không có link
                            resultHTML += `<div style="margin-top: 10px; font-size: 14px; line-height: 1.4;">`;
                            resultHTML += `<span style="color: #666; font-weight: 600;">${fieldDisplay}:</span> `;
                            resultHTML += `<span style="color: #333;">${String(value)}</span>`;
                            resultHTML += `</div>`;
                        }
                    }
                });
                
                resultHTML += '</div>';
                return resultHTML;
            }).join('');

            resultsContainer.innerHTML = allDataHTML;
        }

        // Excel Import Functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processExcelFile(file);
            }
        }

        function processExcelFile(file) {
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                showStatus('File quá lớn! Vui lòng chọn file nhỏ hơn 10MB.', 'error');
                return;
            }

            // Reset UI state
            document.getElementById('sheetSelector').style.display = 'none';
            document.getElementById('previewSection').style.display = 'none';
            updateFieldConfigVisibility(false);

            showStatus('Đang đọc file Excel...', 'success');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    excelWorkbook = XLSX.read(data, { type: 'array' });
                    
                    if (excelWorkbook.SheetNames.length === 0) {
                        showStatus('File Excel không có sheet nào!', 'error');
                        return;
                    }

                    if (excelWorkbook.SheetNames.length === 1) {
                        // Chỉ có 1 sheet, xử lý trực tiếp
                        updateFieldConfigVisibility(false);
                        selectedSheetNames = [excelWorkbook.SheetNames[0]];
                        processSelectedSheets();
                    } else {
                        // Có nhiều sheet, hiển thị để chọn
                        updateFieldConfigVisibility(true);
                        displaySheetSelector();
                    }

                } catch (error) {
                    console.error('Lỗi đọc file Excel:', error);
                    showStatus('Lỗi đọc file Excel. Vui lòng kiểm tra format file.', 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function updateFieldConfigVisibility(isMultipleSheets) {
            const configSection = document.querySelector('.sheet-field-config');
            const configNote = document.querySelector('.config-note');
            
            if (isMultipleSheets) {
                configSection.style.display = 'block';
                configNote.innerHTML = '💡 File Excel có nhiều sheet - tên sheet sẽ được lưu vào trường này';
                configNote.style.color = '#28a745';
            } else {
                configSection.style.display = 'block';
                configNote.innerHTML = '💡 File Excel chỉ có 1 sheet - trường này sẽ không được thêm vào dữ liệu';
                configNote.style.color = '#6c757d';
            }
        }

        function displaySheetSelector() {
            const sheetSelector = document.getElementById('sheetSelector');
            const sheetList = document.getElementById('sheetList');
            
            // Hide preview section if visible
            document.getElementById('previewSection').style.display = 'none';
            
            // Reset selected sheets
            selectedSheetNames = [];
            updateSelectedCount();
            
            // Create sheet items with checkboxes
            sheetList.innerHTML = excelWorkbook.SheetNames.map(sheetName => {
                const sheet = excelWorkbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                const rowCount = jsonData.length;
                const colCount = jsonData.length > 0 ? Math.max(...jsonData.map(row => row.length)) : 0;
                
                return `
                    <div class="sheet-item" onclick="toggleSheet('${sheetName}')">
                        <input type="checkbox" class="sheet-checkbox" id="checkbox_${sheetName}" onchange="toggleSheet('${sheetName}')">
                        <div class="sheet-name">${sheetName}</div>
                        <div class="sheet-info">${rowCount} dòng, ${colCount} cột</div>
                    </div>
                `;
            }).join('');

            sheetSelector.style.display = 'block';
            showStatus(`Tìm thấy ${excelWorkbook.SheetNames.length} sheet. Chọn một hoặc nhiều sheet để import.`, 'success');
        }

        function toggleSheet(sheetName) {
            const checkbox = document.getElementById(`checkbox_${sheetName}`);
            const sheetItem = checkbox.closest('.sheet-item');
            
            if (selectedSheetNames.includes(sheetName)) {
                // Remove from selection
                selectedSheetNames = selectedSheetNames.filter(name => name !== sheetName);
                checkbox.checked = false;
                sheetItem.classList.remove('checked');
            } else {
                // Add to selection
                selectedSheetNames.push(sheetName);
                checkbox.checked = true;
                sheetItem.classList.add('checked');
            }
            
            updateSelectedCount();
            document.getElementById('processSheetBtn').disabled = selectedSheetNames.length === 0;
        }

        function selectAllSheets() {
            selectedSheetNames = [...excelWorkbook.SheetNames];
            excelWorkbook.SheetNames.forEach(sheetName => {
                const checkbox = document.getElementById(`checkbox_${sheetName}`);
                const sheetItem = checkbox.closest('.sheet-item');
                checkbox.checked = true;
                sheetItem.classList.add('checked');
            });
            updateSelectedCount();
            document.getElementById('processSheetBtn').disabled = false;
            showStatus('Đã chọn tất cả sheet', 'success');
        }

        function selectNoSheets() {
            selectedSheetNames = [];
            excelWorkbook.SheetNames.forEach(sheetName => {
                const checkbox = document.getElementById(`checkbox_${sheetName}`);
                const sheetItem = checkbox.closest('.sheet-item');
                checkbox.checked = false;
                sheetItem.classList.remove('checked');
            });
            updateSelectedCount();
            document.getElementById('processSheetBtn').disabled = true;
            showStatus('Đã bỏ chọn tất cả sheet', 'error');
        }

        function updateSelectedCount() {
            const countElement = document.getElementById('selectedCount');
            countElement.textContent = `(${selectedSheetNames.length} sheet đã chọn)`;
        }

        function processSelectedSheets() {
            if (!selectedSheetNames.length || !excelWorkbook) {
                showStatus('Vui lòng chọn ít nhất một sheet để xử lý!', 'error');
                return;
            }

            showStatus(`Đang xử lý ${selectedSheetNames.length} sheet...`, 'success');
            
            // Merge data from all selected sheets
            mergeMultipleSheets();
        }

        function mergeMultipleSheets() {
            pendingImportData = [];
            let totalValidRows = 0;
            let totalInvalidRows = 0;
            let globalId = 1;
            
            // Kiểm tra xem có phải chỉ 1 sheet không
            const isMultipleSheets = excelWorkbook.SheetNames.length > 1;

            selectedSheetNames.forEach(sheetName => {
                const sheet = excelWorkbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                if (jsonData.length < 2) {
                    showStatus(`Sheet "${sheetName}" được bỏ qua (không có đủ dữ liệu)`, 'error');
                    return;
                }

                // Process each sheet's data - chỉ truyền sheetName khi có nhiều sheet
                const customFieldName = document.getElementById('sheetFieldName').value.trim() || 'Đơn vị quản lý học phần';
                const { validRows, invalidRows, sheetData } = processSheetData(jsonData, isMultipleSheets ? sheetName : null, globalId, customFieldName);
                
                // Merge into pending data
                pendingImportData = pendingImportData.concat(sheetData);
                
                totalValidRows += validRows;
                totalInvalidRows += invalidRows;
                globalId += sheetData.length;
            });

            if (pendingImportData.length === 0) {
                showStatus('Không có dữ liệu hợp lệ trong các sheet đã chọn!', 'error');
                return;
            }

            // Hide sheet selector
            document.getElementById('sheetSelector').style.display = 'none';

            if (isMultipleSheets) {
                showStatus(`Đã gộp ${selectedSheetNames.length} sheet: ${totalValidRows} dòng hợp lệ, ${totalInvalidRows} dòng bỏ qua`, 'success');
            } else {
                showStatus(`Đã xử lý: ${totalValidRows} dòng hợp lệ, ${totalInvalidRows} dòng bỏ qua`, 'success');
            }
            displayPreview();
        }

        function processSheetData(rawData, sheetName, startId, customFieldName) {
            // Get header row (row 0) - tên các cột từ Excel
            const headerRow = rawData[0];
            const dataRows = rawData.slice(1);
            const sheetData = [];

            if (!headerRow || headerRow.length === 0) {
                return { validRows: 0, invalidRows: dataRows.length, sheetData: [] };
            }

            let validRows = 0;
            let invalidRows = 0;

            dataRows.forEach((row, index) => {
                // Skip empty rows
                if (!row || row.length === 0 || row.every(cell => !cell)) {
                    invalidRows++;
                    return;
                }

                // Tạo object với tên field = tên header từ Excel
                const rowData = {
                    id: startId + validRows
                };
                
                // Chỉ thêm trường tùy chỉnh khi có nhiều sheet
                if (sheetName && customFieldName) {
                    rowData[customFieldName] = sheetName;
                }

                let hasValidData = false;
                headerRow.forEach((header, colIndex) => {
                    if (header && header.trim()) {
                        const fieldName = String(header).trim();
                        const cellValue = row[colIndex] ? String(row[colIndex]).trim() : '';
                        
                        // Xử lý đặc biệt cho field có thể là array (tags, keywords, etc.)
                        if (fieldName.toLowerCase().includes('tag') || 
                            fieldName.toLowerCase().includes('keyword') ||
                            fieldName.toLowerCase().includes('từ khóa')) {
                            rowData[fieldName] = cellValue ? cellValue.split(',').map(tag => tag.trim()) : [];
                        } else {
                            rowData[fieldName] = cellValue;
                        }
                        
                        if (cellValue) hasValidData = true;
                    }
                });

                if (hasValidData) {
                    sheetData.push(rowData);
                    validRows++;
                } else {
                    invalidRows++;
                }
            });

            return { validRows, invalidRows, sheetData };
        }



        function displayPreview() {
            const previewSection = document.getElementById('previewSection');
            const tableHead = document.getElementById('previewTableHead');
            const tableBody = document.getElementById('previewTableBody');

            if (pendingImportData.length === 0) return;

            // Tạo headers động từ fields trong data
            const firstItem = pendingImportData[0];
            const fields = Object.keys(firstItem).filter(key => key !== 'id');
            
            tableHead.innerHTML = `
                <tr>
                    ${fields.map(field => `<th>${field}</th>`).join('')}
                </tr>
            `;

            // Show max 10 rows for preview
            const previewData = pendingImportData.slice(0, 10);
            
            tableBody.innerHTML = previewData.map(item => {
                return `
                    <tr>
                        ${fields.map(field => {
                            const value = item[field];
                            if (Array.isArray(value)) {
                                // Hiển thị array như tags
                                return `<td>${value.map(tag => `<span style="background: #f0f0f0; padding: 1px 6px; border-radius: 8px; font-size: 10px; margin-right: 3px;">${tag}</span>`).join('')}</td>`;
                            } else {
                                // Hiển thị text thường, truncate nếu quá dài
                                const displayValue = String(value || '');
                                const truncated = displayValue.length > 50 ? displayValue.substring(0, 50) + '...' : displayValue;
                                return `<td>${truncated}</td>`;
                            }
                        }).join('')}
                    </tr>
                `;
            }).join('');

            if (pendingImportData.length > 10) {
                tableBody.innerHTML += `<tr><td colspan="${fields.length}" style="text-align: center; font-style: italic; color: #666;">... và ${pendingImportData.length - 10} dòng khác</td></tr>`;
            }

            previewSection.style.display = 'block';
        }

        function generateJSON() {
            if (pendingImportData.length === 0) {
                showStatus('Không có dữ liệu để tạo JSON!', 'error');
                return;
            }

            try {
                showStatus('Đang tạo file JSON...', 'success');

                // Assign proper IDs to all items
                pendingImportData.forEach((item, index) => {
                    item.id = index + 1;
                });

                // Create new JSON file content
                const newData = {
                    dictionary: pendingImportData
                };

                // Create and download JSON file
                const jsonString = JSON.stringify(newData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showStatus(`Tạo thành công file data.json với ${pendingImportData.length} từ khóa. File đã được tải xuống!`, 'success');
                
                // Clear import data after 3 seconds
                setTimeout(() => {
                    cancelImport();
                }, 3000);

            } catch (error) {
                console.error('Lỗi tạo JSON:', error);
                showStatus('Có lỗi xảy ra khi tạo file JSON!', 'error');
            }
        }



        function cancelImport() {
            pendingImportData = [];
            excelWorkbook = null;
            selectedSheetNames = [];
            
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('sheetSelector').style.display = 'none';
            document.getElementById('fileInput').value = '';
            document.getElementById('processSheetBtn').disabled = true;
            
            // Clear sheet selection
            document.querySelectorAll('.sheet-item').forEach(item => {
                item.classList.remove('checked');
            });
            document.querySelectorAll('.sheet-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            updateSelectedCount();
            showStatus('Đã hủy import', 'error');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';

            // Auto hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Drag and Drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                uploadArea.classList.add('drag-over');
            }

            function unhighlight(e) {
                uploadArea.classList.remove('drag-over');
            }

            uploadArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        processExcelFile(file);
                    } else {
                        showStatus('Vui lòng chọn file Excel (.xlsx hoặc .xls)', 'error');
                    }
                }
            }
        });

        // ============== PROGRAM BUILDER FUNCTIONS ==============
        
        // Update program counter in tab
        function updateProgramCounter() {
            const counter = document.getElementById('programCounter');
            const count = selectedProgram.length;
            counter.textContent = count;
            counter.className = count > 0 ? 'counter' : 'counter zero';
        }

        // Update program statistics
        function updateProgramStats() {
            ensureFieldDetection();
            
            const subjects = selectedProgram.length;
            let totalCredits = 0;
            const departments = new Set();
            
            selectedProgram.forEach(item => {
                // Calculate credits
                if (detectedCreditFieldName && item[detectedCreditFieldName]) {
                    const credits = parseInt(item[detectedCreditFieldName]) || 0;
                    totalCredits += credits;
                }
                
                // Track departments
                if (detectedSheetFieldName && item[detectedSheetFieldName]) {
                    departments.add(item[detectedSheetFieldName]);
                }
            });
            
            // Update display
            document.getElementById('totalSubjects').textContent = subjects;
            document.getElementById('totalCredits').textContent = totalCredits;
            document.getElementById('totalDepartments').textContent = departments.size;
            
            programStats = { subjects, credits: totalCredits, departments: departments.size };
        }

        // Add to program with dropdown selection
        function addToProgram(item, event) {
            ensureFieldDetection();
            
            // Check if item already exists
            const fields = Object.keys(dataStructure);
            const primaryField = fields[0];
            const secondaryField = fields[1];
            
            const isDuplicate = selectedProgram.some(programItem => 
                programItem[primaryField] === item[primaryField] && 
                programItem[secondaryField] === item[secondaryField]
            );
            
            if (isDuplicate) {
                alert('Học phần này đã có trong danh sách!');
                return;
            }
            
            // Show dropdown at button position
            showCategoryDropdown(item, event);
        }

        // Show compact category dropdown with smart positioning
        function showCategoryDropdown(item, event) {
            // Close any existing dropdown
            closeCategoryDropdown();
            
            const button = event.target;
            const rect = button.getBoundingClientRect();
            
            const dropdown = document.createElement('div');
            dropdown.id = 'categoryDropdown';
            
            // Calculate dropdown height (approximately 5 items * 45px per item)
            const dropdownHeight = 225; // 5 items × 45px per item
            const viewportHeight = window.innerHeight;
            const spaceBelow = viewportHeight - rect.bottom;
            const spaceAbove = rect.top;
            
            // Determine if dropdown should appear above or below the button
            let topPosition;
            if (spaceBelow >= dropdownHeight + 10) {
                // Enough space below - show dropdown below button
                topPosition = rect.bottom + 5;
            } else if (spaceAbove >= dropdownHeight + 10) {
                // Not enough space below but enough above - show dropdown above button
                topPosition = rect.top - dropdownHeight - 5;
            } else {
                // Limited space both directions - show above if more space, otherwise below
                topPosition = spaceAbove > spaceBelow ? 
                    Math.max(10, rect.top - dropdownHeight - 5) : 
                    rect.bottom + 5;
            }
            
            dropdown.style.cssText = `
                position: fixed;
                top: ${topPosition}px;
                left: ${rect.left}px;
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 8px 0;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                min-width: 200px;
                max-width: 250px;
                max-height: ${Math.min(dropdownHeight, Math.max(spaceAbove, spaceBelow) - 20)}px;
                overflow-y: auto;
            `;
            
            const categories = [
                { name: 'HP đại cương', icon: '🏛️', color: '#1976d2' },
                { name: 'HP cơ sở ngành', icon: '🏗️', color: '#2e7d32' },
                { name: 'HP ngành', icon: '🎯', color: '#f57c00' },
                { name: 'HP chuyên ngành', icon: '🔬', color: '#c2185b' },
                { name: 'HP thực tập/tốt nghiệp', icon: '🎓', color: '#7b1fa2' }
            ];
            
            categories.forEach((category, index) => {
                const option = document.createElement('div');
                option.style.cssText = `
                    padding: 10px 15px;
                    cursor: pointer;
                    font-size: 13px;
                    color: ${category.color};
                    font-weight: 600;
                    border-bottom: ${index < categories.length - 1 ? '1px solid #f0f0f0' : 'none'};
                    transition: background 0.2s;
                `;
                option.innerHTML = `${category.icon} ${category.name}`;
                
                option.onmouseover = function() {
                    this.style.background = '#f8f9fa';
                };
                option.onmouseout = function() {
                    this.style.background = 'white';
                };
                
                option.onclick = function() {
                    addToProgramWithCategory(item, category.name);
                    closeCategoryDropdown();
                };
                
                dropdown.appendChild(option);
            });
            
            document.body.appendChild(dropdown);
            
            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeCategoryDropdown);
            }, 100);
        }

        // Close category dropdown
        function closeCategoryDropdown() {
            const dropdown = document.getElementById('categoryDropdown');
            if (dropdown) {
                document.body.removeChild(dropdown);
                document.removeEventListener('click', closeCategoryDropdown);
            }
        }

        // Add item to program with specific category
        function addToProgramWithCategory(item, category) {
            // Add category to item
            const itemWithCategory = { ...item, __category: category };
            
            // Add to program
            selectedProgram.push(itemWithCategory);
            
            // Save to localStorage
            localStorage.setItem('selectedProgram', JSON.stringify(selectedProgram));
            
            // Update UI
            updateProgramCounter();
            updateProgramStats();
            renderProgramList();
            
            // Refresh current results to update button states
            refreshCurrentView();
            
            // Show success feedback
            ensureFieldDetection();
            const fields = Object.keys(dataStructure);
            const primaryField = fields[0];
            showStatus(`Đã thêm "${item[primaryField]}" vào danh sách (${category})!`, 'success');
        }

        // Remove item from program
        function removeFromProgram(item) {
            ensureFieldDetection();
            
            const fields = Object.keys(dataStructure);
            const primaryField = fields[0];
            const secondaryField = fields[1];
            
            const index = selectedProgram.findIndex(programItem => 
                programItem[primaryField] === item[primaryField] && 
                programItem[secondaryField] === item[secondaryField]
            );
            
            if (index > -1) {
                selectedProgram.splice(index, 1);
                
                // Save to localStorage
                localStorage.setItem('selectedProgram', JSON.stringify(selectedProgram));
                
                // Update UI
                updateProgramCounter();
                updateProgramStats();
                renderProgramList();
                
                // Refresh current results to update button states
                refreshCurrentView();
                
                // Show success feedback
                showStatus(`Đã xóa "${item[primaryField]}" khỏi danh sách!`, 'success');
            }
        }

        // Refresh current view to update button states
        function refreshCurrentView() {
            const activeTab = document.querySelector('.tab-button.active');
            let activeTabId = 'search'; // Default to search tab
            
            if (activeTab) {
                const onclickAttr = activeTab.getAttribute('onclick');
                if (onclickAttr) {
                    const match = onclickAttr.match(/'([^']+)'/);
                    if (match) {
                        activeTabId = match[1];
                    }
                }
            }
            
            // Check current search state and refresh accordingly
            if (activeTabId === 'search') {
                const searchInput = document.getElementById('searchInput');
                const selectedDepartment = document.getElementById('departmentFilter');
                const selectedCredit = document.getElementById('creditFilter');
                
                if (searchInput && selectedDepartment && selectedCredit) {
                    if (searchInput.value.trim() || selectedDepartment.value !== 'all' || selectedCredit.value !== 'all') {
                        // There are active filters, refresh filtered results
                        performSearch();
                    } else {
                        // No filters, show all data
                        displayAllData();
                    }
                } else {
                    // Fallback: try to display all data if elements exist
                    if (dictionaryData && dictionaryData.length > 0) {
                        displayAllData();
                    }
                }
            } else if (activeTabId === 'program') {
                // Refresh program list
                renderProgramList();
            }
        }

        // Clear entire program
        function clearProgram() {
            if (selectedProgram.length === 0) return;
            
            if (confirm('Bạn có chắc muốn xóa tất cả học phần đã chọn?')) {
                selectedProgram = [];
                
                // Save to localStorage
                localStorage.setItem('selectedProgram', JSON.stringify(selectedProgram));
                
                updateProgramCounter();
                updateProgramStats();
                renderProgramList();
                
                // Refresh current results to update button states
                refreshCurrentView();
                
                showStatus('Đã xóa tất cả học phần khỏi danh sách!', 'success');
            }
        }

        // Export program with multiple format options
        function exportProgram() {
            if (selectedProgram.length === 0) {
                alert('Chưa có học phần nào để xuất!');
                return;
            }
            
            // Show export options modal
            showExportModal();
        }

        // Show export modal with format options
        function showExportModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <h3 style="margin: 0 0 20px 0; color: #333; text-align: center;">📤 Xuất danh sách chương trình</h3>
                    <p style="color: #666; text-align: center; margin-bottom: 25px;">Chọn định dạng xuất cho ${selectedProgram.length} học phần đã chọn</p>
                    
                    <div style="display: grid; gap: 12px;">
                        <button onclick="exportAsText(); closeExportModal()" style="padding: 15px; border: 2px solid #2196f3; background: #f8fbff; color: #2196f3; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 600;" onmouseover="this.style.background='#2196f3'; this.style.color='white'" onmouseout="this.style.background='#f8fbff'; this.style.color='#2196f3'">
                            📄 Xuất dạng Text (.txt) - Danh sách đơn giản
                        </button>
                        
                        <button onclick="exportAsCSV(); closeExportModal()" style="padding: 15px; border: 2px solid #4caf50; background: #f8fff8; color: #4caf50; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 600;" onmouseover="this.style.background='#4caf50'; this.style.color='white'" onmouseout="this.style.background='#f8fff8'; this.style.color='#4caf50'">
                            📊 Xuất dạng CSV (.csv) - Import vào Excel
                        </button>
                        
                        <button onclick="exportAsJSON(); closeExportModal()" style="padding: 15px; border: 2px solid #ff9800; background: #fffdf8; color: #ff9800; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 600;" onmouseover="this.style.background='#ff9800'; this.style.color='white'" onmouseout="this.style.background='#fffdf8'; this.style.color='#ff9800'">
                            🔧 Xuất dạng JSON (.json) - Dữ liệu kỹ thuật
                        </button>
                        
                        <button onclick="exportAsFormatted(); closeExportModal()" style="padding: 15px; border: 2px solid #9c27b0; background: #fdfaff; color: #9c27b0; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 600;" onmouseover="this.style.background='#9c27b0'; this.style.color='white'" onmouseout="this.style.background='#fdfaff'; this.style.color='#9c27b0'">
                            📋 Xuất dạng Formatted - Báo cáo chi tiết
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button onclick="closeExportModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; color: #666;">
                            Hủy
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentExportModal = modal;
        }

        // Close export modal
        function closeExportModal() {
            if (window.currentExportModal) {
                document.body.removeChild(window.currentExportModal);
                window.currentExportModal = null;
            }
        }

        // Export as simple text format
        function exportAsText() {
            ensureFieldDetection();
            const fields = Object.keys(dataStructure);
            const primaryField = fields[0];
            const secondaryField = fields[1];
            
            let content = `CHƯƠNG TRÌNH ĐÀO TẠO\n`;
            content += `Ngày xuất: ${new Date().toLocaleDateString('vi-VN')}\n`;
            content += `Tổng số học phần: ${selectedProgram.length}\n`;
            content += `Tổng số tín chỉ: ${programStats.credits}\n`;
            content += `Số đơn vị quản lý: ${programStats.departments}\n`;
            content += `${'='.repeat(60)}\n\n`;
            
            selectedProgram.forEach((item, index) => {
                content += `${index + 1}. ${item[primaryField]}\n`;
                if (item[secondaryField] && secondaryField !== primaryField) {
                    content += `   ${item[secondaryField]}\n`;
                }
                if (detectedCreditFieldName && item[detectedCreditFieldName]) {
                    content += `   Số tín chỉ: ${item[detectedCreditFieldName]}\n`;
                }
                if (detectedSheetFieldName && item[detectedSheetFieldName]) {
                    content += `   Đơn vị quản lý: ${item[detectedSheetFieldName]}\n`;
                }
                content += `\n`;
            });
            
            downloadFile(content, 'chuong-trinh-dao-tao.txt', 'text/plain');
        }

        // Export as CSV format
        function exportAsCSV() {
            ensureFieldDetection();
            const fields = Object.keys(dataStructure);
            
            // CSV Headers
            const headers = fields.map(field => dataStructure[field].displayName);
            let csvContent = headers.join(',') + '\n';
            
            // CSV Rows
            selectedProgram.forEach(item => {
                const row = fields.map(field => {
                    const value = item[field] || '';
                    // Escape quotes and wrap in quotes if contains comma
                    const escaped = String(value).replace(/"/g, '""');
                    return escaped.includes(',') ? `"${escaped}"` : escaped;
                });
                csvContent += row.join(',') + '\n';
            });
            
            downloadFile(csvContent, 'chuong-trinh-dao-tao.csv', 'text/csv');
        }

        // Export as JSON format
        function exportAsJSON() {
            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    totalSubjects: selectedProgram.length,
                    totalCredits: programStats.credits,
                    totalDepartments: programStats.departments,
                    dataStructure: dataStructure
                },
                program: selectedProgram
            };
            
            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadFile(jsonContent, 'chuong-trinh-dao-tao.json', 'application/json');
        }

        // Export as formatted report
        function exportAsFormatted() {
            ensureFieldDetection();
            const fields = Object.keys(dataStructure);
            const primaryField = fields[0];
            const secondaryField = fields[1];
            
            let content = `<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chương trình Đào tạo</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 40px; line-height: 1.6; }
        .header { text-align: center; margin-bottom: 40px; border-bottom: 3px solid #2196f3; padding-bottom: 20px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
        .stat-card { background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; border-left: 4px solid #2196f3; }
        .subject { margin: 20px 0; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background: white; }
        .subject-title { font-size: 18px; font-weight: bold; color: #2196f3; margin-bottom: 10px; }
        .subject-subtitle { color: #666; margin-bottom: 15px; }
        .badges { margin: 10px 0; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; margin: 2px 5px 2px 0; }
        .credit-badge { background: #ff9800; color: white; }
        .dept-badge { background: #28a745; color: white; }
        .details { margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0; }
        .detail-row { margin: 5px 0; }
        .detail-label { font-weight: 600; color: #555; }
        @media print { body { margin: 20px; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>📚 CHƯƠNG TRÌNH ĐÀO TẠO</h1>
        <p>Ngày xuất: ${new Date().toLocaleDateString('vi-VN')} • Hệ thống Quản lý Học phần</p>
    </div>
    
    <div class="stats">
        <div class="stat-card">
            <h3>📊 Tổng số học phần</h3>
            <div style="font-size: 24px; font-weight: bold; color: #2196f3;">${selectedProgram.length}</div>
        </div>
        <div class="stat-card">
            <h3>🎯 Tổng số tín chỉ</h3>
            <div style="font-size: 24px; font-weight: bold; color: #ff9800;">${programStats.credits}</div>
        </div>
        <div class="stat-card">
            <h3>🏢 Số đơn vị</h3>
            <div style="font-size: 24px; font-weight: bold; color: #28a745;">${programStats.departments}</div>
        </div>
    </div>
    
    <h2>📋 Danh sách học phần chi tiết</h2>
`;

            selectedProgram.forEach((item, index) => {
                content += `
    <div class="subject">
        <div class="subject-title">${index + 1}. ${item[primaryField]}</div>`;
                
                if (item[secondaryField] && secondaryField !== primaryField) {
                    content += `<div class="subject-subtitle">${item[secondaryField]}</div>`;
                }
                
                content += `<div class="badges">`;
                if (detectedCreditFieldName && item[detectedCreditFieldName]) {
                    content += `<span class="badge credit-badge">📊 ${item[detectedCreditFieldName]} TC</span>`;
                }
                if (detectedSheetFieldName && item[detectedSheetFieldName]) {
                    content += `<span class="badge dept-badge">📁 ${item[detectedSheetFieldName]}</span>`;
                }
                content += `</div>`;
                
                // Other fields
                const fieldsToSkip = ['STT', 'Số thứ tự', 'Đơn vị quản lý', 'Quản lý', 'id'];
                const otherFields = fields.filter(field => 
                    !fieldsToSkip.includes(field) && field !== detectedSheetFieldName && field !== detectedCreditFieldName
                );
                
                if (otherFields.length > 0) {
                    content += `<div class="details">`;
                    otherFields.forEach(fieldName => {
                        const value = item[fieldName];
                        const fieldDisplay = dataStructure[fieldName].displayName;
                        
                        if (value) {
                            content += `<div class="detail-row">`;
                            content += `<span class="detail-label">${fieldDisplay}:</span> `;
                            
                            if (Array.isArray(value)) {
                                content += value.join(', ');
                            } else {
                                content += String(value);
                            }
                            
                            content += `</div>`;
                        }
                    });
                    content += `</div>`;
                }
                
                content += `</div>`;
            });
            
            content += `
<` + `/body>
<` + `/html>`;
            
            downloadFile(content, 'chuong-trinh-dao-tao.html', 'text/html');
        }

        // Download file helper function
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType + ';charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showStatus(`Đã tải xuống file: ${filename}`, 'success');
            } else {
                alert('Trình duyệt không hỗ trợ tải xuống file tự động!');
            }
        }

        // Render program list
        function renderProgramList() {
            const programList = document.getElementById('programList');
            
            if (selectedProgram.length === 0) {
                programList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📝</div>
                        <h3>Chưa có học phần nào</h3>
                        <p>Vào tab "Tìm Kiếm" để thêm học phần vào chương trình đào tạo</p>
                    </div>
                `;
                return;
            }
            
            ensureFieldDetection();
            
            // Detect field names
            let maHPField = null;
            let tenVietField = null;
            let tenAnhField = null;
            let creditField = detectedCreditFieldName;
            let departmentField = detectedSheetFieldName;
            
            // Auto-detect field names from data
            if (selectedProgram.length > 0) {
                const sampleItem = selectedProgram[0];
                const fieldNames = Object.keys(sampleItem);
                
                maHPField = fieldNames.find(field => 
                    field.toLowerCase().includes('mã') && field.toLowerCase().includes('hp')
                ) || fieldNames.find(field => 
                    field.toLowerCase().includes('code')
                );
                
                tenVietField = fieldNames.find(field => 
                    field.toLowerCase().includes('tên') && field.toLowerCase().includes('việt')
                ) || fieldNames.find(field => 
                    field.toLowerCase().includes('vietnamese') || field.toLowerCase().includes('name')
                );
                
                tenAnhField = fieldNames.find(field => 
                    field.toLowerCase().includes('tên') && field.toLowerCase().includes('anh')
                ) || fieldNames.find(field => 
                    field.toLowerCase().includes('english')
                );
            }
            
            // Group items by category for display
            const categories = {
                'HP đại cương': { items: [], icon: '🏛️', color: '#1976d2', bgColor: '#e3f2fd' },
                'HP cơ sở ngành': { items: [], icon: '🏗️', color: '#2e7d32', bgColor: '#e8f5e8' },
                'HP ngành': { items: [], icon: '🎯', color: '#f57c00', bgColor: '#fff3e0' },
                'HP chuyên ngành': { items: [], icon: '🔬', color: '#c2185b', bgColor: '#fce4ec' },
                'HP thực tập/tốt nghiệp': { items: [], icon: '🎓', color: '#7b1fa2', bgColor: '#f3e5f5' }
            };
            
            // Group items by their category
            selectedProgram.forEach(item => {
                const category = item.__category || 'HP đại cương';
                if (categories[category]) {
                    categories[category].items.push(item);
                }
            });
            
            let programHTML = `
                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                    <h3 style="color: #2196f3; margin: 0 0 5px 0;">📋 Chương trình đào tạo đã chọn</h3>
                    <p style="color: #666; margin: 0; font-size: 14px;">Tổng cộng ${selectedProgram.length} học phần</p>
                </div>
            `;
            
            // Render each category as a table
            Object.keys(categories).forEach(categoryName => {
                const category = categories[categoryName];
                const categoryItems = category.items;
                
                if (categoryItems.length > 0) {
                    // Category header
                    programHTML += `
                        <div style="background: ${category.bgColor}; border-left: 4px solid ${category.color}; padding: 15px; margin: 20px 0 10px 0; border-radius: 8px;">
                            <h4 style="margin: 0; color: ${category.color}; font-size: 16px; font-weight: bold;">
                                ${category.icon} ${categoryName} 
                                <span style="font-size: 14px; font-weight: normal; opacity: 0.8;">(${categoryItems.length} học phần)</span>
                            </h4>
                        </div>
                    `;
                    
                    // Table for this category
                    programHTML += `
                        <div style="margin: 0 0 30px 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                        <th style="padding: 12px 8px; text-align: center; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6; width: 50px;">STT</th>
                                        <th style="padding: 12px 10px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6; width: 100px;">Mã HP</th>
                                        <th style="padding: 12px 10px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6; min-width: 200px;">Tên tiếng Việt</th>
                                        <th style="padding: 12px 10px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6; min-width: 180px;">Tên tiếng Anh</th>
                                        <th style="padding: 12px 8px; text-align: center; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6; width: 70px;">Số TC</th>
                                        <th style="padding: 12px 10px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6; width: 120px;">Đơn vị quản lý</th>
                                        <th style="padding: 12px 8px; text-align: center; font-weight: 600; color: #495057; width: 60px;">Xóa</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    // Table rows for items in this category
                    categoryItems.forEach((item, index) => {
                        const stt = index + 1;
                        const maHP = item[maHPField] || '';
                        const tenViet = item[tenVietField] || '';
                        const tenAnh = item[tenAnhField] || '';
                        const soTC = item[creditField] || '';
                        const donVi = item[departmentField] || '';
                        
                        programHTML += `
                            <tr style="border-bottom: 1px solid #dee2e6; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
                                <td style="padding: 10px 8px; text-align: center; border-right: 1px solid #dee2e6; color: #6c757d; font-weight: 500;">${stt}</td>
                                <td style="padding: 10px; border-right: 1px solid #dee2e6; color: #495057; font-weight: 500;">${maHP}</td>
                                <td style="padding: 10px; border-right: 1px solid #dee2e6; color: #212529; font-weight: 500;">${tenViet}</td>
                                <td style="padding: 10px; border-right: 1px solid #dee2e6; color: #6c757d;">${tenAnh}</td>
                                <td style="padding: 10px 8px; text-align: center; border-right: 1px solid #dee2e6; color: #495057; font-weight: 600;">${soTC}</td>
                                <td style="padding: 10px; border-right: 1px solid #dee2e6; color: #6c757d; font-size: 12px;">${donVi}</td>
                                <td style="padding: 10px 8px; text-align: center;">
                                    <button onclick="removeFromProgram(${JSON.stringify(item).replace(/"/g, '&quot;')})" 
                                            style="background: #dc3545; color: white; border: none; padding: 4px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; transition: all 0.2s; min-width: 35px;" 
                                            onmouseover="this.style.background='#c82333'" 
                                            onmouseout="this.style.background='#dc3545'" 
                                            title="Xóa khỏi danh sách">✕</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    programHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            });
            
            programList.innerHTML = programHTML;
        }

        // Initialize application
        function initializeApp() {
            // Load saved program from localStorage
            const savedProgram = localStorage.getItem('selectedProgram');
            if (savedProgram) {
                try {
                    selectedProgram = JSON.parse(savedProgram);
                    updateProgramCounter();
                    updateProgramStats();
                    renderProgramList();
                } catch (e) {
                    console.error('Error loading saved program:', e);
                    selectedProgram = [];
                }
            }
            
            // Load saved login state from localStorage
            const savedLoginState = localStorage.getItem('isLoggedIn');
            if (savedLoginState === 'true') {
                isLoggedIn = true;
                updateUIForLoginState();
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

    </script>
</body>
</html>


