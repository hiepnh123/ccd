<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chương trình đào tạo - DNU</title>
    
    <!-- Favicon using emoji -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>☀️</text></svg>">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            height: 100vh; /* Full viewport height */
            overflow: hidden; /* Prevent body scroll */
        }

        /* Header Styles */
        .main-header {
            background: linear-gradient(135deg, #2196F3 0%, #4CAF50 100%);
            color: white;
            padding: 30px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            width: 100%;
            box-sizing: border-box;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-text {
            text-align: center;
            flex: 1;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .main-title {
            font-size: 2.5em;
            font-weight: bold;
            margin: 0 0 10px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
        }

        .sub-title {
            font-size: 1.1em;
            margin: 0;
            opacity: 0.9;
            font-weight: 300;
            font-style: italic;
        }

        .login-btn, .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .login-btn:hover, .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .main-container {
            padding: 0;
            margin: 140px 0 0 0; /* Only top margin, remove any bottom margin */
            height: calc(100vh - 140px); /* Full remaining height */
            overflow: hidden; /* Ensure no overflow creates gaps */
        }

        /* Login Modal */
        .login-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
            margin: 0 0 10px 0;
        }

        .password-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 15px 0;
            outline: none;
            transition: border-color 0.3s;
        }

        .password-input:focus {
            border-color: #4CAF50;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-submit-btn {
            background: #4CAF50;
            color: white;
        }

        .login-submit-btn:hover {
            background: #45a049;
        }

        .cancel-btn {
            background: #f44336;
            color: white;
        }

        .cancel-btn:hover {
            background: #d32f2f;
        }

        .error-message {
            color: #f44336;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        /* Tab Navigation */
        .tab-container {
            max-width: 1200px;
            margin: 0 auto;
            position: fixed;
            top: 140px; /* Below fixed header */
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            width: calc(100% - 40px); /* Account for padding */
            max-width: 1200px;
        }

        /* Hidden state for non-logged in users */
        .tab-container.not-logged-in .tab-nav {
            background: white;
            border-radius: 0px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            justify-content: center;
            align-items: center;
        }

        .tab-container.not-logged-in .tab-button {
            display: none !important;
        }

        .default-message {
            display: none;
            color: #666;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            padding: 15px 20px;
        }

        .tab-container.not-logged-in .default-message {
            display: block;
        }

        .tab-nav {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.1s ease-out;
            border-right: 1px solid #ddd;
            user-select: none;
        }

        .tab-button:last-child {
            border-right: none;
        }

        .tab-button.active {
            background: #4CAF50;
            color: white;
        }

        .tab-button:hover:not(.active) {
            background: #e9ecef;
            color: #333;
        }

        /* Counter badge in tab */
        .counter {
            background: #ff4757;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 5px;
            min-width: 18px;
            text-align: center;
            display: inline-block;
        }

        .counter.zero {
            background: #ddd;
            color: #999;
        }

        /* Program Tab Styles */
        .program-section {
            padding: 30px;
            height: calc(100vh - 200px); /* Fixed height to enable scrolling */
            max-height: calc(100vh - 200px);
            overflow-y: auto; /* Always show scrollbar when needed */
            overflow-x: hidden;
        }

        .program-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .program-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .program-header p {
            color: #666;
            font-size: 14px;
        }

        .program-stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .program-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .action-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn.primary {
            background: #ff4757;
            color: white;
        }

        .action-btn.primary:hover {
            background: #ff3742;
            transform: translateY(-2px);
        }

        .action-btn.secondary {
            background: #2ed573;
            color: white;
        }

        .action-btn.secondary:hover {
            background: #26d065;
            transform: translateY(-2px);
        }

        .action-btn.tertiary {
            background: #fff;
            color: #4CAF50;
            border: 2px solid #4CAF50;
        }

        .action-btn.tertiary:hover {
            background: #4CAF50;
            color: white;
            transform: translateY(-2px);
        }

        .action-btn.tertiary {
            background: #fff;
            color: #4CAF50;
            border: 2px solid #4CAF50;
        }

        .action-btn.tertiary:hover {
            background: #4CAF50;
            color: white;
            transform: translateY(-2px);
        }

        .program-list {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            min-height: 300px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .empty-state p {
            font-size: 14px;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 0;
            box-shadow: none;
            height: calc(100% - 120px);
            overflow: hidden;
            margin: 0; /* Remove any margin */
            padding: 0; /* Remove any padding */
            opacity: 0;
            transition: opacity 0.15s ease-in-out;
        }

        .tab-content.active {
            display: block;
            opacity: 1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 20px 10px 20px;
            height: calc(100vh - 190px); /* Reduce height offset to get closer to bottom */
            max-height: calc(100vh - 190px);
            overflow-y: auto; /* Always show scrollbar when needed */
            overflow-x: hidden;
            display: flex;
            gap: 20px;
            align-items: stretch;
        }

        /* Phần tìm kiếm */
.search-section {
    flex: none;
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    height: fit-content;
    align-self: flex-start;
}

        .search-section h2 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .search-container {
            position: relative;
            width: 100%;
        }

        .search-bar {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 25px;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-bar:focus {
            border-color: #4CAF50;
        }

        .search-button {
            width: 100%;
            margin-top: 15px;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .search-button:hover {
            background-color: #45a049;
        }

        /* Dropdown gợi ý */
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.2s ease;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover,
        .suggestion-item.highlighted {
            background-color: #f8f9fa;
            border-left: 3px solid #4CAF50;
            padding-left: 13px;
        }

        .suggestion-word {
            font-weight: 600;
            color: #2196F3;
            font-size: 14px;
        }

        .suggestion-category {
            font-size: 11px;
            color: #666;
            background: #e3f2fd;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
            display: inline-block;
            font-weight: 500;
        }

        .suggestion-description {
            font-size: 11px;
            color: #777;
            margin-top: 6px;
            line-height: 1.4;
        }

        .suggestion-description div {
            margin-top: 3px;
        }

        /* Styles for clickable department elements */
        .department-clickable {
            position: relative;
        }

        .department-clickable::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px;
            padding: 1px;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: exclude;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .department-clickable:hover::after {
            opacity: 1;
        }

        .highlight {
            background-color: #ffeb3b;
            font-weight: bold;
        }

        /* Import Tab Styles */
        .import-section {
            padding: 30px;
            height: calc(100vh - 200px); /* Fixed height to enable scrolling */
            max-height: calc(100vh - 200px);
            overflow-y: auto; /* Always show scrollbar when needed */
            overflow-x: hidden;
        }

        .import-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .import-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .import-header p {
            color: #666;
            font-size: 14px;
        }

        .upload-area {
            border: 2px dashed #4CAF50;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            background: #f9f9f9;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #f0f8ff;
            border-color: #2196F3;
        }

        .upload-area.drag-over {
            background: #e8f5e8;
            border-color: #4CAF50;
        }

        .upload-icon {
            font-size: 48px;
            color: #4CAF50;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: background-color 0.3s;
        }

        .upload-btn:hover {
            background: #45a049;
        }

        .preview-section {
            margin-top: 20px;
            display: none;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .preview-table th,
        .preview-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .preview-table tr:hover {
            background: #f8f9fa;
        }

        /* Checkbox styles for required/elective column */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        /* Column Configuration Modal Styles */
        .column-config-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }

        .column-config-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .column-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #ddd;
            cursor: move;
            transition: all 0.3s;
            user-select: none;
        }

        .column-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .column-item.dragging {
            opacity: 0.5;
            background: #fff3cd;
        }

        .column-item.drag-over {
            border-left-color: #007bff;
            background: #e3f2fd;
        }

        .column-checkbox {
            margin-right: 15px;
            transform: scale(1.2);
        }

        .column-label {
            flex: 1;
            font-weight: 500;
            color: #333;
        }

        .drag-handle {
            color: #666;
            font-size: 16px;
            margin-left: 10px;
            cursor: move;
        }

        .column-list {
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .config-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            gap: 10px;
        }

        .config-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }

        .config-btn.primary {
            background: #007bff;
            color: white;
        }

        .config-btn.primary:hover {
            background: #0056b3;
        }

        .config-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .config-btn.secondary:hover {
            background: #545b62;
        }

        .config-btn.reset {
            background: #dc3545;
            color: white;
        }

        .config-btn.reset:hover {
            background: #c82333;
        }

        .requirement-checkbox {
            width: 18px;
            height: 18px;
            margin: 0;
            cursor: pointer;
        }

        .requirement-label {
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            user-select: none;
            color: #495057;
            padding: 2px 6px;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .requirement-label.required {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #bbdefb;
        }

        .requirement-label.elective {
            background: #f3e5f5;
            color: #7b1fa2;
            border: 1px solid #e1bee7;
        }

        .import-actions {
            margin-top: 20px;
            text-align: center;
        }

        .import-final-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 10px;
            transition: background-color 0.3s;
        }

        .import-final-btn:hover {
            background: #1976D2;
        }

        .cancel-btn {
            background: #f44336;
        }

        .cancel-btn:hover {
            background: #d32f2f;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .format-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .format-info h4 {
            color: #1976D2;
            margin-bottom: 10px;
        }

        .format-info ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .format-info li {
            margin: 5px 0;
            color: #555;
        }

        /* Sheet Field Configuration Styles */
        .sheet-field-config {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #ffeaa7;
            display: none; /* Ẩn ban đầu */
        }

        .sheet-field-config h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .config-item {
            margin-bottom: 15px;
        }

        .config-item label {
            display: block;
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
        }

        .sheet-field-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .sheet-field-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .config-note {
            margin-top: 8px;
            font-size: 13px;
            color: #6c757d;
            font-style: italic;
        }

        /* Sheet Selector Styles */
        .sheet-selector {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: none;
        }

        .sheet-selector h4 {
            color: #495057;
            margin-bottom: 15px;
        }

        .sheet-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .sheet-item {
            padding: 12px 16px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .sheet-item:hover {
            border-color: #4CAF50;
            background: #f8fff8;
        }

        .sheet-item.selected {
            border-color: #4CAF50;
            background: #4CAF50;
            color: white;
        }

        .sheet-item .sheet-name {
            font-weight: 600;
            font-size: 14px;
        }

        .sheet-item .sheet-info {
            font-size: 11px;
            opacity: 0.8;
            margin-top: 4px;
        }

        .sheet-actions {
            text-align: center;
        }

        .process-sheet-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .process-sheet-btn:hover {
            background: #1976D2;
        }

        .process-sheet-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Multi-select styles */
        .sheet-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 18px;
            height: 18px;
            accent-color: #4CAF50;
        }

        .sheet-item {
            position: relative;
            padding-left: 35px;
        }

        .sheet-item.checked {
            border-color: #4CAF50;
            background: #f8fff8;
        }

        .multi-select-controls {
            margin-bottom: 15px;
            text-align: center;
        }

        .select-all-btn, .select-none-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            margin: 0 5px;
            transition: background-color 0.3s;
        }

        .select-all-btn:hover {
            background: #5a6268;
        }

        .select-none-btn:hover {
            background: #5a6268;
        }

        .selected-count {
            color: #4CAF50;
            font-weight: 600;
            margin-top: 10px;
        }

       /* Phần hiển thị kết quả */
.results-section {
    flex: 1;
    background: white;
    padding: 30px 30px 20px 30px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow-y: auto;
    height: 100%;
    display: flex;
    flex-direction: column;
    margin-bottom: 0;
}

        .results-section h2 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        #resultsContainer {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 5px;
        }

        /* Custom scrollbar styling for better visibility */
        #resultsContainer::-webkit-scrollbar {
            width: 12px;
        }

        #resultsContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        #resultsContainer::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 6px;
        }

        #resultsContainer::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .no-results {
            text-align: center;
            color: #666;
            font-style: italic;
            margin-top: 50px;
        }

        .result-item {
            padding: 15px;
            margin-bottom: 10px; /* Reduced from 15px to minimize spacing */
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #fafafa;
            transition: background-color 0.3s;
        }
        
        /* Remove margin from last result item to eliminate bottom gap */
        .result-item:last-child {
            margin-bottom: 0;
        }



        .result-item:hover {
            background-color: #f0f0f0;
        }

        .result-title {
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 5px;
        }

        .result-description {
            color: #666;
            line-height: 1.4;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-title {
                font-size: 1.8em;
            }
            
            .sub-title {
                font-size: 1em;
            }
            
            .main-header {
                padding: 20px 15px;
            }
            
            .container {
                flex-direction: column;
                height: auto;
            }
            
            .search-section, .results-section {
                flex: none;
            }
        }

        /* Settings Styles */
        .settings-section {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            height: calc(100vh - 200px); /* Fixed height to enable scrolling */
            max-height: calc(100vh - 200px);
            overflow-y: auto; /* Always show scrollbar when needed */
            overflow-x: hidden;
        }

        .settings-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }

        .settings-header h2 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }

        .settings-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 16px;
        }

        .display-config {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .display-config h3 {
            color: #333;
            margin: 0 0 25px 0;
            font-size: 24px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .config-group {
            margin-bottom: 35px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .config-group h4 {
            color: #495057;
            margin: 0 0 8px 0;
            font-size: 18px;
        }

        .config-desc {
            color: #6c757d;
            margin: 0 0 15px 0;
            font-size: 14px;
            font-style: italic;
        }

        .field-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: border-color 0.3s;
        }

        .field-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .badge-config {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .checkbox-label:hover {
            background: #e3f2fd;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        .fields-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .fields-order-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            min-height: 200px;
            border: 2px dashed #dee2e6;
        }

        .field-order-item {
            background: #667eea;
            color: white;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: move;
            user-select: none;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .field-order-item:hover {
            transform: translateX(5px);
            background: #5a6fd8;
        }

        .field-order-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .drag-handle {
            font-size: 16px;
        }

        .settings-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .settings-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 180px;
        }

        .settings-btn.primary {
            background: #28a745;
            color: white;
        }

        .settings-btn.primary:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .settings-btn.secondary {
            background: #ffc107;
            color: #212529;
        }

        .settings-btn.secondary:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .settings-btn.info {
            background: #17a2b8;
            color: white;
        }

        .settings-btn.info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .settings-status {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-status.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .settings-status.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .settings-status.info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .settings-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .settings-btn {
                width: 100%;
                max-width: 300px;
            }
            
            .fields-container {
                grid-template-columns: 1fr;
            }
        }

        /* Badge spacing optimization */
        .clickable-badge {
            margin-right: 4px !important;
            margin-bottom: 2px;
        }
    </style>
</head>
<body>
    <!-- Main Header -->
    <div class="main-header">
        <div class="header-content">
            <div class="header-text">
                <h1 class="main-title">TRANG TRA CỨU HỌC PHẦN</h1>
                <p class="sub-title">Trung tâm phát triển CTĐT - Đại học Đại Nam</p>
            </div>
            <div class="header-actions">
                <button id="loginBtn" class="login-btn" onclick="openLoginModal()">
                    🔐 Login
                </button>
                <button id="logoutBtn" class="logout-btn" onclick="logout()" style="display: none;">
                    🚪 Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Tab Navigation -->
        <div class="tab-container" id="tabContainer">
        <div class="tab-nav">
            <div class="default-message" id="defaultMessage">
                📚 Liên hệ ccd@dainam.edu.vn nếu cần tư vấn thêm
            </div>
            <button class="tab-button active" onclick="switchTab('search')" id="searchTabBtn">
                🔍 Tìm Kiếm
            </button>
            <button class="tab-button" onclick="switchTab('program')" id="programTabBtn">
                📋 Chương trình đào tạo <span id="programCounter" class="counter">0</span>
            </button>
            <button class="tab-button" onclick="switchTab('import')" id="importTabBtn" style="display: none;">
                📁 Tạo Database
            </button>
            <button class="tab-button" onclick="switchTab('settings')" id="settingsTabBtn" style="display: none;">
                ⚙️ Cài đặt Hiển thị
            </button>
        </div>

        <!-- Tab 1: Tìm kiếm -->
        <div id="searchTab" class="tab-content active">
            <div class="container">
                <!-- Phần tìm kiếm -->
                <div class="search-section">
                    <h2>🔍 Tìm Kiếm Học Phần</h2>
                    <div class="search-container">
                        <input type="text" id="searchInput" class="search-bar" placeholder="Nhập từ khóa tìm kiếm..." autocomplete="off">
                        <div id="suggestionsDropdown" class="suggestions-dropdown"></div>
                    </div>
                    <button onclick="performSearch()" class="search-button">Tìm Kiếm</button>
                </div>

                <!-- Phần hiển thị kết quả -->
                <div class="results-section">
                    <h2>📊 Kết Quả Tìm Kiếm</h2>
                    <div id="resultsContainer">
                        <div class="no-results">
                            Đang tải dữ liệu...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Program Builder -->
        <div id="programTab" class="tab-content">
            <div class="program-section">
                <div class="program-header">
                    <h2>📋 Chương trình đào tạo</h2>
                    <p>Tập hợp các học phần để xây dựng chương trình đào tạo hoàn chỉnh</p>
                </div>
                
                <div class="program-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalSubjects">0</div>
                        <div class="stat-label">Học phần</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalCredits">0</div>
                        <div class="stat-label">Tín chỉ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalDepartments">0</div>
                        <div class="stat-label">Đơn vị</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="electiveRatio">0%</div>
                        <div class="stat-label">Tự chọn/Bắt buộc</div>
                    </div>
                </div>
                
                <div class="program-actions">
                    <button class="action-btn primary" onclick="clearProgram()">
                        🗑️ Xóa tất cả
                    </button>
                    <button class="action-btn secondary" onclick="exportProgram()">
                        📤 Xuất danh sách
                    </button>
                    <button class="action-btn tertiary" onclick="showColumnConfigModal()">
                        ⚙️ Cấu hình cột
                    </button>
                </div>
                
                <div class="program-list" id="programList">
                    <div class="empty-state">
                        <div class="empty-icon">📝</div>
                        <h3>Chưa có học phần nào</h3>
                        <p>Vào tab "Tìm Kiếm" để thêm học phần vào chương trình đào tạo</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Import Excel -->
        <div id="importTab" class="tab-content">
            <div class="import-section">
                <div class="import-header">
                    <h2>� Tạo Database JSON Từ Excel</h2>
                    <p>Upload file Excel (.xlsx) để tạo file data.json mới cho việc upload lên host</p>
                </div>

                <!-- Upload Area -->
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">📁</div>
                    <h3>Kéo thả file Excel vào đây</h3>
                    <p>hoặc</p>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        Chọn File Excel
                    </button>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
                    <p style="margin-top: 15px; color: #666; font-size: 12px;">Hỗ trợ: .xlsx, .xls (tối đa 10MB)</p>
                </div>

                <!-- Status Messages -->
                <div id="statusMessage" class="status-message"></div>

                <!-- Sheet Selector -->
                <div id="sheetSelector" class="sheet-selector">
                    <h4>📊 Chọn Sheet để Import: <span class="selected-count" id="selectedCount">(0 sheet đã chọn)</span></h4>
                    
                    <div class="multi-select-controls">
                        <button class="select-all-btn" onclick="selectAllSheets()">✅ Chọn Tất Cả</button>
                        <button class="select-none-btn" onclick="selectNoSheets()">❌ Bỏ Chọn Tất Cả</button>
                    </div>
                    
                    <div id="sheetList" class="sheet-list"></div>
                    <div class="sheet-actions">
                        <button id="processSheetBtn" class="process-sheet-btn" onclick="processSelectedSheets()" disabled>
                            ✅ Xử Lý Sheet Đã Chọn
                        </button>
                    </div>
                </div>

                <!-- Sheet Field Name Configuration -->
                <div class="sheet-field-config">
                    <h4>🏷️ Cấu hình tên trường từ Sheet:</h4>
                    <div class="config-item">
                        <label for="sheetFieldName">Tên trường lấy từ tên Sheet (chỉ áp dụng khi file có nhiều sheet):</label>
                        <input type="text" id="sheetFieldName" class="sheet-field-input" 
                               value="Đơn vị quản lý học phần" 
                               placeholder="Nhập tên trường mong muốn...">
                        <p class="config-note">💡 Khi file Excel có nhiều sheet, giá trị tên sheet sẽ được lưu vào trường này</p>
                    </div>
                </div>

                <!-- Format Info -->
                <div class="format-info">
                    <h4>📋 Định dạng file Excel:</h4>
                    <ul>
                        <li><strong>Dòng đầu tiên:</strong> Tên các cột (STT, Mã HP, Tên Tiếng Việt, Tên Tiếng Anh, v.v.)</li>
                        <li><strong>Các dòng tiếp theo:</strong> Dữ liệu tương ứng với từng cột</li>
                        <li><strong>Tự động phát hiện:</strong> Hệ thống sẽ sử dụng tên header làm tên trường hiển thị</li>
                        <li><strong>Tags/Keywords:</strong> Nếu tên cột chứa "tag" hoặc "keyword", sẽ tự động xử lý như danh sách</li>
                    </ul>
                    <p style="margin-top: 10px; color: #666;"><strong>Ví dụ:</strong> STT | Mã HP | Tên Tiếng Việt | Tên Tiếng Anh</p>
                </div>

                <!-- Preview Section -->
                <div id="previewSection" class="preview-section">
                    <h3>🔍 Preview Dữ Liệu:</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <table id="previewTable" class="preview-table">
                            <thead id="previewTableHead">
                                <!-- Headers sẽ được tạo động từ Excel -->
                            </thead>
                            <tbody id="previewTableBody"></tbody>
                        </table>
                    </div>
                    
                    <div class="import-actions">
                        <button class="import-final-btn" onclick="generateJSON()">
                            💾 Tải File data.json
                        </button>
                        <button class="import-final-btn cancel-btn" onclick="cancelImport()">
                            ❌ Hủy
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 4: Display Settings -->
        <div id="settingsTab" class="tab-content">
            <div class="settings-section">
                <div class="settings-header">
                    <h2>⚙️ Cài đặt Hiển thị</h2>
                    <p>Cấu hình cách hiển thị các trường dữ liệu trong kết quả tìm kiếm</p>
                </div>

                <!-- Display Configuration -->
                <div class="display-config">
                    <h3>📋 Cấu hình Hiển thị Trường</h3>
                    
                    <!-- Primary Field Setting -->
                    <div class="config-group">
                        <h4>🏆 Trường chính (Title)</h4>
                        <p class="config-desc">Trường hiển thị làm tiêu đề chính của mỗi kết quả</p>
                        <select id="primaryFieldSelect" class="field-select">
                            <option value="">Chọn trường chính...</option>
                        </select>
                    </div>

                    <!-- Secondary Field Setting -->
                    <div class="config-group">
                        <h4>🥈 Trường phụ (Subtitle)</h4>
                        <p class="config-desc">Trường hiển thị bên cạnh tiêu đề chính</p>
                        <select id="secondaryFieldSelect" class="field-select">
                            <option value="">Chọn trường phụ...</option>
                        </select>
                    </div>

                    <!-- Badge Fields Settings -->
                    <div class="config-group">
                        <h4>🏷️ Các Badge Hiển thị</h4>
                        <p class="config-desc">Các trường hiển thị dưới dạng badge có thể click</p>
                        
                        <div class="badge-config" id="dynamicBadgeConfig">
                            <!-- Dynamic badge checkboxes will be generated here -->
                        </div>
                    </div>

                    <!-- Fields to Hide Settings -->
                    <div class="config-group">
                        <h4>🙈 Các Trường Ẩn</h4>
                        <p class="config-desc">Chọn các trường không muốn hiển thị trong phần chi tiết</p>
                        <div id="fieldsToHideContainer" class="fields-container">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>

                    <!-- Fields Display Order -->
                    <div class="config-group">
                        <h4>🔄 Thứ tự Hiển thị Trường</h4>
                        <p class="config-desc">Kéo thả để sắp xếp thứ tự hiển thị các trường</p>
                        <div id="fieldsOrderContainer" class="fields-order-container">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Settings Actions -->
                <div class="settings-actions">
                    <button class="settings-btn primary" onclick="saveDisplaySettings()">
                        💾 Lưu Cài đặt
                    </button>
                    <button class="settings-btn secondary" onclick="resetDisplaySettings()">
                        ♾️ Khôi phục Mặc định
                    </button>
                    <button class="settings-btn info" onclick="previewDisplaySettings()">
                        👁️ Xem trước
                    </button>
                </div>

                <!-- Settings Status -->
                <div id="settingsStatus" class="settings-status"></div>
            </div>
        </div>
    </div>
    <!-- End Main Container -->

    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🔐 Đăng Nhập Hệ Thống</h2>
                <p style="color: #666; font-size: 14px;">Nhập mật khẩu để truy cập hệ thống</p>
            </div>
            <div class="modal-body">
                <input type="password" id="passwordInput" class="password-input" placeholder="Nhập mật khẩu..." maxlength="50">
                <div id="errorMessage" class="error-message">Mật khẩu không đúng!</div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn login-submit-btn" onclick="attemptLogin()">🔓 Đăng Nhập</button>
                <button class="modal-btn cancel-btn" onclick="closeLoginModal()">❌ Hủy</button>
            </div>
        </div>
    </div>

    <script>
        let dictionaryData = [];
        let currentHighlightIndex = -1;
        let pendingImportData = [];
        let dataStructure = {}; // Store dynamic field structure
        let excelWorkbook = null; // Store loaded Excel workbook
        let selectedSheetNames = []; // Store multiple selected sheet names
        let isLoggedIn = false; // Authentication state
        let userRole = null; // 'user' or 'admin'
        const ADMIN_PASSWORD = "absg123"; // Admin password
        const USER_PASSWORD = "dnu123"; // User password
        let detectedSheetFieldName = null; // Trường được phát hiện tự động chứa thông tin sheet
        let detectedCreditFieldName = null; // Trường được phát hiện tự động chứa thông tin số tín chỉ
        
        // Program Builder variables
        let selectedProgram = []; // Array to store selected subjects
        let programStats = { subjects: 0, credits: 0, departments: 0 }; // Program statistics

        // Display Settings variables
        let displayConfig = {
            primaryField: 'Tên tiếng Việt',
            secondaryField: 'Mã HP', 
            badgeFields: [], // Dynamic list of fields to show as badges
            badgeOrder: [], // Order of badge fields for display
            fieldsToHide: ['STT', 'Số thứ tự', 'Đơn vị quản lý', 'Quản lý', 'id'],
            fieldsOrder: [] // Will be populated from dataStructure
        };
        
        const DEFAULT_CONFIG = {
            primaryField: 'Tên tiếng Việt',
            secondaryField: 'Mã HP',
            badgeFields: [], // Will be auto-populated based on data
            badgeOrder: [], // Will be auto-populated based on data
            fieldsToHide: ['STT', 'Số thứ tự', 'Đơn vị quản lý', 'Quản lý', 'id'],
            fieldsOrder: []
        };

        // Helper function to escape HTML attributes
        function escapeHtml(text) {
            return String(text).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        // Helper function to ensure field detection is done
        function ensureFieldDetection() {
            if (!detectedCreditFieldName) {
                detectCreditFieldName();
            }
            if (!detectedSheetFieldName) {
                detectSheetFieldName();
            }
            
            // If dataStructure is empty but we have selectedProgram data, build basic structure
            if (Object.keys(dataStructure).length === 0 && selectedProgram.length > 0) {
                const firstItem = selectedProgram[0];
                Object.keys(firstItem).forEach(key => {
                    dataStructure[key] = {
                        displayName: key,
                        type: Array.isArray(firstItem[key]) ? 'array' : 'string'
                    };
                });
            }
        }

        // Function to auto-detect credit field name
        function detectCreditFieldName() {
            // Use dictionaryData first, fallback to selectedProgram
            let dataSource = dictionaryData;
            if (!dataSource || dataSource.length === 0) {
                if (selectedProgram && selectedProgram.length > 0) {
                    dataSource = selectedProgram;
                } else {
                    detectedCreditFieldName = null;
                    return null;
                }
            }

            const firstItem = dataSource[0];
            const allFields = Object.keys(firstItem).filter(key => key !== 'id');
            
            // Tìm field có tên gợi ý về tín chỉ
            const possibleNames = [
                'Số TC', 'Số tín chỉ', 'Tín chỉ', 'TC', 'Credit', 'Credits', 'ECTS'
            ];
            
            for (let fieldName of allFields) {
                if (possibleNames.some(name => fieldName.toLowerCase().includes(name.toLowerCase()))) {
                    detectedCreditFieldName = fieldName;
                    console.log('Detected credit field by name:', fieldName);
                    return fieldName;
                }
            }
            
            // Nếu không tìm thấy dựa trên tên, tìm field có giá trị số nhỏ (thường là 1-6 tín chỉ)
            for (let fieldName of allFields) {
                const fieldValues = dataSource.map(item => item[fieldName]).filter(val => val != null);
                const uniqueValues = [...new Set(fieldValues)];
                
                // Kiểm tra xem field này có phải chứa số tín chỉ không
                const allNumbers = uniqueValues.every(val => {
                    const num = Number(val);
                    return !isNaN(num) && num > 0 && num <= 10; // Tín chỉ thường từ 1-10
                });
                
                if (allNumbers && uniqueValues.length <= 8) { // Không quá nhiều unique values
                    detectedCreditFieldName = fieldName;
                    console.log('Detected credit field by pattern:', fieldName, 'with values:', uniqueValues);
                    return fieldName;
                }
            }
            
            detectedCreditFieldName = null;
            console.log('No credit field detected');
            return null;
        }

        // Function to auto-detect sheet field name
        function detectSheetFieldName() {
            // Use dictionaryData first, fallback to selectedProgram
            let dataSource = dictionaryData;
            if (!dataSource || dataSource.length === 0) {
                if (selectedProgram && selectedProgram.length > 0) {
                    dataSource = selectedProgram;
                } else {
                    detectedSheetFieldName = null;
                    return null;
                }
            }

            // Lấy item đầu tiên để phân tích
            const firstItem = dataSource[0];
            const allFields = Object.keys(firstItem).filter(key => key !== 'id');
            
            // Tìm field có tên gợi ý về đơn vị/khoa/sheet
            const possibleNames = [
                'Đơn vị quản lý học phần', 'Quản lý', 'Khoa', 'Phòng ban', 'Bộ môn', 'Đơn vị', 
                'Department', 'Faculty', 'Unit', 'Division', 'Sheet', 'Thằng chó con ngựa'
            ];
            
            for (let fieldName of allFields) {
                // Kiểm tra xem có phải field chứa thông tin đơn vị không
                if (possibleNames.some(name => fieldName.toLowerCase().includes(name.toLowerCase()))) {
                    detectedSheetFieldName = fieldName;
                    console.log('Detected sheet field by name:', fieldName);
                    return fieldName;
                }
            }
            
            // Nếu không tìm thấy dựa trên tên, thử tìm field có values giống tên sheet
            // (để dự phòng cho trường hợp tên field được đặt tùy chỉnh)
            // Detect credit field để exclude nó khỏi sheet field detection
            const creditField = detectCreditFieldName();
            
            for (let fieldName of allFields) {
                // Skip credit field và các field có patterns không phải sheet field
                if (fieldName === creditField) continue;
                
                // Skip fields có patterns của ID, code, tên course
                if (fieldName.toLowerCase().includes('stt') || 
                    fieldName.toLowerCase().includes('mã') ||
                    fieldName.toLowerCase().includes('tên') ||
                    fieldName.toLowerCase().includes('name') ||
                    fieldName.toLowerCase().includes('title') ||
                    fieldName.toLowerCase().includes('code')) {
                    continue;
                }
                
                const fieldValues = dataSource.map(item => item[fieldName]).filter(val => val);
                const uniqueValues = [...new Set(fieldValues)];
                
                // Nếu field này có ít unique values và tất cả values đều là string ngắn
                // thì có thể đây là field chứa thông tin sheet/đơn vị
                if (uniqueValues.length <= 10 && uniqueValues.length > 0) {
                    const allShortStrings = uniqueValues.every(val => 
                        typeof val === 'string' && val.length < 100 && val.length > 0
                    );
                    if (allShortStrings) {
                        detectedSheetFieldName = fieldName;
                        console.log('Detected sheet field by pattern:', fieldName, 'with values:', uniqueValues);
                        return fieldName;
                    }
                }
            }
            
            detectedSheetFieldName = null;
            return null;
        }



        // Function to display filtered results
        function displayFilteredResults(results, fieldName, fieldValue) {
            ensureFieldDetection();
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <h3>😔 Không tìm thấy kết quả</h3>
                        <p>Không có học phần nào có <strong>${fieldName}</strong> là "<strong>${fieldValue}</strong>"</p>
                    </div>
                `;
                return;
            }

            const totalItems = results.length;
            let filteredHTML = `
                <div style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; color: white;">
                    <h3 style="margin: 0 0 8px 0; font-size: 18px;">🔍 ${fieldName}: ${fieldValue}</h3>
                    <p style="margin: 0; font-size: 14px; opacity: 0.9;">Tổng cộng: <strong>${totalItems}</strong> học phần</p>
                </div>
            `;

            // Hiển thị từng item
            filteredHTML += results.map(item => {
                const fields = getOrderedFields();
                let resultHTML = '<div class="result-item">';
                
                // Hiển thị trường theo cài đặt display config
                const primaryField = getPrimaryField();
                const primaryValue = item[primaryField];
                const secondaryField = getSecondaryField();
                const secondaryValue = item[secondaryField];
                
                resultHTML += `<div class="result-title" style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">${String(primaryValue)}`;
                if (secondaryValue && secondaryField !== primaryField) {
                    resultHTML += ` <span style="font-size: 14px; color: #666; font-weight: bold;">- ${secondaryValue}</span>`;
                }
                resultHTML += `</div>`;
                
                // Section cho các badges quan trọng và nút thêm - sử dụng justify-between để tách badge và nút
                resultHTML += `<div style="margin: 10px 0; display: flex; justify-content: space-between; align-items: center; gap: 8px;">`;
                
                // Container cho các badge (bên trái)
                resultHTML += `<div style="display: flex; gap: 4px; align-items: center; flex-wrap: wrap;">`;
                
                // Badge trường được filter (hiển thị với màu xanh da trời)
                if (item[fieldName]) {
                    resultHTML += `<span style="background: #007bff; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 600; display: inline-block;">🔍 ${fieldName}: ${item[fieldName]}</span>`;
                }
                
                // Badge Credit (nếu có và khác với trường đang filter)
                const creditField = detectCreditFieldName();
                if (creditField && item[creditField] && fieldName !== creditField) {
                    resultHTML += `<span class="clickable-badge credit-badge" data-field="${escapeHtml(creditField)}" data-value="${escapeHtml(item[creditField])}" style="background: #ff9800; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-block;" onmouseover="this.style.background='#f57f17'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#ff9800'; this.style.transform='scale(1)'" title="Click để lọc theo ${creditField}: ${item[creditField]}">📊 ${item[creditField]} TC</span>`;
                }
                
                // Badge Đơn vị quản lý (nếu có và khác với trường đang filter)
                const departmentField = 'Quản lý';
                if (item[departmentField] && fieldName !== departmentField) {
                    resultHTML += `<span class="clickable-badge department-badge" data-field="${escapeHtml(departmentField)}" data-value="${escapeHtml(item[departmentField])}" style="background: #28a745; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-block;" onmouseover="this.style.background='#20c997'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#28a745'; this.style.transform='scale(1)'" title="Click để xem tất cả học phần của đơn vị này">📁 ${item[departmentField]}</span>`;
                }
                
                resultHTML += `</div>`; // Đóng container badge
                
                // Add to program button (bên phải) - sử dụng helper function
                resultHTML += renderAddToProgramButton(item, primaryField, secondaryField);
                
                resultHTML += `</div>`; // Đóng main flex container
                
                // Hiển thị các trường khác (theo cài đặt displayConfig)
                fields.forEach(fieldDisplayName => {
                    // Skip các field theo cấu hình displayConfig và field đang được filter
                    if (!shouldShowField(fieldDisplayName) || fieldDisplayName === fieldName) return;
                    
                    const value = item[fieldDisplayName];
                    const fieldDisplay = dataStructure[fieldDisplayName].displayName;
                    
                    if (value) {
                        if (Array.isArray(value)) {
                            // Hiển thị array (tags) - chỉ hiển thị, không có link
                            resultHTML += `<div style="margin-top: 12px;">`;
                            resultHTML += `<span style="font-size: 13px; color: #666; font-weight: 600;">${fieldDisplay}: </span>`;
                            resultHTML += value.map(tag => 
                                `<span style="background: #e3f2fd; padding: 3px 8px; border-radius: 12px; font-size: 12px; margin-right: 6px; color: #1976d2; display: inline-block; margin-top: 2px;">${tag}</span>`
                            ).join('');
                            resultHTML += `</div>`;
                        } else {
                            // Hiển thị text thường - chỉ hiển thị, không có link
                            resultHTML += `<div style="margin-top: 10px; font-size: 14px; line-height: 1.4;">`;
                            resultHTML += `<span style="color: #666; font-weight: 600;">${fieldDisplay}:</span> `;
                            resultHTML += `<span style="color: #333;">${String(value)}</span>`;
                            resultHTML += `</div>`;
                        }
                    }
                });

                // Button đã được thêm vào cùng hàng với badge ở trên

                resultHTML += '</div>';
                return resultHTML;
            }).join('');

            resultsContainer.innerHTML = filteredHTML;
        }

        // Authentication functions
        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
            document.getElementById('passwordInput').focus();
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('passwordInput').value = '';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function attemptLogin() {
            const password = document.getElementById('passwordInput').value;
            const errorMsg = document.getElementById('errorMessage');
            
            if (password === ADMIN_PASSWORD) {
                isLoggedIn = true;
                userRole = 'admin';
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('userRole', 'admin');
                closeLoginModal();
                updateUIForLoginState();
                showStatus('Đăng nhập thành công! Chào mừng Admin.', 'success');
            } else if (password === USER_PASSWORD) {
                isLoggedIn = true;
                userRole = 'user';
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('userRole', 'user');
                closeLoginModal();
                updateUIForLoginState();
                showStatus('Đăng nhập thành công! Chào mừng User.', 'success');
            } else {
                errorMsg.style.display = 'block';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }

        function logout() {
            const currentRole = userRole;
            isLoggedIn = false;
            userRole = null;
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('userRole');
            updateUIForLoginState();
            // Switch back to search tab
            switchTab('search');
            showStatus(`Đã đăng xuất khỏi chế độ ${currentRole === 'admin' ? 'Admin' : 'User'}.`, 'error');
        }

        function updateUIForLoginState() {
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const importTabBtn = document.getElementById('importTabBtn');
            const settingsTabBtn = document.getElementById('settingsTabBtn');
            const programTabBtn = document.getElementById('programTabBtn');
            const tabContainer = document.getElementById('tabContainer');
            const searchTabBtn = document.getElementById('searchTabBtn');
            
            if (isLoggedIn) {
                // Show user/admin controls
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                tabContainer.classList.remove('not-logged-in');
                
                // Update logout button text based on role
                if (userRole === 'admin') {
                    logoutBtn.innerHTML = '🚪 Logout (Admin)';
                } else if (userRole === 'user') {
                    logoutBtn.innerHTML = '🚪 Logout (User)';
                }
                
                // Show tab text
                searchTabBtn.style.color = '';
                programTabBtn.style.color = '';
                
                if (userRole === 'admin') {
                    // Admin: Show all tabs
                    importTabBtn.style.display = 'block';
                    settingsTabBtn.style.display = 'block';
                    importTabBtn.style.color = '';
                    settingsTabBtn.style.color = '';
                    
                    // Populate settings UI when admin logs in
                    if (Object.keys(dataStructure).length > 0) {
                        populateSettingsUI();
                    }
                } else if (userRole === 'user') {
                    // User: Hide admin-only tabs
                    importTabBtn.style.display = 'none';
                    settingsTabBtn.style.display = 'none';
                }
            } else {
                // Not logged in: Hide all privileged controls
                loginBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                logoutBtn.innerHTML = '🚪 Logout'; // Reset to default
                importTabBtn.style.display = 'none';
                settingsTabBtn.style.display = 'none';
                tabContainer.classList.add('not-logged-in');
                
                // Show Program tab publicly (always visible)
                programTabBtn.style.display = 'block';
                
                // Show tab text for search and program tabs
                searchTabBtn.style.color = 'transparent';
                programTabBtn.style.color = ''; // Keep program tab text visible
            }
            
            // Cập nhật lại tất cả các nút "Thêm vào danh sách" sau khi thay đổi trạng thái đăng nhập
            refreshAddToListButtons();
        }

        // Hàm để cập nhật lại tất cả các nút "Thêm vào danh sách"
        function refreshAddToListButtons() {
            // Refresh lại kết quả tìm kiếm hiện tại để cập nhật trạng thái nút
            const searchInput = document.getElementById('searchInput');
            if (searchInput && searchInput.value.trim()) {
                // Nếu có từ khóa tìm kiếm, thực hiện lại tìm kiếm
                performSearch();
            } else {
                // Nếu không có từ khóa, hiển thị lại tất cả dữ liệu
                displayAllData();
            }
        }

        // Cache DOM elements for better performance
        let tabElements = null;
        let buttonElements = null;
        
        function initTabCache() {
            if (!tabElements) {
                tabElements = {
                    search: document.getElementById('searchTab'),
                    program: document.getElementById('programTab'),
                    import: document.getElementById('importTab'),
                    settings: document.getElementById('settingsTab')
                };
                buttonElements = {
                    search: document.getElementById('searchTabBtn'),
                    program: document.getElementById('programTabBtn'),
                    import: document.getElementById('importTabBtn'),
                    settings: document.getElementById('settingsTabBtn')
                };
            }
        }

        // Optimized tab switching with role-based access control
        function switchTab(tabName) {
            // Check if trying to access admin-only tabs
            if ((tabName === 'import' || tabName === 'settings')) {
                if (!isLoggedIn) {
                    openLoginModal();
                    return;
                } else if (userRole !== 'admin') {
                    showStatus('⚠️ Chỉ có Admin mới có thể truy cập tab này!', 'error');
                    return;
                }
            }
            
            // Initialize cache if needed
            initTabCache();
            
            // Immediately update UI for responsiveness
            // Hide all tabs and buttons
            Object.values(tabElements).forEach(tab => {
                if (tab) tab.classList.remove('active');
            });
            Object.values(buttonElements).forEach(btn => {
                if (btn) btn.classList.remove('active');
            });

            // Show selected tab and button immediately
            if (tabElements[tabName]) {
                tabElements[tabName].classList.add('active');
            }
            if (buttonElements[tabName]) {
                buttonElements[tabName].classList.add('active');
            }
            
            // Defer heavy operations using requestAnimationFrame for smooth UI
            requestAnimationFrame(() => {
                if (tabName === 'search') {
                    // Only refresh if search has been used before
                    if (document.getElementById('searchInput').value.trim() || 
                        document.getElementById('resultsContainer').innerHTML.trim()) {
                        refreshCurrentView();
                    }
                } else if (tabName === 'program') {
                    // Only render if program has items
                    if (selectedProgram && selectedProgram.length > 0) {
                        renderProgramList();
                    }
                } else if (tabName === 'settings') {
                    // Only populate if data structure exists
                    if (Object.keys(dataStructure).length > 0) {
                        populateSettingsUI();
                    }
                }
            });
        }

        // Password input enter key support
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    attemptLogin();
                }
            });
            
            // Close modal when clicking outside
            document.getElementById('loginModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeLoginModal();
                }
            });
            
            // Initialize tab cache for better performance
            initTabCache();
            
            // Restore login state from localStorage
            const savedLoginState = localStorage.getItem('isLoggedIn');
            const savedUserRole = localStorage.getItem('userRole');
            if (savedLoginState === 'true' && savedUserRole) {
                isLoggedIn = true;
                userRole = savedUserRole;
            }
            
            // Initialize UI state
            updateUIForLoginState();
        });



        // Analyze JSON structure to get dynamic fields
        function analyzeDataStructure(data) {
            if (!data || !Array.isArray(data) || data.length === 0) {
                return {};
            }

            const structure = {};
            const firstItem = data[0];
            
            // Define desired field order - "Tên tiếng Việt" first, then others
            const fieldOrder = ['Tên tiếng Việt', 'Mã HP'];
            const allKeys = Object.keys(firstItem).filter(key => key !== 'id');
            
            // Add prioritized fields first
            fieldOrder.forEach(key => {
                if (allKeys.includes(key)) {
                    const value = firstItem[key];
                    structure[key] = {
                        type: Array.isArray(value) ? 'array' : typeof value,
                        displayName: formatFieldName(key),
                        searchable: true
                    };
                }
            });
            
            // Add remaining fields
            allKeys.forEach(key => {
                if (!fieldOrder.includes(key)) {
                    const value = firstItem[key];
                    structure[key] = {
                        type: Array.isArray(value) ? 'array' : typeof value,
                        displayName: formatFieldName(key),
                        searchable: true
                    };
                }
            });

            return structure;
        }

        // Analyze JSON structure with display config
        function analyzeDataStructureWithConfig(data) {
            if (!data || !Array.isArray(data) || data.length === 0) {
                return {};
            }

            const structure = {};
            const firstItem = data[0];
            
            // Use display config field order if available
            const fieldOrder = displayConfig.fieldsOrder.length > 0 
                ? displayConfig.fieldsOrder 
                : [displayConfig.primaryField, displayConfig.secondaryField];
            
            const allKeys = Object.keys(firstItem).filter(key => key !== 'id');
            
            // Add prioritized fields first
            fieldOrder.forEach(key => {
                if (allKeys.includes(key)) {
                    const value = firstItem[key];
                    structure[key] = {
                        type: Array.isArray(value) ? 'array' : typeof value,
                        displayName: formatFieldName(key),
                        searchable: true
                    };
                }
            });
            
            // Add remaining fields
            allKeys.forEach(key => {
                if (!fieldOrder.includes(key)) {
                    const value = firstItem[key];
                    structure[key] = {
                        type: Array.isArray(value) ? 'array' : typeof value,
                        displayName: formatFieldName(key),
                        searchable: true
                    };
                }
            });

            return structure;
        }

        // Format field names for display - sử dụng tên trường gốc
        function formatFieldName(fieldName) {
            // Không dùng mapping nữa, trả về tên trường gốc
            // Chỉ format chữ cái đầu thành hoa
            return fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
        }

        // Function to remove Vietnamese diacritics for fuzzy search
        function removeDiacritics(str) {
            return str.normalize('NFD')
                     .replace(/[\u0300-\u036f]/g, '') // Loại bỏ dấu
                     .replace(/đ/g, 'd').replace(/Đ/g, 'D'); // Chuyển đ thành d
        }

        // Display Settings Functions
        async function loadDisplaySettings() {
            try {
                const response = await fetch('display-config.json');
                if (response.ok) {
                    const config = await response.json();
                    displayConfig = { ...DEFAULT_CONFIG, ...config };
                    
                    // Ensure badgeFields and badgeOrder are arrays
                    if (!Array.isArray(displayConfig.badgeFields)) {
                        displayConfig.badgeFields = [];
                    }
                    if (!Array.isArray(displayConfig.badgeOrder)) {
                        displayConfig.badgeOrder = [];
                    }
                    
                    console.log('Display settings loaded:', displayConfig);
                } else {
                    console.log('No display config found, using defaults');
                    displayConfig = { ...DEFAULT_CONFIG };
                }
            } catch (error) {
                console.log('Error loading display config:', error);
                displayConfig = { ...DEFAULT_CONFIG };
            }
        }

        async function saveDisplaySettings() {
            try {
                const configData = {
                    primaryField: displayConfig.primaryField,
                    secondaryField: displayConfig.secondaryField,
                    showCreditBadge: displayConfig.showCreditBadge,
                    showDepartmentBadge: displayConfig.showDepartmentBadge,
                    fieldsToHide: displayConfig.fieldsToHide,
                    fieldsOrder: displayConfig.fieldsOrder,
                    badgeFields: displayConfig.badgeFields || [],
                    badgeOrder: displayConfig.badgeOrder || [],
                    lastUpdated: new Date().toISOString()
                };

                // Create a downloadable JSON file
                const blob = new Blob([JSON.stringify(configData, null, 2)], { 
                    type: 'application/json' 
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'display-config.json';
                a.click();
                URL.revokeObjectURL(url);

                showSettingsStatus('✅ Cài đặt đã được lưu! Tải file display-config.json và upload lên host cùng với các file khác.', 'success');
                
                // Also update current session
                updateDisplayConfigFromUI();
                refreshCurrentView();
                
            } catch (error) {
                console.error('Error saving display settings:', error);
                showSettingsStatus('❌ Lỗi khi lưu cài đặt: ' + error.message, 'error');
            }
        }

        function updateDisplayConfigFromUI() {
            displayConfig.primaryField = document.getElementById('primaryFieldSelect').value;
            displayConfig.secondaryField = document.getElementById('secondaryFieldSelect').value;
            
            // Update badge fields and order from sortable list
            displayConfig.badgeFields = [];
            displayConfig.badgeOrder = [];
            
            const badgeOrderItems = document.querySelectorAll('#badgeOrderContainer .badge-order-item');
            badgeOrderItems.forEach(item => {
                const fieldName = item.dataset.field;
                const checkbox = item.querySelector('input[type="checkbox"]');
                
                displayConfig.badgeOrder.push(fieldName);
                if (checkbox && checkbox.checked) {
                    displayConfig.badgeFields.push(fieldName);
                }
            });
            
            // Update fields to hide
            const hideCheckboxes = document.querySelectorAll('#fieldsToHideContainer input[type="checkbox"]');
            displayConfig.fieldsToHide = [];
            hideCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    displayConfig.fieldsToHide.push(checkbox.value);
                }
            });

            // Update fields order
            const orderItems = document.querySelectorAll('#fieldsOrderContainer .field-order-item');
            displayConfig.fieldsOrder = Array.from(orderItems).map(item => item.dataset.field);
        }

        // Generate dynamic badge checkboxes based on available fields
        function generateBadgeCheckboxes() {
            const container = document.getElementById('dynamicBadgeConfig');
            if (!container || !dictionaryData || dictionaryData.length === 0) return;
            
            // Get all available fields from the first data item
            const sampleItem = dictionaryData[0];
            const fields = Object.keys(sampleItem).filter(field => field !== 'id');
            
            // Auto-select default badge fields if not configured yet
            if (!displayConfig.badgeFields || displayConfig.badgeFields.length === 0) {
                // Try to find common credit and department fields
                const creditFields = fields.filter(f => f.toLowerCase().includes('tc') || f.toLowerCase().includes('tín chỉ') || f.toLowerCase().includes('credit'));
                const deptFields = fields.filter(f => f.toLowerCase().includes('quản lý') || f.toLowerCase().includes('đơn vị') || f.toLowerCase().includes('khoa'));
                displayConfig.badgeFields = [...creditFields, ...deptFields];
            }
            
            // Initialize badge order if not exists
            if (!displayConfig.badgeOrder || displayConfig.badgeOrder.length === 0) {
                displayConfig.badgeOrder = [...fields];
            }
            
            // Clear existing content and create sortable container
            container.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h5 style="margin: 0 0 10px 0; color: #666;">🎯 Chọn và sắp xếp thứ tự badges:</h5>
                    <p style="font-size: 12px; color: #999; margin: 0 0 10px 0;">Kéo thả để thay đổi thứ tự hiển thị</p>
                    <div id="badgeOrderContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 8px;">
                        <!-- Sortable badge items will be added here -->
                    </div>
                </div>
            `;
            
            const orderContainer = document.getElementById('badgeOrderContainer');
            
            // Create sortable items based on current order
            displayConfig.badgeOrder.forEach(fieldName => {
                if (fields.includes(fieldName)) {
                    const isChecked = displayConfig.badgeFields && displayConfig.badgeFields.includes(fieldName);
                    const badgeItem = document.createElement('div');
                    badgeItem.className = 'badge-order-item';
                    badgeItem.draggable = true;
                    badgeItem.dataset.field = fieldName;
                    badgeItem.style.cssText = `
                        display: flex;
                        align-items: center;
                        padding: 8px 12px;
                        margin: 4px 0;
                        background: ${isChecked ? '#e3f2fd' : '#f5f5f5'};
                        border: 1px solid ${isChecked ? '#2196f3' : '#ddd'};
                        border-radius: 6px;
                        cursor: move;
                        user-select: none;
                        transition: all 0.3s;
                    `;
                    
                    badgeItem.innerHTML = `
                        <span style="margin-right: 8px; color: #666;">⋮⋮</span>
                        <label style="display: flex; align-items: center; cursor: pointer; flex: 1;">
                            <input type="checkbox" ${isChecked ? 'checked' : ''} style="margin-right: 8px;" onchange="updateBadgeSelection('${fieldName}', this.checked)">
                            <span>Badge ${fieldName}</span>
                        </label>
                    `;
                    
                    // Add drag and drop event listeners
                    badgeItem.addEventListener('dragstart', handleBadgeDragStart);
                    badgeItem.addEventListener('dragover', handleBadgeDragOver);
                    badgeItem.addEventListener('drop', handleBadgeDrop);
                    badgeItem.addEventListener('dragend', handleBadgeDragEnd);
                    
                    orderContainer.appendChild(badgeItem);
                }
            });
        }

        // Update badge selection when checkbox is changed
        function updateBadgeSelection(fieldName, isChecked) {
            if (!displayConfig.badgeFields) {
                displayConfig.badgeFields = [];
            }
            
            if (isChecked) {
                if (!displayConfig.badgeFields.includes(fieldName)) {
                    displayConfig.badgeFields.push(fieldName);
                }
            } else {
                displayConfig.badgeFields = displayConfig.badgeFields.filter(f => f !== fieldName);
            }
            
            // Update visual appearance of the item
            const badgeItem = document.querySelector(`[data-field="${fieldName}"]`);
            if (badgeItem) {
                badgeItem.style.background = isChecked ? '#e3f2fd' : '#f5f5f5';
                badgeItem.style.borderColor = isChecked ? '#2196f3' : '#ddd';
            }
        }

        // Drag and drop handlers for badge ordering
        let draggedBadgeElement = null;

        function handleBadgeDragStart(e) {
            draggedBadgeElement = this;
            this.style.opacity = '0.5';
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleBadgeDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleBadgeDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedBadgeElement !== this) {
                const container = document.getElementById('badgeOrderContainer');
                const items = Array.from(container.children);
                const draggedIndex = items.indexOf(draggedBadgeElement);
                const targetIndex = items.indexOf(this);

                if (draggedIndex < targetIndex) {
                    container.insertBefore(draggedBadgeElement, this.nextSibling);
                } else {
                    container.insertBefore(draggedBadgeElement, this);
                }

                // Update badge order in config
                const newOrder = Array.from(container.children).map(item => item.dataset.field);
                displayConfig.badgeOrder = newOrder;
            }

            return false;
        }

        function handleBadgeDragEnd(e) {
            this.style.opacity = '1';
            draggedBadgeElement = null;
        }

        // Generate dynamic badges HTML for an item (now respects order)
        function generateDynamicBadgesHTML(item) {
            let badgesHTML = '';
            
            if (displayConfig.badgeFields && displayConfig.badgeFields.length > 0 && displayConfig.badgeOrder) {
                // Sort badgeFields according to badgeOrder
                const sortedBadgeFields = displayConfig.badgeOrder.filter(field => 
                    displayConfig.badgeFields.includes(field)
                );
                
                sortedBadgeFields.forEach((fieldName, index) => {
                    if (item[fieldName]) {
                        // Determine icon and display format based on field type
                        let icon = '';
                        let displayValue = item[fieldName];
                        let color = '#2196f3'; // default blue
                        
                        // Check if this is a credit field
                        if (fieldName.toLowerCase().includes('tc') || 
                            fieldName.toLowerCase().includes('tín chỉ') || 
                            fieldName.toLowerCase().includes('credit') ||
                            fieldName.toLowerCase().includes('số tc')) {
                            icon = '📊 ';
                            displayValue = `${item[fieldName]} TC`;
                            color = '#ff9800'; // orange for credits
                        }
                        // Check if this is a department/management field
                        else if (fieldName.toLowerCase().includes('quản lý') || 
                                fieldName.toLowerCase().includes('đơn vị') || 
                                fieldName.toLowerCase().includes('khoa') ||
                                fieldName.toLowerCase().includes('department')) {
                            icon = '📁 ';
                            color = '#4caf50'; // green for departments
                        }
                        // Check for code fields
                        else if (fieldName.toLowerCase().includes('mã') || 
                                fieldName.toLowerCase().includes('code')) {
                            icon = '🏷️ ';
                            color = '#9c27b0'; // purple for codes
                        }
                        // Check for name fields
                        else if (fieldName.toLowerCase().includes('tên') || 
                                fieldName.toLowerCase().includes('name')) {
                            icon = '📖 ';
                            color = '#2196f3'; // blue for names
                        }
                        // Default for other fields
                        else {
                            const colors = ['#f44336', '#ff5722', '#795548', '#607d8b', '#3f51b5'];
                            color = colors[index % colors.length];
                            icon = '🔹 ';
                        }
                        
                        badgesHTML += `<span class="clickable-badge dynamic-badge" data-field="${escapeHtml(fieldName)}" data-value="${escapeHtml(item[fieldName])}" style="background: ${color}; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-block; margin-right: 4px;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" title="Click để lọc theo ${fieldName}: ${item[fieldName]}">${icon}${displayValue}</span>`;
                    }
                });
            }
            
            return badgesHTML;
        }

        function resetDisplaySettings() {
            if (confirm('Bạn có chắc muốn khôi phục về cài đặt mặc định không?')) {
                displayConfig = { ...DEFAULT_CONFIG };
                populateSettingsUI();
                showSettingsStatus('🔄 Đã khôi phục cài đặt mặc định', 'info');
            }
        }

        function previewDisplaySettings() {
            updateDisplayConfigFromUI();
            switchTab('search');
            refreshCurrentView();
            showStatus('👁️ Đang xem trước với cài đặt mới. Quay lại Settings để điều chỉnh hoặc lưu.', 'info');
        }

        function populateSettingsUI() {
            if (Object.keys(dataStructure).length === 0) return;

            const fields = getOrderedFields();
            
            // Populate field selects
            const primarySelect = document.getElementById('primaryFieldSelect');
            const secondarySelect = document.getElementById('secondaryFieldSelect');
            
            primarySelect.innerHTML = '<option value="">Chọn trường chính...</option>';
            secondarySelect.innerHTML = '<option value="">Chọn trường phụ...</option>';
            
            fields.forEach(field => {
                primarySelect.innerHTML += `<option value="${field}" ${field === displayConfig.primaryField ? 'selected' : ''}>${field}</option>`;
                secondarySelect.innerHTML += `<option value="${field}" ${field === displayConfig.secondaryField ? 'selected' : ''}>${field}</option>`;
            });

            // Generate dynamic badge checkboxes based on available fields
            generateBadgeCheckboxes();

            // Populate fields to hide
            const hideContainer = document.getElementById('fieldsToHideContainer');
            hideContainer.innerHTML = '';
            fields.forEach(field => {
                const isHidden = displayConfig.fieldsToHide.includes(field);
                hideContainer.innerHTML += `
                    <label class="checkbox-label">
                        <input type="checkbox" value="${field}" ${isHidden ? 'checked' : ''}>
                        <span>${field}</span>
                    </label>
                `;
            });

            // Populate fields order
            const orderContainer = document.getElementById('fieldsOrderContainer');
            orderContainer.innerHTML = '';
            
            const orderedFields = displayConfig.fieldsOrder.length > 0 
                ? displayConfig.fieldsOrder 
                : fields;
            
            orderedFields.forEach(field => {
                if (fields.includes(field)) {
                    const div = document.createElement('div');
                    div.className = 'field-order-item';
                    div.dataset.field = field;
                    div.draggable = true;
                    div.innerHTML = `
                        <span class="drag-handle">⋮⋮</span>
                        <span>${field}</span>
                    `;
                    orderContainer.appendChild(div);
                }
            });

            // Add drag and drop functionality
            addDragAndDropToFieldsOrder();
        }

        function addDragAndDropToFieldsOrder() {
            const container = document.getElementById('fieldsOrderContainer');
            let draggedElement = null;

            container.addEventListener('dragstart', function(e) {
                draggedElement = e.target;
                e.target.classList.add('dragging');
            });

            container.addEventListener('dragend', function(e) {
                e.target.classList.remove('dragging');
                draggedElement = null;
            });

            container.addEventListener('dragover', function(e) {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                if (afterElement == null) {
                    container.appendChild(draggedElement);
                } else {
                    container.insertBefore(draggedElement, afterElement);
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.field-order-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function showSettingsStatus(message, type) {
            const status = document.getElementById('settingsStatus');
            status.textContent = message;
            status.className = `settings-status ${type}`;
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    status.textContent = '';
                    status.className = 'settings-status';
                }, 5000);
            }
        }

        // Apply display config to field rendering
        function getOrderedFields() {
            const allFields = Object.keys(dataStructure);
            if (displayConfig.fieldsOrder.length > 0) {
                // Use configured order, add any missing fields at the end
                const orderedFields = [...displayConfig.fieldsOrder];
                allFields.forEach(field => {
                    if (!orderedFields.includes(field)) {
                        orderedFields.push(field);
                    }
                });
                return orderedFields.filter(field => allFields.includes(field));
            }
            return allFields;
        }

        function shouldShowField(fieldName) {
            return !displayConfig.fieldsToHide.includes(fieldName);
        }

        function getPrimaryField() {
            const fields = getOrderedFields();
            return displayConfig.primaryField && fields.includes(displayConfig.primaryField) 
                ? displayConfig.primaryField 
                : fields[0];
        }

        function getSecondaryField() {
            const fields = getOrderedFields();
            return displayConfig.secondaryField && fields.includes(displayConfig.secondaryField) 
                ? displayConfig.secondaryField 
                : fields[1];
        }

        // Lightweight refresh function for better performance
        function refreshCurrentView() {
            const searchInput = document.getElementById('searchInput');
            const currentSearch = searchInput.value.trim();
            
            // If there's a search term, perform search, otherwise show all data
            if (currentSearch) {
                performSearch(currentSearch);
            } else {
                displayAllData();
            }
        }

        // Get searchable value from field (with diacritics removed for fuzzy search)
        function getSearchableValue(item, fieldName) {
            const value = item[fieldName];
            let searchableText = '';
            
            if (Array.isArray(value)) {
                searchableText = value.join(' ');
            } else {
                searchableText = String(value || '');
            }
            
            // Return both original lowercase and no-diacritics version for fuzzy matching
            const lowercased = searchableText.toLowerCase();
            const noDiacritics = removeDiacritics(lowercased);
            return { original: lowercased, fuzzy: noDiacritics };
        }

        // Load dữ liệu từ file JSON
        async function loadData() {
            try {
                // Load display settings first
                await loadDisplaySettings();
                
                const response = await fetch('data.json');
                const data = await response.json();
                dictionaryData = data.dictionary;
                
                // Analyze structure after loading data
                dataStructure = analyzeDataStructureWithConfig(dictionaryData);
                console.log('Data structure detected:', dataStructure);
                
                // Tự động phát hiện các trường quan trọng
                const detectedSheetField = detectSheetFieldName();
                const detectedCreditField = detectCreditFieldName();
                
                // Generate dynamic badge checkboxes after data is loaded
                generateBadgeCheckboxes();
                console.log('Sheet field detected:', detectedSheetField);
                console.log('Credit field detected:', detectedCreditField);
                
                // Update default config with detected fields if not set
                if (!displayConfig.fieldsOrder.length) {
                    displayConfig.fieldsOrder = Object.keys(dataStructure);
                }
                
                // Populate settings UI if admin is logged in
                if (isLoggedIn) {
                    populateSettingsUI();
                }
                
                // Hiển thị toàn bộ dữ liệu khi vừa load xong
                displayAllData();
                
            } catch (error) {
                console.error('Lỗi load dữ liệu:', error);
                // Fallback data nếu không load được file JSON
                dictionaryData = [
                    {
                        id: 1,
                        word: "JavaScript",
                        category: "Ngôn ngữ lập trình",
                        description: "Ngôn ngữ lập trình thông dịch, hướng đối tượng với các hàm hạng nhất",
                        details: "JavaScript là ngôn ngữ lập trình được sử dụng rộng rãi để phát triển web",
                        tags: ["frontend", "backend", "web", "programming"]
                    }
                ];
                dataStructure = analyzeDataStructure(dictionaryData);
                displayAllData();
            }
        }

        // Debounce function để tránh gọi quá nhiều lần
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Highlight matching text
        function highlightText(text, searchTerm) {
            if (!searchTerm) return text;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // Tìm kiếm và hiển thị gợi ý
        function showSuggestions(searchTerm) {
            const dropdown = document.getElementById('suggestionsDropdown');
            
            if (!searchTerm || searchTerm.trim().length < 1) {
                dropdown.style.display = 'none';
                return;
            }

            // Kiểm tra dữ liệu đã tải chưa
            if (!dictionaryData || !Array.isArray(dictionaryData) || dictionaryData.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            const searchLower = searchTerm.toLowerCase().trim();
            const searchFuzzy = removeDiacritics(searchLower);
            
            // Tìm kiếm với độ ưu tiên: Mã HP > Tên tiếng Việt > Tên tiếng Anh > Các trường khác
            const results = dictionaryData.filter(item => {
                const maHP = getSearchableValue(item, 'Mã HP');
                const tenViet = getSearchableValue(item, 'Tên tiếng Việt');
                const tenAnh = getSearchableValue(item, 'Tên tiếng Anh');
                
                // Ưu tiên tìm kiếm trong các trường chính (với fuzzy search)
                return maHP.original.includes(searchLower) || maHP.fuzzy.includes(searchFuzzy) || 
                       tenViet.original.includes(searchLower) || tenViet.fuzzy.includes(searchFuzzy) || 
                       tenAnh.original.includes(searchLower) || tenAnh.fuzzy.includes(searchFuzzy) ||
                       // Tìm kiếm trong các trường khác
                       Object.keys(dataStructure).some(fieldName => {
                           if (['Mã HP', 'Tên tiếng Việt', 'Tên tiếng Anh'].includes(fieldName)) return false;
                           const searchableValue = getSearchableValue(item, fieldName);
                           return searchableValue.original.includes(searchLower) || searchableValue.fuzzy.includes(searchFuzzy);
                       });
            })
            // Sắp xếp kết quả theo độ ưu tiên
            .sort((a, b) => {
                const aCode = getSearchableValue(a, 'Mã HP');
                const bCode = getSearchableValue(b, 'Mã HP');
                const aViet = getSearchableValue(a, 'Tên tiếng Việt');
                const bViet = getSearchableValue(b, 'Tên tiếng Việt');
                
                // Ưu tiên mã HP khớp chính xác
                if (aCode.original === searchLower && bCode.original !== searchLower) return -1;
                if (bCode.original === searchLower && aCode.original !== searchLower) return 1;
                
                // Ưu tiên mã HP bắt đầu bằng search term (original hoặc fuzzy)
                if ((aCode.original.startsWith(searchLower) || aCode.fuzzy.startsWith(searchFuzzy)) && 
                    !(bCode.original.startsWith(searchLower) || bCode.fuzzy.startsWith(searchFuzzy))) return -1;
                if ((bCode.original.startsWith(searchLower) || bCode.fuzzy.startsWith(searchFuzzy)) && 
                    !(aCode.original.startsWith(searchLower) || aCode.fuzzy.startsWith(searchFuzzy))) return 1;
                
                // Ưu tiên tên tiếng Việt bắt đầu bằng search term (original hoặc fuzzy)
                if ((aViet.original.startsWith(searchLower) || aViet.fuzzy.startsWith(searchFuzzy)) && 
                    !(bViet.original.startsWith(searchLower) || bViet.fuzzy.startsWith(searchFuzzy))) return -1;
                if ((bViet.original.startsWith(searchLower) || bViet.fuzzy.startsWith(searchFuzzy)) && 
                    !(aViet.original.startsWith(searchLower) || aViet.fuzzy.startsWith(searchFuzzy))) return 1;
                
                return 0;
            })
            .slice(0, 8); // Giới hạn 8 kết quả

            if (results.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            dropdown.innerHTML = results.map((item, index) => {
                const maHP = item['Mã HP'] || '';
                const tenViet = item['Tên tiếng Việt'] || '';
                const tenAnh = item['Tên tiếng Anh'] || '';
                const donVi = detectedSheetFieldName ? (item[detectedSheetFieldName] || '') : '';
                const creditValue = detectedCreditFieldName ? (item[detectedCreditFieldName] || '') : '';
                
                // Xác định trường nào khớp với search term để highlight
                let primaryText = '';
                let matchedField = '';
                
                const maHPSearchable = getSearchableValue(item, 'Mã HP');
                const tenVietSearchable = getSearchableValue(item, 'Tên tiếng Việt');
                const tenAnhSearchable = getSearchableValue(item, 'Tên tiếng Anh');
                
                if (maHPSearchable.original.includes(searchLower) || maHPSearchable.fuzzy.includes(searchFuzzy)) {
                    primaryText = maHP;
                    matchedField = 'Mã HP';
                } else if (tenVietSearchable.original.includes(searchLower) || tenVietSearchable.fuzzy.includes(searchFuzzy)) {
                    primaryText = tenViet;
                    matchedField = 'Tên tiếng Việt';
                } else if (tenAnhSearchable.original.includes(searchLower) || tenAnhSearchable.fuzzy.includes(searchFuzzy)) {
                    primaryText = tenAnh;
                    matchedField = 'Tên tiếng Anh';
                } else {
                    primaryText = tenViet || maHP;
                    matchedField = 'Tên tiếng Việt';
                }
                
                return `
                    <div class="suggestion-item" data-index="${index}" data-word="${primaryText}" data-item-id="${item.id}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <span class="suggestion-word">${highlightText(String(primaryText), searchTerm)}</span>
                                <span class="suggestion-category">${maHP}</span>
                                ${creditValue ? `<span class="clickable-badge credit-badge" data-field="${escapeHtml(detectedCreditFieldName)}" data-value="${escapeHtml(creditValue)}" style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 3px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#f57f17'" onmouseout="this.style.background='#ff9800'" title="Click để lọc theo ${detectedCreditFieldName}: ${creditValue}">${creditValue} TC</span>` : ''}
                            </div>
                        </div>
                        <div class="suggestion-description">
                            ${matchedField !== 'Tên tiếng Việt' && tenViet ? `<div style="font-size: 11px; color: #555; margin-top: 2px;">${highlightText(tenViet, searchTerm)}</div>` : ''}
                            ${matchedField !== 'Tên tiếng Anh' && tenAnh ? `<div style="font-size: 10px; color: #777; font-style: italic; margin-top: 1px;">${highlightText(tenAnh, searchTerm)}</div>` : ''}
                            ${donVi ? `<div class="clickable-badge department-badge" data-field="${escapeHtml(detectedSheetFieldName)}" data-value="${escapeHtml(donVi)}" style="font-size: 9px; color: #999; margin-top: 2px; cursor: pointer;" onmouseover="this.style.color='#007bff'" onmouseout="this.style.color='#999'" title="Click để xem tất cả học phần của đơn vị này">📁 ${donVi}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            dropdown.style.display = 'block';
            currentHighlightIndex = -1;
        }

        // Thực hiện tìm kiếm và hiển thị kết quả chi tiết
        function performSearch(searchTerm = null, isExactMatch = false, selectedItemId = null) {
            const term = searchTerm || document.getElementById('searchInput').value.trim();
            const resultsContainer = document.getElementById('resultsContainer');

            // Nếu không có search term, hiển thị toàn bộ dữ liệu
            if (!term) {
                displayAllData();
                return;
            }

            // Check if term is in format "FieldName: FieldValue" (from badge clicks)
            const fieldSearchMatch = term.match(/^(.+?):\s*(.+)$/);
            if (fieldSearchMatch) {
                const fieldName = fieldSearchMatch[1].trim();
                const fieldValue = fieldSearchMatch[2].trim();
                console.log('Detected field search format:', fieldName, ':', fieldValue);
                
                // Use searchByField directly
                searchByField(fieldName, fieldValue);
                return;
            }

            let results = [];

            if (isExactMatch && selectedItemId) {
                // Nếu là exact match từ suggestion, chỉ hiển thị item được chọn
                results = dictionaryData.filter(item => item.id === selectedItemId);
            } else {
                // Tìm kiếm thông thường với fuzzy search
                const searchLower = term.toLowerCase();
                const searchFuzzy = removeDiacritics(searchLower);
                
                results = dictionaryData.filter(item => {
                    // Tìm kiếm trong tất cả các trường
                    return Object.keys(dataStructure).some(fieldName => {
                        const searchableValues = getSearchableValue(item, fieldName);
                        // Tìm kiếm cả bản gốc và bản không dấu
                        return searchableValues.original.includes(searchLower) || 
                               searchableValues.fuzzy.includes(searchFuzzy);
                    });
                });
            }

            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">Không tìm thấy kết quả nào phù hợp</div>';
            } else {
                resultsContainer.innerHTML = results.map(item => {
                    const fields = getOrderedFields();
                    let resultHTML = '<div class="result-item">';
                    
                    // Hiển thị trường theo cài đặt display config
                    const primaryField = getPrimaryField();
                    const primaryValue = item[primaryField];
                    const secondaryField = getSecondaryField();
                    const secondaryValue = item[secondaryField];
                    
                    resultHTML += `<div class="result-title" style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">${highlightText(String(primaryValue), term)}`;
                    if (secondaryValue && secondaryField !== primaryField) {
                        resultHTML += ` <span style="font-size: 14px; color: #666; font-weight: bold;">- ${secondaryValue}</span>`;
                    }
                    resultHTML += `</div>`;
                    
                    // Section cho các badges quan trọng (có thể click)
                    resultHTML += `<div style="margin: 10px 0; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">`;
                    
                    // Badges container (left side)
                    resultHTML += `<div style="display: flex; gap: 4px; align-items: center; flex-wrap: wrap;">`;
                    
                    // Dynamic badges based on user configuration
                    resultHTML += generateDynamicBadgesHTML(item);
                    const departmentField = 'Quản lý';
                    if (item[departmentField]) {
                        resultHTML += `<span class="clickable-badge department-badge" data-field="${escapeHtml(departmentField)}" data-value="${escapeHtml(item[departmentField])}" style="background: #28a745; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-block;" onmouseover="this.style.background='#20c997'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#28a745'; this.style.transform='scale(1)'" title="Click để xem tất cả học phần của đơn vị này">📁 ${item[departmentField]}</span>`;
                    }
                    
                    resultHTML += `</div>`; // Close badges container
                    
                    // Nút thêm vào chương trình (right side) - sử dụng helper function
                    resultHTML += renderAddToProgramButton(item, primaryField, secondaryField);
                    
                    resultHTML += `</div>`; // Close main badges section
                    
                    // Hiển thị các trường khác (theo cài đặt displayConfig)
                    fields.forEach(fieldName => {
                        // Skip các field theo cấu hình displayConfig
                        if (!shouldShowField(fieldName)) return;
                        
                        const value = item[fieldName];
                        const fieldDisplay = dataStructure[fieldName].displayName;
                        
                        if (value) {
                            if (Array.isArray(value)) {
                                // Hiển thị array (tags) - chỉ hiển thị, không có link
                                resultHTML += `<div style="margin-top: 12px;">`;
                                resultHTML += `<span style="font-size: 13px; color: #666; font-weight: 600;">${fieldDisplay}: </span>`;
                                resultHTML += value.map(tag => 
                                    `<span style="background: #e3f2fd; padding: 3px 8px; border-radius: 12px; font-size: 12px; margin-right: 6px; color: #1976d2; display: inline-block; margin-top: 2px;">${highlightText(String(tag), term)}</span>`
                                ).join('');
                                resultHTML += `</div>`;
                            } else {
                                // Hiển thị text thường - chỉ hiển thị, không có link
                                resultHTML += `<div style="margin-top: 10px; font-size: 14px; line-height: 1.4;">`;
                                resultHTML += `<span style="color: #666; font-weight: 600;">${fieldDisplay}:</span> `;
                                resultHTML += `<span style="color: #333;">${highlightText(String(value), term)}</span>`;
                                resultHTML += `</div>`;
                            }
                        }
                    });
                    
                    // Add to program button

                    
                    resultHTML += '</div>';
                    return resultHTML;
                }).join('');
            }

            // Ẩn dropdown sau khi tìm kiếm
            document.getElementById('suggestionsDropdown').style.display = 'none';
        }

        // Debounced search function - giảm delay để phản hồi nhanh hơn
        const debouncedSearch = debounce(showSuggestions, 150);

        // Hàm tìm kiếm theo bất kỳ trường nào
        function searchByField(fieldName, fieldValue) {
            const results = dictionaryData.filter(item => {
                const itemValue = item[fieldName];
                const normalizedItemValue = itemValue ? String(itemValue).trim() : '';
                const normalizedSearchValue = String(fieldValue).trim();
                
                return itemValue && normalizedItemValue === normalizedSearchValue;
            });

            const resultsContainer = document.getElementById('resultsContainer');
            const searchInput = document.getElementById('searchInput');
            
            // Cập nhật search input
            searchInput.value = `${fieldName}: ${fieldValue}`;
            
            // Ẩn dropdown suggestions
            document.getElementById('suggestionsDropdown').style.display = 'none';

            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <h3>😔 Không tìm thấy kết quả</h3>
                        <p>Không có học phần nào có <strong>${fieldName}</strong> là "<strong>${fieldValue}</strong>"</p>
                    </div>
                `;
                return;
            }

            // Hiển thị kết quả giống như displayFilteredResults
            displayFilteredResults(results, fieldName, fieldValue);
        }

        // Hàm tìm kiếm theo đơn vị quản lý học phần (backward compatibility)
        function searchByDepartment(departmentName) {
            if (detectedSheetFieldName) {
                searchByField(detectedSheetFieldName, departmentName);
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Helper function to decode HTML entities
            function decodeHtml(html) {
                const txt = document.createElement('textarea');
                txt.innerHTML = html;
                return txt.value;
            }
            
            // Thêm event delegation cho clickable badges
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('clickable-badge')) {
                    // Ngăn chặn event bubbling để không trigger suggestion item click
                    e.stopPropagation();
                    e.preventDefault();
                    
                    const fieldName = decodeHtml(e.target.getAttribute('data-field') || '');
                    const fieldValue = decodeHtml(e.target.getAttribute('data-value') || '');
                    
                    if (fieldName && fieldValue) {
                        searchByField(fieldName, fieldValue);
                    }
                }
            });

            const searchInput = document.getElementById('searchInput');
            const dropdown = document.getElementById('suggestionsDropdown');

            // Realtime search khi gõ
            searchInput.addEventListener('input', function(e) {
                const value = e.target.value;
                if (value.trim() === '') {
                    // Nếu search box trống, hiển thị toàn bộ dữ liệu
                    displayAllData();
                    dropdown.style.display = 'none';
                } else if (dictionaryData && dictionaryData.length > 0) {
                    // Chỉ hiển thị gợi ý khi dữ liệu đã được tải
                    debouncedSearch(value);
                } else {
                    // Nếu dữ liệu chưa tải, ẩn dropdown
                    dropdown.style.display = 'none';
                }
            });

            // Keyboard navigation
            searchInput.addEventListener('keydown', function(e) {
                const items = dropdown.querySelectorAll('.suggestion-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentHighlightIndex = Math.min(currentHighlightIndex + 1, items.length - 1);
                    updateHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentHighlightIndex = Math.max(currentHighlightIndex - 1, -1);
                    updateHighlight(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentHighlightIndex >= 0 && items[currentHighlightIndex]) {
                        const word = items[currentHighlightIndex].dataset.word;
                        const itemId = parseInt(items[currentHighlightIndex].dataset.itemId);
                        searchInput.value = word;
                        dropdown.style.display = 'none';
                        performSearch(word, true, itemId); // true = isExactMatch, itemId = selected item ID
                    } else {
                        // Nếu không có item nào được highlight, thực hiện tìm kiếm thông thường
                        dropdown.style.display = 'none';
                        performSearch();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.style.display = 'none';
                    currentHighlightIndex = -1;
                }
            });

            // Click on suggestion
            dropdown.addEventListener('click', function(e) {
                const item = e.target.closest('.suggestion-item');
                if (item) {
                    const word = item.dataset.word;
                    const itemId = parseInt(item.dataset.itemId);
                    searchInput.value = word;
                    dropdown.style.display = 'none';
                    performSearch(word, true, itemId); // true = isExactMatch, itemId = selected item ID
                }
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    dropdown.style.display = 'none';
                    currentHighlightIndex = -1;
                }
            });
        });

        function updateHighlight(items) {
            items.forEach((item, index) => {
                if (index === currentHighlightIndex) {
                    item.classList.add('highlighted');
                } else {
                    item.classList.remove('highlighted');
                }
            });
        }

        // Hiển thị toàn bộ dữ liệu
        function displayAllData() {
            ensureFieldDetection();
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (!dictionaryData || dictionaryData.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">Chưa có dữ liệu nào được tải</div>';
                return;
            }

            const totalItems = dictionaryData.length;
            
            // Hiển thị header thông tin tổng quan
            let allDataHTML = `
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                    <h3 style="color: #2e7d32; margin: 0 0 5px 0;">📚 Toàn bộ danh sách học phần</h3>
                    <p style="color: #666; margin: 0; font-size: 14px;">Tổng cộng: <strong>${totalItems}</strong> học phần từ các đơn vị</p>
                </div>
            `;

            // Hiển thị từng item
            allDataHTML += dictionaryData.map(item => {
                const fields = getOrderedFields();
                let resultHTML = '<div class="result-item">';
                
                // Hiển thị trường đầu tiên làm title (sử dụng display config)
                const primaryField = getPrimaryField();
                const primaryValue = item[primaryField];
                const secondaryField = getSecondaryField();
                const secondaryValue = item[secondaryField];
                
                resultHTML += `<div class="result-title" style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">${String(primaryValue)}`;
                if (secondaryValue && secondaryField !== primaryField) {
                    resultHTML += ` <span style="font-size: 14px; color: #666; font-weight: bold;">- ${secondaryValue}</span>`;
                }
                resultHTML += `</div>`;
                
                // Section cho các badges quan trọng (có thể click)
                resultHTML += `<div style="margin: 10px 0; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;">`;
                
                // Badges container (left side)
                resultHTML += `<div style="display: flex; gap: 4px; align-items: center; flex-wrap: wrap;">`;
                
                // Dynamic badges based on user configuration
                resultHTML += generateDynamicBadgesHTML(item);
                
                resultHTML += `</div>`; // Close badges container
                
                // Nút thêm vào chương trình (right side) - sử dụng helper function
                resultHTML += renderAddToProgramButton(item, primaryField, secondaryField);
                
                resultHTML += `</div>`;
                
                // Hiển thị các trường khác (theo cài đặt displayConfig)
                fields.forEach(fieldName => {
                    // Skip các field theo cấu hình displayConfig
                    if (!shouldShowField(fieldName)) return;
                    
                    const value = item[fieldName];
                    const fieldDisplay = dataStructure[fieldName].displayName;
                    
                    if (value) {
                        if (Array.isArray(value)) {
                            // Hiển thị array (tags) - chỉ hiển thị, không có link
                            resultHTML += `<div style="margin-top: 12px;">`;
                            resultHTML += `<span style="font-size: 13px; color: #666; font-weight: 600;">${fieldDisplay}: </span>`;
                            resultHTML += value.map(tag => 
                                `<span style="background: #e3f2fd; padding: 3px 8px; border-radius: 12px; font-size: 12px; margin-right: 6px; color: #1976d2; display: inline-block; margin-top: 2px;">${String(tag)}</span>`
                            ).join('');
                            resultHTML += `</div>`;
                        } else {
                            // Hiển thị text thường - chỉ hiển thị, không có link
                            resultHTML += `<div style="margin-top: 10px; font-size: 14px; line-height: 1.4;">`;
                            resultHTML += `<span style="color: #666; font-weight: 600;">${fieldDisplay}:</span> `;
                            resultHTML += `<span style="color: #333;">${String(value)}</span>`;
                            resultHTML += `</div>`;
                        }
                    }
                });
                
                resultHTML += '</div>';
                return resultHTML;
            }).join('');

            resultsContainer.innerHTML = allDataHTML;
        }

        // Excel Import Functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processExcelFile(file);
            }
        }

        function processExcelFile(file) {
            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                showStatus('File quá lớn! Vui lòng chọn file nhỏ hơn 10MB.', 'error');
                return;
            }

            // Reset UI state
            document.getElementById('sheetSelector').style.display = 'none';
            document.getElementById('previewSection').style.display = 'none';
            updateFieldConfigVisibility(false);

            showStatus('Đang đọc file Excel...', 'success');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    excelWorkbook = XLSX.read(data, { type: 'array' });
                    
                    if (excelWorkbook.SheetNames.length === 0) {
                        showStatus('File Excel không có sheet nào!', 'error');
                        return;
                    }

                    if (excelWorkbook.SheetNames.length === 1) {
                        // Chỉ có 1 sheet, xử lý trực tiếp
                        updateFieldConfigVisibility(false);
                        selectedSheetNames = [excelWorkbook.SheetNames[0]];
                        processSelectedSheets();
                    } else {
                        // Có nhiều sheet, hiển thị để chọn
                        updateFieldConfigVisibility(true);
                        displaySheetSelector();
                    }

                } catch (error) {
                    console.error('Lỗi đọc file Excel:', error);
                    showStatus('Lỗi đọc file Excel. Vui lòng kiểm tra format file.', 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function updateFieldConfigVisibility(isMultipleSheets) {
            const configSection = document.querySelector('.sheet-field-config');
            const configNote = document.querySelector('.config-note');
            
            if (isMultipleSheets) {
                configSection.style.display = 'block';
                configNote.innerHTML = '💡 File Excel có nhiều sheet - tên sheet sẽ được lưu vào trường này';
                configNote.style.color = '#28a745';
            } else {
                configSection.style.display = 'block';
                configNote.innerHTML = '💡 File Excel chỉ có 1 sheet - trường này sẽ không được thêm vào dữ liệu';
                configNote.style.color = '#6c757d';
            }
        }

        function displaySheetSelector() {
            const sheetSelector = document.getElementById('sheetSelector');
            const sheetList = document.getElementById('sheetList');
            
            // Hide preview section if visible
            document.getElementById('previewSection').style.display = 'none';
            
            // Reset selected sheets
            selectedSheetNames = [];
            updateSelectedCount();
            
            // Create sheet items with checkboxes
            sheetList.innerHTML = excelWorkbook.SheetNames.map(sheetName => {
                const sheet = excelWorkbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                const rowCount = jsonData.length;
                const colCount = jsonData.length > 0 ? Math.max(...jsonData.map(row => row.length)) : 0;
                
                return `
                    <div class="sheet-item" onclick="toggleSheet('${sheetName}')">
                        <input type="checkbox" class="sheet-checkbox" id="checkbox_${sheetName}" onchange="toggleSheet('${sheetName}')">
                        <div class="sheet-name">${sheetName}</div>
                        <div class="sheet-info">${rowCount} dòng, ${colCount} cột</div>
                    </div>
                `;
            }).join('');

            sheetSelector.style.display = 'block';
            showStatus(`Tìm thấy ${excelWorkbook.SheetNames.length} sheet. Chọn một hoặc nhiều sheet để import.`, 'success');
        }

        function toggleSheet(sheetName) {
            const checkbox = document.getElementById(`checkbox_${sheetName}`);
            const sheetItem = checkbox.closest('.sheet-item');
            
            if (selectedSheetNames.includes(sheetName)) {
                // Remove from selection
                selectedSheetNames = selectedSheetNames.filter(name => name !== sheetName);
                checkbox.checked = false;
                sheetItem.classList.remove('checked');
            } else {
                // Add to selection
                selectedSheetNames.push(sheetName);
                checkbox.checked = true;
                sheetItem.classList.add('checked');
            }
            
            updateSelectedCount();
            document.getElementById('processSheetBtn').disabled = selectedSheetNames.length === 0;
        }

        function selectAllSheets() {
            selectedSheetNames = [...excelWorkbook.SheetNames];
            excelWorkbook.SheetNames.forEach(sheetName => {
                const checkbox = document.getElementById(`checkbox_${sheetName}`);
                const sheetItem = checkbox.closest('.sheet-item');
                checkbox.checked = true;
                sheetItem.classList.add('checked');
            });
            updateSelectedCount();
            document.getElementById('processSheetBtn').disabled = false;
            showStatus('Đã chọn tất cả sheet', 'success');
        }

        function selectNoSheets() {
            selectedSheetNames = [];
            excelWorkbook.SheetNames.forEach(sheetName => {
                const checkbox = document.getElementById(`checkbox_${sheetName}`);
                const sheetItem = checkbox.closest('.sheet-item');
                checkbox.checked = false;
                sheetItem.classList.remove('checked');
            });
            updateSelectedCount();
            document.getElementById('processSheetBtn').disabled = true;
            showStatus('Đã bỏ chọn tất cả sheet', 'error');
        }

        function updateSelectedCount() {
            const countElement = document.getElementById('selectedCount');
            countElement.textContent = `(${selectedSheetNames.length} sheet đã chọn)`;
        }

        function processSelectedSheets() {
            if (!selectedSheetNames.length || !excelWorkbook) {
                showStatus('Vui lòng chọn ít nhất một sheet để xử lý!', 'error');
                return;
            }

            showStatus(`Đang xử lý ${selectedSheetNames.length} sheet...`, 'success');
            
            // Merge data from all selected sheets
            mergeMultipleSheets();
        }

        function mergeMultipleSheets() {
            pendingImportData = [];
            let totalValidRows = 0;
            let totalInvalidRows = 0;
            let globalId = 1;
            
            // Kiểm tra xem có phải chỉ 1 sheet không
            const isMultipleSheets = excelWorkbook.SheetNames.length > 1;

            selectedSheetNames.forEach(sheetName => {
                const sheet = excelWorkbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                if (jsonData.length < 2) {
                    showStatus(`Sheet "${sheetName}" được bỏ qua (không có đủ dữ liệu)`, 'error');
                    return;
                }

                // Process each sheet's data - chỉ truyền sheetName khi có nhiều sheet
                const customFieldName = document.getElementById('sheetFieldName').value.trim() || 'Đơn vị quản lý học phần';
                const { validRows, invalidRows, sheetData } = processSheetData(jsonData, isMultipleSheets ? sheetName : null, globalId, customFieldName);
                
                // Merge into pending data
                pendingImportData = pendingImportData.concat(sheetData);
                
                totalValidRows += validRows;
                totalInvalidRows += invalidRows;
                globalId += sheetData.length;
            });

            if (pendingImportData.length === 0) {
                showStatus('Không có dữ liệu hợp lệ trong các sheet đã chọn!', 'error');
                return;
            }

            // Hide sheet selector
            document.getElementById('sheetSelector').style.display = 'none';

            if (isMultipleSheets) {
                showStatus(`Đã gộp ${selectedSheetNames.length} sheet: ${totalValidRows} dòng hợp lệ, ${totalInvalidRows} dòng bỏ qua (thiếu dữ liệu)`, 'success');
            } else {
                showStatus(`Đã xử lý: ${totalValidRows} dòng hợp lệ, ${totalInvalidRows} dòng bỏ qua (thiếu dữ liệu)`, 'success');
            }
            displayPreview();
        }

        function processSheetData(rawData, sheetName, startId, customFieldName) {
            // Get header row (row 0) - tên các cột từ Excel
            const headerRow = rawData[0];
            const dataRows = rawData.slice(1);
            const sheetData = [];

            if (!headerRow || headerRow.length === 0) {
                return { validRows: 0, invalidRows: dataRows.length, sheetData: [] };
            }

            let validRows = 0;
            let invalidRows = 0;

            dataRows.forEach((row, index) => {
                // Skip empty rows
                if (!row || row.length === 0 || row.every(cell => !cell)) {
                    invalidRows++;
                    return;
                }

                // Tạo object với tên field = tên header từ Excel
                const rowData = {
                    id: startId + validRows
                    // Note: isRequired field is NOT added to database
                    // It's only used for personal curriculum planning
                };
                
                // Chỉ thêm trường tùy chỉnh khi có nhiều sheet
                if (sheetName && customFieldName) {
                    rowData[customFieldName] = sheetName;
                }

                let hasCompleteData = true; // Changed: require ALL fields to have data
                let fieldCount = 0;
                
                headerRow.forEach((header, colIndex) => {
                    if (header && header.trim()) {
                        const fieldName = String(header).trim();
                        const cellValue = row[colIndex] ? String(row[colIndex]).trim() : '';
                        fieldCount++;
                        
                        // Xử lý đặc biệt cho field có thể là array (tags, keywords, etc.)
                        if (fieldName.toLowerCase().includes('tag') || 
                            fieldName.toLowerCase().includes('keyword') ||
                            fieldName.toLowerCase().includes('từ khóa')) {
                            rowData[fieldName] = cellValue ? cellValue.split(',').map(tag => tag.trim()) : [];
                            // For array fields, empty is acceptable
                        } else {
                            rowData[fieldName] = cellValue;
                            // For regular fields, require non-empty value
                            if (!cellValue || cellValue === '') {
                                hasCompleteData = false;
                            }
                        }
                    }
                });

                // Only add rows that have complete data in ALL fields (except array fields)
                if (hasCompleteData && fieldCount > 0) {
                    sheetData.push(rowData);
                    validRows++;
                } else {
                    invalidRows++;
                }
            });

            return { validRows, invalidRows, sheetData };
        }



        function displayPreview() {
            const previewSection = document.getElementById('previewSection');
            const tableHead = document.getElementById('previewTableHead');
            const tableBody = document.getElementById('previewTableBody');

            if (pendingImportData.length === 0) return;

            // Tạo headers động từ fields trong data (chỉ hiển thị các trường sẽ có trong database)
            const firstItem = pendingImportData[0];
            const allFields = Object.keys(firstItem).filter(key => key !== 'id' && key !== 'isRequired');
            
            // Sắp xếp lại thứ tự cột: STT đầu tiên, sheet field cuối cùng
            const orderedFields = [];
            
            // 1. STT luôn đầu tiên (tự động tạo)
            orderedFields.push('STT');
            
            // 2. Các field khác (trừ STT và sheet field)
            const sheetFieldName = detectedSheetFieldName || selectedSheetNames[0]; // Tên field chứa sheet name
            allFields.forEach(field => {
                if (field !== 'STT' && field !== sheetFieldName) {
                    orderedFields.push(field);
                }
            });
            
            // 3. Sheet field cuối cùng (nếu có)
            if (sheetFieldName && allFields.includes(sheetFieldName)) {
                orderedFields.push(sheetFieldName);
            }
            
            // Tạo header HTML
            tableHead.innerHTML = `
                <tr>
                    ${orderedFields.map(field => `<th>${field}</th>`).join('')}
                </tr>
            `;

            // Show max 10 rows for preview
            const previewData = pendingImportData.slice(0, 10);
            
            tableBody.innerHTML = previewData.map((item, index) => {
                return `
                    <tr>
                        ${orderedFields.map(field => {
                            let value = item[field];
                            
                            // Xử lý STT đặc biệt
                            if (field === 'STT') {
                                value = index + 1;
                            }
                            
                            if (Array.isArray(value)) {
                                // Hiển thị array như tags
                                return `<td>${value.map(tag => `<span style="background: #f0f0f0; padding: 1px 6px; border-radius: 8px; font-size: 10px; margin-right: 3px;">${tag}</span>`).join('')}</td>`;
                            } else {
                                // Hiển thị text thường, truncate nếu quá dài
                                const displayValue = String(value || '');
                                const truncated = displayValue.length > 50 ? displayValue.substring(0, 50) + '...' : displayValue;
                                return `<td>${truncated}</td>`;
                            }
                        }).join('')}
                    </tr>
                `;
            }).join('');

            if (pendingImportData.length > 10) {
                tableBody.innerHTML += `<tr><td colspan="${orderedFields.length}" style="text-align: center; font-style: italic; color: #666;">... và ${pendingImportData.length - 10} dòng khác</td></tr>`;
            }

            previewSection.style.display = 'block';
        }

        function generateJSON() {
            if (pendingImportData.length === 0) {
                showStatus('Không có dữ liệu để tạo JSON!', 'error');
                return;
            }

            try {
                showStatus('Đang tạo file JSON...', 'success');

                // Clean data for database - remove fields that shouldn't be in database
                const cleanedData = pendingImportData.map((item, index) => {
                    const cleanItem = { ...item };
                    delete cleanItem.isRequired; // Remove isRequired from database
                    cleanItem.id = index + 1;
                    return cleanItem;
                });

                // Create new JSON file content
                const newData = {
                    dictionary: cleanedData
                };

                // Create and download JSON file
                const jsonString = JSON.stringify(newData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showStatus(`Tạo thành công file data.json với ${pendingImportData.length} từ khóa. File đã được tải xuống!`, 'success');
                
                // Clear import data after 3 seconds
                setTimeout(() => {
                    cancelImport();
                }, 3000);

            } catch (error) {
                console.error('Lỗi tạo JSON:', error);
                showStatus('Có lỗi xảy ra khi tạo file JSON!', 'error');
            }
        }



        function cancelImport() {
            pendingImportData = [];
            excelWorkbook = null;
            selectedSheetNames = [];
            
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('sheetSelector').style.display = 'none';
            document.getElementById('fileInput').value = '';
            document.getElementById('processSheetBtn').disabled = true;
            
            // Clear sheet selection
            document.querySelectorAll('.sheet-item').forEach(item => {
                item.classList.remove('checked');
            });
            document.querySelectorAll('.sheet-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            updateSelectedCount();
            showStatus('Đã hủy import', 'error');
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';

            // Auto hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Drag and Drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });

            function highlight(e) {
                uploadArea.classList.add('drag-over');
            }

            function unhighlight(e) {
                uploadArea.classList.remove('drag-over');
            }

            uploadArea.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        processExcelFile(file);
                    } else {
                        showStatus('Vui lòng chọn file Excel (.xlsx hoặc .xls)', 'error');
                    }
                }
            }
        });

        // ============== PROGRAM BUILDER FUNCTIONS ==============
        
        // Update program counter in tab
        function updateProgramCounter() {
            const counter = document.getElementById('programCounter');
            const count = selectedProgram.length;
            counter.textContent = count;
            counter.className = count > 0 ? 'counter' : 'counter zero';
        }

        // Update program statistics
        function updateProgramStats() {
            ensureFieldDetection();
            
            const subjects = selectedProgram.length;
            let totalCredits = 0;
            let requiredCredits = 0;
            let electiveCredits = 0;
            const departments = new Set();
            
            selectedProgram.forEach(item => {
                // Calculate credits
                if (detectedCreditFieldName && item[detectedCreditFieldName]) {
                    const credits = parseInt(item[detectedCreditFieldName]) || 0;
                    totalCredits += credits;
                    
                    // Calculate required vs elective credits
                    if (item.isRequired === true) {
                        requiredCredits += credits;
                    } else {
                        electiveCredits += credits;
                    }
                }
                
                // Track departments
                if (detectedSheetFieldName && item[detectedSheetFieldName]) {
                    departments.add(item[detectedSheetFieldName]);
                }
            });
            
            // Calculate elective to required ratio percentage
            let electiveRatio = 0;
            if (requiredCredits > 0) {
                electiveRatio = Math.round((electiveCredits / requiredCredits) * 100);
            } else if (electiveCredits > 0) {
                electiveRatio = 100; // All credits are elective
            }
            
            // Update display
            document.getElementById('totalSubjects').textContent = subjects;
            document.getElementById('totalCredits').textContent = totalCredits;
            document.getElementById('totalDepartments').textContent = departments.size;
            document.getElementById('electiveRatio').textContent = electiveRatio + '%';
            
            programStats = { subjects, credits: totalCredits, departments: departments.size, electiveRatio, requiredCredits, electiveCredits };
        }

        // Helper function to render add to program button
        function renderAddToProgramButton(item, primaryField, secondaryField) {
            ensureFieldDetection();
            
            // Không hiển thị nút nếu chưa đăng nhập
            if (!isLoggedIn) {
                return '';
            }
            
            const isAlreadyAdded = selectedProgram.some(programItem => 
                programItem[primaryField] === item[primaryField] && 
                (secondaryField ? programItem[secondaryField] === item[secondaryField] : true)
            );
            
            if (isAlreadyAdded) {
                return `<button class="add-to-program-btn added" disabled style="background: #4caf50; color: white; border: none; padding: 6px 16px; border-radius: 20px; font-size: 12px; cursor: default; opacity: 0.8; flex-shrink: 0;">✓ Đã thêm</button>`;
            }
            
            return `<button class="add-to-program-btn" data-item-json='${JSON.stringify(item).replace(/'/g, "&#39;")}' style="background: #2196f3; color: white; border: none; padding: 6px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s; flex-shrink: 0;">➕ Thêm vào danh sách</button>`;
        }

        // Add to program with dropdown selection
        function addToProgram(item, event) {
            ensureFieldDetection();
            
            // Check if item already exists
            const fields = Object.keys(dataStructure);
            const primaryField = fields[0];
            const secondaryField = fields[1];
            
            const isDuplicate = selectedProgram.some(programItem => 
                programItem[primaryField] === item[primaryField] && 
                programItem[secondaryField] === item[secondaryField]
            );
            
            if (isDuplicate) {
                alert('Học phần này đã có trong danh sách!');
                return;
            }
            
            // Show dropdown at button position
            showCategoryDropdown(item, event);
        }

        // Variables for hover dropdown management
        let hoverTimeout;
        let currentHoverItem = null;
        
        // Show dropdown on hover with delay
        function showDropdownOnHover(item, event) {
            // Clear any existing timeout
            if (hoverTimeout) {
                clearTimeout(hoverTimeout);
            }
            
            // Set a small delay to avoid flickering
            hoverTimeout = setTimeout(() => {
                ensureFieldDetection();
                
                // Check if item already exists using same logic as addToProgram
                const fields = Object.keys(dataStructure);
                const primaryField = fields[0];
                const secondaryField = fields[1];
                
                const isDuplicate = selectedProgram.some(selectedItem => {
                    return selectedItem[primaryField] === item[primaryField] && 
                           selectedItem[secondaryField] === item[secondaryField];
                });
                
                if (!isDuplicate) {
                    currentHoverItem = item;
                    showCategoryDropdown(item, event);
                }
            }, 200); // 200ms delay
        }
        
        // Hide dropdown on mouse leave with delay
        function hideDropdownOnHover() {
            // Clear show timeout if mouse leaves before showing
            if (hoverTimeout) {
                clearTimeout(hoverTimeout);
            }
            
            // Set delay before hiding to allow mouse to move to dropdown
            setTimeout(() => {
                const dropdown = document.getElementById('categoryDropdown');
                const isHoveringDropdown = dropdown && dropdown.matches(':hover');
                
                if (!isHoveringDropdown) {
                    closeCategoryDropdown();
                    currentHoverItem = null;
                }
            }, 300); // 300ms delay before hiding
        }

        // Show compact category dropdown with smart positioning
        function showCategoryDropdown(item, event) {
            // Close any existing dropdown
            closeCategoryDropdown();
            
            const button = event.target;
            const rect = button.getBoundingClientRect();
            
            const dropdown = document.createElement('div');
            dropdown.id = 'categoryDropdown';
            
            // Calculate dropdown height (approximately 6 items * 28px per item with compact padding)
            const dropdownHeight = 168; // 6 items × 28px per item
            const viewportHeight = window.innerHeight;
            const spaceBelow = viewportHeight - rect.bottom;
            const spaceAbove = rect.top;
            
            // Determine if dropdown should appear above or below the button
            let topPosition;
            if (spaceBelow >= dropdownHeight + 10) {
                // Enough space below - show dropdown below button
                topPosition = rect.bottom + 5;
            } else if (spaceAbove >= dropdownHeight + 10) {
                // Not enough space below but enough above - show dropdown above button
                topPosition = rect.top - dropdownHeight - 5;
            } else {
                // Limited space both directions - show above if more space, otherwise below
                topPosition = spaceAbove > spaceBelow ? 
                    Math.max(10, rect.top - dropdownHeight - 5) : 
                    rect.bottom + 5;
            }
            
            dropdown.style.cssText = `
                position: fixed;
                top: ${topPosition}px;
                left: ${rect.left}px;
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 8px 0;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                min-width: 200px;
                max-width: 250px;
                max-height: none;
                overflow-y: visible;
            `;
            
            const categories = [
                { name: 'HP đại cương', icon: '🏛️', color: '#1976d2' },
                { name: 'HP cơ sở ngành', icon: '🏗️', color: '#2e7d32' },
                { name: 'HP khối ngành', icon: '📚', color: '#795548' },
                { name: 'HP ngành', icon: '🎯', color: '#f57c00' },
                { name: 'HP chuyên ngành', icon: '🔬', color: '#c2185b' },
                { name: 'HP thực tập/tốt nghiệp', icon: '🎓', color: '#7b1fa2' },
                { name: 'HP thay thế ĐA/Khóa luận TN', icon: '📋', color: '#ff6f00' }
            ];
            
            categories.forEach((category, index) => {
                const option = document.createElement('div');
                option.style.cssText = `
                    padding: 6px 12px;
                    cursor: pointer;
                    font-size: 12px;
                    color: ${category.color};
                    font-weight: 600;
                    border-bottom: ${index < categories.length - 1 ? '1px solid #f0f0f0' : 'none'};
                    transition: background 0.2s;
                `;
                option.innerHTML = `${category.icon} ${category.name}`;
                
                option.onmouseover = function() {
                    this.style.background = '#f8f9fa';
                };
                option.onmouseout = function() {
                    this.style.background = 'white';
                };
                
                option.onclick = function() {
                    // Immediate UI feedback - find and update button state right away
                    const buttonElement = findButtonForItem(item);
                    if (buttonElement) {
                        updateButtonToAddedState(buttonElement);
                    }
                    
                    // Close dropdown immediately
                    closeCategoryDropdown();
                    
                    // Process addition with optimized performance
                    addToProgramWithCategoryOptimized(item, category.name);
                };
                
                dropdown.appendChild(option);
            });
            
            document.body.appendChild(dropdown);
            
            // Add hover listeners to keep dropdown open when hovering over it
            dropdown.addEventListener('mouseenter', () => {
                // Clear any hide timeout when hovering over dropdown
                if (hoverTimeout) {
                    clearTimeout(hoverTimeout);
                }
            });
            
            dropdown.addEventListener('mouseleave', () => {
                // Hide dropdown with delay when mouse leaves dropdown
                setTimeout(() => {
                    closeCategoryDropdown();
                    currentHoverItem = null;
                }, 200);
            });
            
            // Close dropdown when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closeCategoryDropdown);
            }, 100);
        }

        // Close category dropdown
        function closeCategoryDropdown() {
            const dropdown = document.getElementById('categoryDropdown');
            if (dropdown) {
                document.body.removeChild(dropdown);
                document.removeEventListener('click', closeCategoryDropdown);
            }
        }

        // Add item to program with specific category
        function addToProgramWithCategory(item, category) {
            // Add category and default requirement status to item
            const itemWithCategory = { ...item, __category: category, isRequired: true };
            
            // Add to program
            selectedProgram.push(itemWithCategory);
            
            // Save to localStorage
            localStorage.setItem('selectedProgram', JSON.stringify(selectedProgram));
            
            // Update UI
            updateProgramCounter();
            updateProgramStats();
            renderProgramList();
            
            // Refresh current results to update button states
            refreshCurrentView();
            
            // Show success feedback
            ensureFieldDetection();
            const fields = Object.keys(dataStructure);
            const primaryField = fields[0];
            showStatus(`Đã thêm "${item[primaryField]}" vào danh sách (${category})!`, 'success');
        }
        
        // Optimized version with immediate feedback and deferred heavy operations
        function addToProgramWithCategoryOptimized(item, category) {
            // Add category and default requirement status to item
            const itemWithCategory = { ...item, __category: category, isRequired: true };
            
            // Add to program immediately
            selectedProgram.push(itemWithCategory);
            
            // Save to localStorage immediately
            localStorage.setItem('selectedProgram', JSON.stringify(selectedProgram));
            
            // Update counter immediately (lightweight)
            updateProgramCounter();
            
            // Show success feedback immediately
            ensureFieldDetection();
            const fields = Object.keys(dataStructure);
            const primaryField = fields[0];
            showStatus(`Đã thêm "${item[primaryField]}" vào danh sách (${category})!`, 'success');
            
            // Defer heavy operations to next tick to avoid blocking UI
            setTimeout(() => {
                updateProgramStats();
                renderProgramList();
                refreshCurrentViewOptimized(item);
            }, 10);
        }
        
        // Helper function to find button element for specific item
        function findButtonForItem(item) {
            ensureFieldDetection();
            const fields = Object.keys(dataStructure);
            const primaryField = fields[0];
            const secondaryField = fields[1];
            
            // Find button by looking for onclick attribute containing item data
            const buttons = document.querySelectorAll('.add-to-program-btn:not(.added)');
            for (let button of buttons) {
                const onclick = button.getAttribute('onclick');
                if (onclick && onclick.includes(item[primaryField]) && 
                    (!secondaryField || onclick.includes(item[secondaryField]))) {
                    return button;
                }
            }
            return null;
        }
        
        // Helper function to immediately update button to "added" state
        function updateButtonToAddedState(buttonElement) {
            buttonElement.className = 'add-to-program-btn added';
            buttonElement.disabled = true;
            buttonElement.style.cssText = 'background: #4caf50; color: white; border: none; padding: 6px 16px; border-radius: 20px; font-size: 12px; cursor: default; opacity: 0.8; flex-shrink: 0;';
            buttonElement.innerHTML = '✓ Đã thêm';
            // Remove data attribute to prevent further interactions
            buttonElement.removeAttribute('data-item-json');
        }
        
        // Optimized refresh that only updates necessary buttons instead of re-rendering everything
        function refreshCurrentViewOptimized(addedItem) {
            // Instead of refreshing entire view, just ensure other buttons with same item are updated
            ensureFieldDetection();
            const fields = Object.keys(dataStructure);
            const primaryField = fields[0];
            const secondaryField = fields[1];
            
            // Find any other instances of the same button and update them
            const buttons = document.querySelectorAll('.add-to-program-btn:not(.added)');
            buttons.forEach(button => {
                const itemJson = button.getAttribute('data-item-json');
                if (itemJson) {
                    try {
                        const buttonItem = JSON.parse(itemJson.replace(/&#39;/g, "'"));
                        
                        // Compare using the SAME logic as addToProgram duplicate check
                        if (buttonItem[primaryField] === addedItem[primaryField] && 
                            buttonItem[secondaryField] === addedItem[secondaryField]) {
                            updateButtonToAddedState(button);
                        }
                    } catch (e) {
                        console.error('Error parsing data-item-json for button update:', e);
                    }
                }
            });
        }

        // Remove item from program
        function removeFromProgram(item) {
            ensureFieldDetection();
            
            const fields = Object.keys(dataStructure);
            const primaryField = fields[0];
            const secondaryField = fields[1];
            
            const index = selectedProgram.findIndex(programItem => 
                programItem[primaryField] === item[primaryField] && 
                programItem[secondaryField] === item[secondaryField]
            );
            
            if (index > -1) {
                selectedProgram.splice(index, 1);
                
                // Save to localStorage
                localStorage.setItem('selectedProgram', JSON.stringify(selectedProgram));
                
                // Update UI
                updateProgramCounter();
                updateProgramStats();
                renderProgramList();
                
                // Refresh current results to update button states
                refreshCurrentView();
                
                // Show success feedback
                showStatus(`Đã xóa "${item[primaryField]}" khỏi danh sách!`, 'success');
            }
        }

        // Toggle requirement status for an item
        function toggleRequirement(checkboxId, item) {
            ensureFieldDetection();
            
            const checkbox = document.getElementById(checkboxId);
            const label = document.querySelector(`label[for="${checkboxId}"]`);
            
            if (!checkbox || !label) return;
            
            const isRequired = checkbox.checked;
            
            // Find and update the item in selectedProgram
            const fields = Object.keys(dataStructure);
            const primaryField = fields[0];
            const secondaryField = fields[1];
            
            const index = selectedProgram.findIndex(programItem => 
                programItem[primaryField] === item[primaryField] && 
                programItem[secondaryField] === item[secondaryField]
            );
            
            if (index > -1) {
                // Update the item in selectedProgram
                selectedProgram[index].isRequired = isRequired;
                
                // Update label appearance and text
                label.textContent = isRequired ? 'Bắt buộc' : 'Tự chọn';
                label.className = `requirement-label ${isRequired ? 'required' : 'elective'}`;
                
                // Save to localStorage
                localStorage.setItem('selectedProgram', JSON.stringify(selectedProgram));
                
                // Update program stats
                updateProgramStats();
                
                // Show feedback
                const status = isRequired ? 'Bắt buộc' : 'Tự chọn';
                showStatus(`Đã cập nhật "${item[primaryField]}" thành ${status}!`, 'success');
            }
        }

        // Refresh current view to update button states
        function refreshCurrentView() {
            const activeTab = document.querySelector('.tab-button.active');
            let activeTabId = 'search'; // Default to search tab
            
            if (activeTab) {
                const onclickAttr = activeTab.getAttribute('onclick');
                if (onclickAttr) {
                    const match = onclickAttr.match(/'([^']+)'/);
                    if (match) {
                        activeTabId = match[1];
                    }
                }
            }
            
            // Check current search state and refresh accordingly
            if (activeTabId === 'search') {
                const searchInput = document.getElementById('searchInput');
                const selectedDepartment = document.getElementById('departmentFilter');
                const selectedCredit = document.getElementById('creditFilter');
                
                if (searchInput && selectedDepartment && selectedCredit) {
                    if (searchInput.value.trim() || selectedDepartment.value !== 'all' || selectedCredit.value !== 'all') {
                        // There are active filters, refresh filtered results
                        performSearch();
                    } else {
                        // No filters, show all data
                        displayAllData();
                    }
                } else {
                    // Fallback: try to display all data if elements exist
                    if (dictionaryData && dictionaryData.length > 0) {
                        displayAllData();
                    }
                }
            } else if (activeTabId === 'program') {
                // Refresh program list
                renderProgramList();
            }
        }

        // Clear entire program
        function clearProgram() {
            if (selectedProgram.length === 0) return;
            
            if (confirm('Bạn có chắc muốn xóa tất cả học phần đã chọn?')) {
                selectedProgram = [];
                
                // Save to localStorage
                localStorage.setItem('selectedProgram', JSON.stringify(selectedProgram));
                
                updateProgramCounter();
                updateProgramStats();
                renderProgramList();
                
                // Refresh current results to update button states
                refreshCurrentView();
                
                showStatus('Đã xóa tất cả học phần khỏi danh sách!', 'success');
            }
        }

        // Export program with multiple format options
        function exportProgram() {
            if (selectedProgram.length === 0) {
                alert('Chưa có học phần nào để xuất!');
                return;
            }
            
            // Show export options modal
            showExportModal();
        }

        // Show export modal with format options
        function showExportModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <h3 style="margin: 0 0 20px 0; color: #333; text-align: center;">📤 Xuất danh sách chương trình</h3>
                    <p style="color: #666; text-align: center; margin-bottom: 25px;">Chọn định dạng xuất cho ${selectedProgram.length} học phần đã chọn</p>
                    
                    <div style="display: grid; gap: 12px;">
                        <button onclick="exportAsText(); closeExportModal()" style="padding: 15px; border: 2px solid #2196f3; background: #f8fbff; color: #2196f3; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 600;" onmouseover="this.style.background='#2196f3'; this.style.color='white'" onmouseout="this.style.background='#f8fbff'; this.style.color='#2196f3'">
                            📄 Xuất dạng Text (.txt) - Danh sách đơn giản
                        </button>
                        
                        <button onclick="exportAsCSV(); closeExportModal()" style="padding: 15px; border: 2px solid #4caf50; background: #f8fff8; color: #4caf50; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 600;" onmouseover="this.style.background='#4caf50'; this.style.color='white'" onmouseout="this.style.background='#f8fff8'; this.style.color='#4caf50'">
                            📊 Xuất dạng CSV (.csv) - Import vào Excel
                        </button>
                        
                        <button onclick="exportAsJSON(); closeExportModal()" style="padding: 15px; border: 2px solid #ff9800; background: #fffdf8; color: #ff9800; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 600;" onmouseover="this.style.background='#ff9800'; this.style.color='white'" onmouseout="this.style.background='#fffdf8'; this.style.color='#ff9800'">
                            🔧 Xuất dạng JSON (.json) - Dữ liệu kỹ thuật
                        </button>
                        
                        <button onclick="exportAsFormatted(); closeExportModal()" style="padding: 15px; border: 2px solid #9c27b0; background: #fdfaff; color: #9c27b0; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 600;" onmouseover="this.style.background='#9c27b0'; this.style.color='white'" onmouseout="this.style.background='#fdfaff'; this.style.color='#9c27b0'">
                            📋 Xuất dạng Formatted - Báo cáo chi tiết
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button onclick="closeExportModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; color: #666;">
                            Hủy
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentExportModal = modal;
        }

        // Close export modal
        function closeExportModal() {
            if (window.currentExportModal) {
                document.body.removeChild(window.currentExportModal);
                window.currentExportModal = null;
            }
        }

        // Export as simple text format with table format
        function exportAsText() {
            ensureFieldDetection();
            const fields = Object.keys(dataStructure);
            const maHPField = fields[0];
            const tenVietField = fields[1];
            const tenAnhField = fields[2] || '';
            
            let content = `CHƯƠNG TRÌNH ĐÀO TẠO\n`;
            content += `Ngày xuất: ${new Date().toLocaleDateString('vi-VN')}\n`;
            content += `Tổng số học phần: ${selectedProgram.length}\n`;
            content += `Tổng số tín chỉ: ${programStats.credits}\n`;
            content += `Số đơn vị quản lý: ${programStats.departments}\n`;
            if (programStats.electiveRatio !== undefined) {
                content += `Tỷ lệ Tự chọn/Bắt buộc: ${programStats.electiveRatio}%\n`;
            }
            content += `${'='.repeat(80)}\n\n`;
            
            // Table header with proper spacing
            content += `${'STT'.padEnd(5)}${'Mã HP'.padEnd(12)}${'Tên tiếng Việt'.padEnd(35)}${'Tên tiếng Anh'.padEnd(35)}${'Số TC'.padEnd(8)}${'Đơn vị quản lý'.padEnd(20)}${'Bắt buộc/Tự chọn'.padEnd(18)}\n`;
            content += `${'-'.repeat(5)}${'-'.repeat(12)}${'-'.repeat(35)}${'-'.repeat(35)}${'-'.repeat(8)}${'-'.repeat(20)}${'-'.repeat(18)}\n`;
            
            // Table rows
            selectedProgram.forEach((item, index) => {
                const stt = String(index + 1).padEnd(5);
                const maHP = String(item[maHPField] || '').padEnd(12);
                const tenViet = String(item[tenVietField] || '').substring(0, 32).padEnd(35);
                const tenAnh = String(item[tenAnhField] || '').substring(0, 32).padEnd(35);
                const soTC = String(item[detectedCreditFieldName] || '').padEnd(8);
                const donVi = String(item[detectedSheetFieldName] || '').substring(0, 17).padEnd(20);
                const requirement = (item.isRequired ? 'Bắt buộc' : 'Tự chọn').padEnd(18);
                
                content += `${stt}${maHP}${tenViet}${tenAnh}${soTC}${donVi}${requirement}\n`;
            });
            
            downloadFile(content, 'chuong-trinh-dao-tao.txt', 'text/plain');
        }

        // Export as CSV format - using dynamic column configuration
        function exportAsCSV() {
            ensureFieldDetection();
            
            // Auto-detect field names like in renderProgramList
            let maHPField = null;
            let tenVietField = null;
            let tenAnhField = null;
            let creditField = detectedCreditFieldName;
            let departmentField = detectedSheetFieldName;
            
            if (selectedProgram.length > 0) {
                const sampleItem = selectedProgram[0];
                const fieldNames = Object.keys(sampleItem);
                
                maHPField = fieldNames.find(field => 
                    field.toLowerCase().includes('mã') && field.toLowerCase().includes('hp')
                ) || fieldNames.find(field => 
                    field.toLowerCase().includes('code')
                );
                
                tenVietField = fieldNames.find(field => 
                    field.toLowerCase().includes('tên') && field.toLowerCase().includes('việt')
                ) || fieldNames.find(field => 
                    field.toLowerCase().includes('vietnamese') || field.toLowerCase().includes('name')
                );
                
                tenAnhField = fieldNames.find(field => 
                    field.toLowerCase().includes('tên') && field.toLowerCase().includes('anh')
                ) || fieldNames.find(field => 
                    field.toLowerCase().includes('english')
                );
            }
            
            // Group items by category for CSV export
            const categories = {
                'HP đại cương': { items: [], name: 'Học phần Đại cương', icon: '🏛️' },
                'HP cơ sở ngành': { items: [], name: 'Học phần Cơ sở ngành', icon: '🏗️' },
                'HP khối ngành': { items: [], name: 'Học phần Khối ngành', icon: '📚' },
                'HP ngành': { items: [], name: 'Học phần Ngành', icon: '🎯' },
                'HP chuyên ngành': { items: [], name: 'Học phần Chuyên ngành', icon: '🔬' },
                'HP thực tập/tốt nghiệp': { items: [], name: 'Học phần Thực tập/Tốt nghiệp', icon: '🎓' },
                'HP thay thế ĐA/Khóa luận TN': { items: [], name: 'Học phần Thay thế ĐA/Khóa luận TN', icon: '📋' }
            };
            
            // Group items by their category
            selectedProgram.forEach(item => {
                const category = item.__category || 'HP đại cương';
                if (categories[category]) {
                    categories[category].items.push(item);
                }
            });
            
            // Use only visible columns from configuration (excluding delete column for CSV)
            const visibleColumns = columnConfig.columns.filter(col => col.visible && col.id !== 'xoa');
            
            // Start CSV content
            let csvContent = '';
            
            // Add overall header
            csvContent += '"CHƯƠNG TRÌNH ĐÀO TẠO"\n';
            csvContent += `"Ngày xuất: ${new Date().toLocaleDateString('vi-VN')}"\n`;
            csvContent += `"Tổng số học phần: ${selectedProgram.length}"\n`;
            csvContent += `"Tổng số tín chỉ: ${selectedProgram.reduce((sum, item) => sum + (parseInt(item[creditField]) || 0), 0)}"\n`;
            csvContent += '\n'; // Empty line
            
            // Process each category
            Object.keys(categories).forEach(categoryKey => {
                const category = categories[categoryKey];
                if (category.items.length > 0) {
                    // Add category header
                    csvContent += `"${category.name} (${category.items.length} học phần - ${category.items.reduce((sum, item) => sum + (parseInt(item[creditField]) || 0), 0)} tín chỉ)"\n`;
                    
                    // Add table headers for this category
                    const headers = visibleColumns.map(col => col.name);
                    csvContent += headers.join(',') + '\n';
                    
                    // Add items for this category
                    category.items.forEach((item, index) => {
                        const stt = index + 1;
                        const maHP = item[maHPField] || '';
                        const tenViet = item[tenVietField] || '';
                        const tenAnh = item[tenAnhField] || '';
                        const soTC = item[creditField] || '';
                        const donVi = item[departmentField] || '';
                        const isRequired = item.isRequired !== undefined ? item.isRequired : true;
                        const batBuoc = isRequired ? 'Bắt buộc' : 'Tự chọn';
                        
                        // Prepare column data matching the table structure
                        const columnData = {
                            stt: stt,
                            maHP: maHP,
                            tenViet: tenViet,
                            tenAnh: tenAnh,
                            soTC: soTC,
                            donVi: donVi,
                            batBuoc: batBuoc
                        };
                        
                        // Create row based on visible columns
                        const row = visibleColumns.map(column => {
                            const value = columnData[column.id] || '';
                            const strValue = String(value);
                            const escaped = strValue.replace(/"/g, '""');
                            return (escaped.includes(',') || escaped.includes(';') || escaped.includes('\n') || escaped.includes('\r') || escaped.includes('"')) ? `"${escaped}"` : escaped;
                        });
                        
                        csvContent += row.join(',') + '\n';
                    });
                    
                    // Add empty line between categories
                    csvContent += '\n';
                }
            });
            
            // Add UTF-8 BOM for proper Vietnamese character display in Excel
            const BOM = '\uFEFF';
            csvContent = BOM + csvContent;
            
            downloadFile(csvContent, 'chuong-trinh-dao-tao.csv', 'text/csv');
        }

        // Export as JSON format
        function exportAsJSON() {
            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    totalSubjects: selectedProgram.length,
                    totalCredits: programStats.credits,
                    totalDepartments: programStats.departments,
                    dataStructure: dataStructure
                },
                program: selectedProgram
            };
            
            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadFile(jsonContent, 'chuong-trinh-dao-tao.json', 'application/json');
        }

        // Export as formatted report
        function exportAsFormatted() {
            ensureFieldDetection();
            const fields = Object.keys(dataStructure);
            const primaryField = fields[0];
            const secondaryField = fields[1];
            
            let content = `<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chương trình Đào tạo</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 40px; line-height: 1.6; }
        .header { margin-bottom: 40px; padding: 20px 0; font-family: 'Times New Roman', serif; }
        .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; }
        .header-left { text-align: center; flex: 1; }
        .header-right { text-align: center; flex: 1; }
        .university-name { font-size: 14px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .university-sub { font-size: 12px; text-decoration: underline; }
        .country-name { font-size: 14px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .country-sub { font-size: 12px; font-style: italic; }
        .main-title { text-align: center; font-size: 18px; font-weight: bold; text-transform: uppercase; margin: 30px 0 20px 0; }
        .subtitle { text-align: center; font-size: 12px; font-style: italic; margin-bottom: 30px; line-height: 1.4; }
        .info-section { margin: 20px 0; }
        .info-row { display: flex; margin: 8px 0; font-size: 13px; }
        .info-label { width: 150px; font-weight: bold; }
        .info-value { flex: 1; border-bottom: 1px dotted #000; min-height: 18px; }
        .dashboard-title { color: #343a40; font-size: 18px; margin: 25px 0 15px 0; font-weight: 600; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin: 0 0 20px 0; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); }
        .stat-number { font-size: 24px; font-weight: 700; margin: 0 0 5px 0; line-height: 1; }
        .stat-label { font-size: 12px; opacity: 0.9; margin: 0; font-weight: 400; }
        .categories-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin: 20px 0; }
        .category-stat { background: white; border: 1px solid #e1e5e9; border-radius: 8px; padding: 15px; text-align: center; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .category-stat:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .category-icon { font-size: 20px; margin-bottom: 8px; }
        .category-count { font-size: 20px; font-weight: 700; margin: 5px 0; }
        .category-name { font-size: 11px; color: #6c757d; font-weight: 500; margin: 0; }
        .category-credits { font-size: 10px; color: #868e96; margin-top: 3px; }
        .subject { margin: 20px 0; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background: white; }
        .subject-title { font-size: 18px; font-weight: bold; color: #2196f3; margin-bottom: 10px; }
        .subject-subtitle { color: #666; margin-bottom: 15px; }
        .badges { margin: 10px 0; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; margin: 2px 5px 2px 0; }
        .credit-badge { background: #ff9800; color: white; }
        .dept-badge { background: #28a745; color: white; }
        .details { margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0; }
        .detail-row { margin: 5px 0; }
        .detail-label { font-weight: 600; color: #555; }
        
        /* Table styles */
        .category-table { width: 100%; border-collapse: collapse; font-size: 13px; margin: 10px 0 30px 0; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .category-table thead { background: #f8f9fa; }
        .category-table th { padding: 12px 8px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6; border-bottom: 2px solid #dee2e6; }
        .category-table th:last-child { border-right: none; }
        .category-table td { padding: 10px 8px; border-right: 1px solid #dee2e6; border-bottom: 1px solid #dee2e6; }
        .category-table td:last-child { border-right: none; }
        .category-table tbody tr:hover { background-color: #f8f9fa; }
        .category-table tbody tr:last-child td { border-bottom: none; }
        
        @media print { body { margin: 20px; } }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div class="header-left">
                <div class="university-name">TRƯỜNG ĐẠI HỌC ĐẠI NAM</div>
                <div class="university-sub">KHOA ...............................</div>
            </div>
            <div class="header-right">
                <div class="country-name">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</div>
                <div class="country-sub">Độc lập - Tự do - Hạnh phúc</div>
            </div>
        </div>
        
        <div class="main-title">KHUNG CHƯƠNG TRÌNH ĐÀO TẠO</div>
        
        <div class="subtitle">
            (Ban hành theo Quyết định số ........../QĐ-ĐN ngày ... tháng ... năm 20.. của Hiệu trưởng<br>
            Trường Đại học Đại Nam)
        </div>
        
        <div class="info-section">
            <div class="info-row">
                <div class="info-label">Ngành đào tạo:</div>
                <div class="info-value"></div>
            </div>
            <div class="info-row">
                <div class="info-label">Mã ngành:</div>
                <div class="info-value"></div>
            </div>
            <div class="info-row">
                <div class="info-label">Trình độ đào tạo:</div>
                <div class="info-value"></div>
            </div>
            <div class="info-row">
                <div class="info-label">Loại hình đào tạo:</div>
                <div class="info-value"></div>
            </div>
            <div class="info-row">
                <div class="info-label">Văn bằng tốt nghiệp</div>
                <div class="info-value"></div>
            </div>
            <div class="info-row">
                <div class="info-label">Ngôn ngữ đào tạo:</div>
                <div class="info-value"></div>
            </div>
        </div>
    </div>
    
    <h2 class="dashboard-title">📊 Tổng quan Chương trình Đào tạo</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">${selectedProgram.length}</div>
            <div class="stat-label">Học phần</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${programStats.credits}</div>
            <div class="stat-label">Tín chỉ</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${programStats.departments}</div>
            <div class="stat-label">Đơn vị</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${Math.round((selectedProgram.filter(item => item.isRequired !== false).length / selectedProgram.length) * 100)}%</div>
            <div class="stat-label">Tự chọn/Bắt buộc</div>
        </div>
    </div>
    
`;

            // Group items by category for display
            const categories = {
                'HP đại cương': { items: [], icon: '🏛️', color: '#1976d2', bgColor: '#e3f2fd', name: 'Học phần Đại cương' },
                'HP cơ sở ngành': { items: [], icon: '🏗️', color: '#2e7d32', bgColor: '#e8f5e8', name: 'Học phần Cơ sở ngành' },
                'HP khối ngành': { items: [], icon: '📚', color: '#795548', bgColor: '#efebe9', name: 'Học phần Khối ngành' },
                'HP ngành': { items: [], icon: '🎯', color: '#f57c00', bgColor: '#fff3e0', name: 'Học phần Ngành' },
                'HP chuyên ngành': { items: [], icon: '🔬', color: '#c2185b', bgColor: '#fce4ec', name: 'Học phần Chuyên ngành' },
                'HP thực tập/tốt nghiệp': { items: [], icon: '🎓', color: '#7b1fa2', bgColor: '#f3e5f5', name: 'Học phần Thực tập/Tốt nghiệp' },
                'HP thay thế ĐA/Khóa luận TN': { items: [], icon: '📋', color: '#ff6f00', bgColor: '#fff8e1', name: 'Học phần Thay thế ĐA/Khóa luận TN' }
            };
            
            // Group items by their category
            selectedProgram.forEach(item => {
                const category = item.__category || 'HP đại cương';
                if (categories[category]) {
                    categories[category].items.push(item);
                }
            });
            
            content += `<h2 class="dashboard-title">📐 Thống kê Chương trình Đào tạo</h2>`;
            
            // Create modern visual statistics with progress bars and better layout
            // Calculate percentages for visual representation
            const totalSubjects = selectedProgram.length;
            
            content += `
            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 12px; margin: 15px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">`;
            Object.keys(categories).forEach(categoryKey => {
                const category = categories[categoryKey];
                if (category.items.length > 0) {
                    const totalCredits = category.items.reduce((sum, item) => {
                        const credits = detectedCreditFieldName && item[detectedCreditFieldName] ? parseInt(item[detectedCreditFieldName]) || 0 : 0;
                        return sum + credits;
                    }, 0);
                    const percentage = Math.round((category.items.length / totalSubjects) * 100);
                    const barWidth = Math.max(percentage, 5); // Minimum 5% for visibility
                    
                    content += `
                    <div style="background: white; padding: 18px; border-radius: 10px; border-left: 4px solid ${category.color}; box-shadow: 0 2px 6px rgba(0,0,0,0.1); transition: transform 0.2s ease;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 18px;">${category.icon}</span>
                                <span style="font-size: 14px; font-weight: 600; color: #343a40;">${category.name.replace('Học phần ', '')}</span>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 20px; font-weight: 700; color: ${category.color};">${category.items.length}</div>
                                <div style="font-size: 11px; color: #6c757d; font-weight: 500;">${percentage}%</div>
                            </div>
                        </div>
                        <div style="background: #e9ecef; height: 8px; border-radius: 4px; overflow: hidden; margin: 12px 0;">
                            <div style="background: linear-gradient(90deg, ${category.color}, ${category.color}dd); height: 100%; width: ${barWidth}%; border-radius: 4px; transition: width 1s ease; box-shadow: inset 0 1px 2px rgba(255,255,255,0.3);"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 12px; color: #6c757d; display: flex; align-items: center; gap: 4px;">
                                <span style="width: 8px; height: 8px; background: ${category.color}; border-radius: 50%; opacity: 0.7;"></span>
                                ${totalCredits} tín chỉ
                            </span>
                            <span style="font-size: 12px; font-weight: 600; color: ${category.color}; background: ${category.color}15; padding: 2px 8px; border-radius: 10px;">${category.items.length}/${totalSubjects}</span>
                        </div>
                    </div>`;
                }
            });
            content += `
                </div>
            </div>`;
            
            // Display courses by category
            Object.keys(categories).forEach(categoryKey => {
                const category = categories[categoryKey];
                if (category.items.length > 0) {
                    // Category header
                    content += `
                <div style="margin: 30px 0 10px 0;">
                    <div style="background: ${category.bgColor}; border-left: 4px solid ${category.color}; padding: 15px; border-radius: 8px;">
                        <h3 style="margin: 0; color: ${category.color}; font-size: 16px; font-weight: bold;">
                            ${category.icon} ${category.name} 
                            <span style="font-size: 14px; font-weight: normal; opacity: 0.8;">(${category.items.length} học phần - ${category.items.reduce((sum, item) => {
                                const credits = detectedCreditFieldName && item[detectedCreditFieldName] ? parseInt(item[detectedCreditFieldName]) || 0 : 0;
                                return sum + credits;
                            }, 0)} tín chỉ)</span>
                        </h3>
                    </div>
                </div>`;
                    
                    // Table for this category
                    content += `
                <table class="category-table">
                    <thead>
                        <tr>
                            <th style="width: 50px; text-align: center;">STT</th>
                            <th style="width: 100px;">Mã HP</th>
                            <th style="width: 250px;">Tên tiếng Việt</th>
                            <th style="width: 250px;">Tên tiếng Anh</th>
                            <th style="width: 70px; text-align: center;">Số TC</th>
                            <th style="width: 120px; text-align: center;">Bắt buộc/Tự chọn</th>
                            <th>Đơn vị quản lý</th>
                        </tr>
                    </thead>
                    <tbody>`;
                    
                    // Detect field names (same logic as Tab "Chương trình đào tạo")
                    let maHPField = null;
                    let tenVietField = null;
                    let tenAnhField = null;
                    let creditField = detectedCreditFieldName;
                    let departmentField = detectedSheetFieldName;
                    
                    // Auto-detect field names from data
                    if (category.items.length > 0) {
                        const sampleItem = category.items[0];
                        const fieldNames = Object.keys(sampleItem);
                        
                        maHPField = fieldNames.find(field => 
                            field.toLowerCase().includes('mã') && field.toLowerCase().includes('hp')
                        ) || fieldNames.find(field => 
                            field.toLowerCase().includes('code')
                        );
                        
                        tenVietField = fieldNames.find(field => 
                            field.toLowerCase().includes('tên') && field.toLowerCase().includes('việt')
                        ) || fieldNames.find(field => 
                            field.toLowerCase().includes('vietnamese') || field.toLowerCase().includes('name')
                        );
                        
                        tenAnhField = fieldNames.find(field => 
                            field.toLowerCase().includes('tên') && field.toLowerCase().includes('anh')
                        ) || fieldNames.find(field => 
                            field.toLowerCase().includes('english')
                        );
                    }
                    
                    category.items.forEach((item, index) => {
                        const stt = index + 1;
                        const maHP = item[maHPField] || '';
                        const tenViet = item[tenVietField] || '';
                        const tenAnh = item[tenAnhField] || '';
                        const soTC = item[creditField] || '';
                        const donVi = item[departmentField] || '';
                        const isRequired = item.isRequired !== undefined ? item.isRequired : true;
                        const batBuoc = isRequired ? 'Bắt buộc' : 'Tự chọn';
                        
                        content += `
                        <tr>
                            <td style="text-align: center; color: #6c757d; font-weight: 500;">${stt}</td>
                            <td style="color: #495057; font-weight: 500;">${maHP}</td>
                            <td style="color: #212529; font-weight: 500;">${tenViet}</td>
                            <td style="color: #6c757d;">${tenAnh}</td>
                            <td style="text-align: center; color: #495057; font-weight: 500;">${soTC}</td>
                            <td style="text-align: center;">
                                <span style="padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; ${isRequired ? 'background: #d4edda; color: #155724;' : 'background: #fff3cd; color: #856404;'}">${batBuoc}</span>
                            </td>
                            <td style="color: #6c757d;">${donVi}</td>
                        </tr>`;
                    });
                    
                    content += `
                    </tbody>
                </table>
                </div>`;
                }
            });
            
            content += `
<` + `/body>
<` + `/html>`;
            
            downloadFile(content, 'chuong-trinh-dao-tao.html', 'text/html');
        }

        // Download file helper function
        function downloadFile(content, filename, mimeType) {
            // Ensure proper UTF-8 encoding for CSV files
            const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showStatus(`Đã tải xuống file: ${filename}`, 'success');
            } else {
                alert('Trình duyệt không hỗ trợ tải xuống file tự động!');
            }
        }

        // Render program list
        function renderProgramList() {
            const programList = document.getElementById('programList');
            
            if (selectedProgram.length === 0) {
                programList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📝</div>
                        <h3>Chưa có học phần nào</h3>
                        <p>Vào tab "Tìm Kiếm" để thêm học phần vào chương trình đào tạo</p>
                    </div>
                `;
                return;
            }
            
            ensureFieldDetection();
            
            // Detect field names
            let maHPField = null;
            let tenVietField = null;
            let tenAnhField = null;
            let creditField = detectedCreditFieldName;
            let departmentField = detectedSheetFieldName;
            
            // Auto-detect field names from data
            if (selectedProgram.length > 0) {
                const sampleItem = selectedProgram[0];
                const fieldNames = Object.keys(sampleItem);
                
                maHPField = fieldNames.find(field => 
                    field.toLowerCase().includes('mã') && field.toLowerCase().includes('hp')
                ) || fieldNames.find(field => 
                    field.toLowerCase().includes('code')
                );
                
                tenVietField = fieldNames.find(field => 
                    field.toLowerCase().includes('tên') && field.toLowerCase().includes('việt')
                ) || fieldNames.find(field => 
                    field.toLowerCase().includes('vietnamese') || field.toLowerCase().includes('name')
                );
                
                tenAnhField = fieldNames.find(field => 
                    field.toLowerCase().includes('tên') && field.toLowerCase().includes('anh')
                ) || fieldNames.find(field => 
                    field.toLowerCase().includes('english')
                );
            }
            
            // Group items by category for display
            const categories = {
                'HP đại cương': { items: [], icon: '🏛️', color: '#1976d2', bgColor: '#e3f2fd' },
                'HP cơ sở ngành': { items: [], icon: '🏗️', color: '#2e7d32', bgColor: '#e8f5e8' },
                'HP khối ngành': { items: [], icon: '📚', color: '#795548', bgColor: '#efebe9' },
                'HP ngành': { items: [], icon: '🎯', color: '#f57c00', bgColor: '#fff3e0' },
                'HP chuyên ngành': { items: [], icon: '🔬', color: '#c2185b', bgColor: '#fce4ec' },
                'HP thực tập/tốt nghiệp': { items: [], icon: '🎓', color: '#7b1fa2', bgColor: '#f3e5f5' },
                'HP thay thế ĐA/Khóa luận TN': { items: [], icon: '📋', color: '#ff6f00', bgColor: '#fff8e1' }
            };
            
            // Group items by their category
            selectedProgram.forEach(item => {
                const category = item.__category || 'HP đại cương';
                if (categories[category]) {
                    categories[category].items.push(item);
                }
            });
            
            let programHTML = `
                <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                    <h3 style="color: #2196f3; margin: 0 0 5px 0;">📋 Chương trình đào tạo đã chọn</h3>
                    <p style="color: #666; margin: 0; font-size: 14px;">Tổng cộng ${selectedProgram.length} học phần</p>
                </div>
            `;
            
            // Render each category as a table
            Object.keys(categories).forEach(categoryName => {
                const category = categories[categoryName];
                const categoryItems = category.items;
                
                if (categoryItems.length > 0) {
                    // Category header
                    programHTML += `
                        <div style="background: ${category.bgColor}; border-left: 4px solid ${category.color}; padding: 15px; margin: 20px 0 10px 0; border-radius: 8px;">
                            <h4 style="margin: 0; color: ${category.color}; font-size: 16px; font-weight: bold;">
                                ${category.icon} ${categoryName} 
                                <span style="font-size: 14px; font-weight: normal; opacity: 0.8;">(${categoryItems.length} học phần)</span>
                            </h4>
                        </div>
                    `;
                    
                    // Table for this category - using dynamic column configuration
                    programHTML += `
                        <div style="margin: 0 0 30px 20px; background: white; border-radius: 8px; overflow: visible; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                    `;
                    
                    // Generate table headers based on column configuration
                    const visibleColumns = columnConfig.columns.filter(col => col.visible);
                    visibleColumns.forEach((column, index) => {
                        const isLast = index === visibleColumns.length - 1;
                        const borderStyle = isLast ? '' : 'border-right: 1px solid #dee2e6;';
                        programHTML += `
                            <th style="padding: 12px 8px; text-align: ${column.align}; font-weight: 600; color: #495057; ${borderStyle} width: ${column.width};">${column.name}</th>
                        `;
                    });
                    
                    programHTML += `
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    // Table rows for items in this category - using dynamic column configuration
                    categoryItems.forEach((item, index) => {
                        const stt = index + 1;
                        const maHP = item[maHPField] || '';
                        const tenViet = item[tenVietField] || '';
                        const tenAnh = item[tenAnhField] || '';
                        const soTC = item[creditField] || '';
                        const donVi = item[departmentField] || '';
                        
                        // Generate unique ID for this item
                        const itemId = `item_${maHP}_${index}_${Date.now()}`;
                        
                        // Check if item has requirement status, default to true (required)
                        const isRequired = item.isRequired !== undefined ? item.isRequired : true;
                        
                        // Prepare column data
                        const columnData = {
                            stt: stt,
                            maHP: maHP,
                            tenViet: tenViet,
                            tenAnh: tenAnh,
                            soTC: soTC,
                            hocTruoc: createPrerequisiteSearchBox(maHP, item.__prerequisite || loadPrerequisiteForCourse(maHP)),
                            donVi: donVi,
                            batBuoc: `
                                <div class="checkbox-container">
                                    <input type="checkbox" id="${itemId}" class="requirement-checkbox" 
                                           ${isRequired ? 'checked' : ''} 
                                           onchange="toggleRequirement('${itemId}', ${JSON.stringify(item).replace(/"/g, '&quot;')})">
                                    <label for="${itemId}" class="requirement-label ${isRequired ? 'required' : 'elective'}">
                                        ${isRequired ? 'Bắt buộc' : 'Tự chọn'}
                                    </label>
                                </div>
                            `,
                            xoa: `
                                <button onclick="removeFromProgram(${JSON.stringify(item).replace(/"/g, '&quot;')})" 
                                        style="background: #dc3545; color: white; border: none; padding: 4px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; transition: all 0.2s; min-width: 35px;" 
                                        onmouseover="this.style.background='#c82333'" 
                                        onmouseout="this.style.background='#dc3545'" 
                                        title="Xóa khỏi danh sách">✕</button>
                            `
                        };
                        
                        programHTML += `
                            <tr style="border-bottom: 1px solid #dee2e6; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor='white'">
                        `;
                        
                        // Generate table cells based on column configuration
                        visibleColumns.forEach((column, colIndex) => {
                            const isLast = colIndex === visibleColumns.length - 1;
                            const borderStyle = isLast ? '' : 'border-right: 1px solid #dee2e6;';
                            const cellData = columnData[column.id] || '';
                            
                            // Apply different styles for different column types
                            let cellStyle = `padding: 10px 8px; text-align: ${column.align}; ${borderStyle}`;
                            let cellClass = '';
                            
                            switch (column.id) {
                                case 'stt':
                                    cellStyle += ' color: #6c757d; font-weight: 500;';
                                    break;
                                case 'maHP':
                                    cellStyle += ' color: #495057; font-weight: 500;';
                                    break;
                                case 'tenViet':
                                    cellStyle += ' color: #212529; font-weight: 500;';
                                    break;
                                case 'tenAnh':
                                    cellStyle += ' color: #6c757d;';
                                    break;
                                case 'soTC':
                                    cellStyle += ' color: #495057; font-weight: 600;';
                                    break;
                                case 'hocTruoc':
                                    cellStyle += ' padding: 5px;';
                                    break;
                                case 'donVi':
                                    cellStyle += ' color: #6c757d; font-size: 12px;';
                                    break;
                            }
                            
                            programHTML += `<td style="${cellStyle}">${cellData}</td>`;
                        });
                        
                        programHTML += `</tr>`;
                    });
                    
                    programHTML += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            });
            
            programList.innerHTML = programHTML;
        }



        // Setup global event delegation for add-to-program buttons (only once)
        function setupGlobalEventDelegation() {
            // Click handler
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('add-to-program-btn') && 
                    !event.target.classList.contains('added')) {
                    
                    const itemJson = event.target.getAttribute('data-item-json');
                    if (itemJson) {
                        try {
                            const item = JSON.parse(itemJson.replace(/&#39;/g, "'"));
                            addToProgram(item, event);
                        } catch (e) {
                            console.error('Error parsing item JSON:', e);
                        }
                    }
                }
            });
            
            // Hover handler
            document.addEventListener('mouseover', function(event) {
                if (event.target.classList.contains('add-to-program-btn') && 
                    !event.target.classList.contains('added')) {
                    
                    event.target.style.background = '#1976d2';
                    
                    const itemJson = event.target.getAttribute('data-item-json');
                    if (itemJson) {
                        try {
                            const item = JSON.parse(itemJson.replace(/&#39;/g, "'"));
                            showDropdownOnHover(item, event);
                        } catch (e) {
                            console.error('Error parsing item JSON for hover:', e);
                        }
                    }
                }
            });
            
            // Mouse leave handler
            document.addEventListener('mouseout', function(event) {
                if (event.target.classList.contains('add-to-program-btn') && 
                    !event.target.classList.contains('added')) {
                    
                    event.target.style.background = '#2196f3';
                    hideDropdownOnHover();
                }
            });
        }

        // Initialize application
        function initializeApp() {
            // Load saved program from localStorage
            const savedProgram = localStorage.getItem('selectedProgram');
            if (savedProgram) {
                try {
                    selectedProgram = JSON.parse(savedProgram);
                    updateProgramCounter();
                    updateProgramStats();
                    renderProgramList();
                } catch (e) {
                    console.error('Error loading saved program:', e);
                    selectedProgram = [];
                }
            }
            
            // Load saved login state from localStorage
            const savedLoginState = localStorage.getItem('isLoggedIn');
            if (savedLoginState === 'true') {
                isLoggedIn = true;
                updateUIForLoginState();
            }
        }

        // Column Configuration System
        let columnConfig = {
            columns: [
                { id: 'stt', name: 'STT', visible: true, width: '50px', align: 'center' },
                { id: 'maHP', name: 'Mã HP', visible: true, width: '100px', align: 'left' },
                { id: 'tenViet', name: 'Tên tiếng Việt', visible: true, width: '200px', align: 'left' },
                { id: 'tenAnh', name: 'Tên tiếng Anh', visible: true, width: '180px', align: 'left' },
                { id: 'soTC', name: 'Số TC', visible: true, width: '70px', align: 'center' },
                { id: 'hocTruoc', name: 'Mã HP học trước', visible: true, width: '140px', align: 'left' },
                { id: 'donVi', name: 'Đơn vị quản lý', visible: true, width: '120px', align: 'left' },
                { id: 'batBuoc', name: 'Bắt buộc/Tự chọn', visible: true, width: '130px', align: 'center' },
                { id: 'xoa', name: 'Xóa', visible: true, width: '60px', align: 'center' }
            ]
        };

        // Load column configuration from localStorage
        function loadColumnConfig() {
            const saved = localStorage.getItem('columnConfig');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    
                    // Merge saved config with new default columns
                    // Ensure new columns are added to existing config
                    const defaultColumns = columnConfig.columns;
                    const savedColumns = parsed.columns || [];
                    
                    // Create a map of saved columns by id
                    const savedColumnsMap = {};
                    savedColumns.forEach(col => {
                        savedColumnsMap[col.id] = col;
                    });
                    
                    // Merge: use saved visibility/settings but ensure all default columns exist
                    const mergedColumns = defaultColumns.map(defaultCol => {
                        if (savedColumnsMap[defaultCol.id]) {
                            // Column exists in saved config - use saved settings
                            return { ...defaultCol, ...savedColumnsMap[defaultCol.id] };
                        } else {
                            // New column not in saved config - use default
                            return defaultCol;
                        }
                    });
                    
                    columnConfig.columns = mergedColumns;
                } catch (e) {
                    console.log('Failed to load column config, using default');
                }
            }
        }

        // Save column configuration to localStorage
        function saveColumnConfig() {
            localStorage.setItem('columnConfig', JSON.stringify(columnConfig));
        }

        // Show column configuration modal
        function showColumnConfigModal() {
            const modal = document.getElementById('columnConfigModal');
            const columnList = document.getElementById('columnList');
            
            // Populate column list
            columnList.innerHTML = '';
            columnConfig.columns.forEach((column, index) => {
                const columnItem = document.createElement('div');
                columnItem.className = 'column-item';
                columnItem.draggable = true;
                columnItem.dataset.columnId = column.id;
                columnItem.dataset.index = index;
                
                columnItem.innerHTML = `
                    <input type="checkbox" class="column-checkbox" ${column.visible ? 'checked' : ''} 
                           onchange="toggleColumnVisibility('${column.id}', this.checked)">
                    <span class="column-label">${column.name}</span>
                    <span class="drag-handle">⋮⋮</span>
                `;
                
                // Add drag event listeners
                columnItem.addEventListener('dragstart', handleDragStart);
                columnItem.addEventListener('dragover', handleDragOver);
                columnItem.addEventListener('drop', handleDrop);
                columnItem.addEventListener('dragend', handleDragEnd);
                
                columnList.appendChild(columnItem);
            });
            
            modal.style.display = 'block';
        }

        // Close column configuration modal
        function closeColumnConfigModal() {
            document.getElementById('columnConfigModal').style.display = 'none';
        }

        // Toggle column visibility
        function toggleColumnVisibility(columnId, visible) {
            const column = columnConfig.columns.find(c => c.id === columnId);
            if (column) {
                column.visible = visible;
            }
        }

        // Reset column configuration to default
        function resetColumnConfig() {
            columnConfig = {
                columns: [
                    { id: 'stt', name: 'STT', visible: true, width: '50px', align: 'center' },
                    { id: 'maHP', name: 'Mã HP', visible: true, width: '100px', align: 'left' },
                    { id: 'tenViet', name: 'Tên tiếng Việt', visible: true, width: '200px', align: 'left' },
                    { id: 'tenAnh', name: 'Tên tiếng Anh', visible: true, width: '180px', align: 'left' },
                    { id: 'soTC', name: 'Số TC', visible: true, width: '70px', align: 'center' },
                    { id: 'hocTruoc', name: 'Mã HP học trước', visible: true, width: '140px', align: 'left' },
                    { id: 'donVi', name: 'Đơn vị quản lý', visible: true, width: '120px', align: 'left' },
                    { id: 'batBuoc', name: 'Bắt buộc/Tự chọn', visible: true, width: '130px', align: 'center' },
                    { id: 'xoa', name: 'Xóa', visible: true, width: '60px', align: 'center' }
                ]
            };
            showColumnConfigModal(); // Refresh the modal
        }

        // Apply column configuration and refresh table
        function applyColumnConfig() {
            saveColumnConfig();
            renderProgramList(); // Re-render the table with new configuration
            closeColumnConfigModal();
            showStatus('Đã áp dụng cấu hình cột mới!', 'success');
        }
        
        // Debug function to check current column config (can be called from browser console)
        function debugColumnConfig() {
            console.log('Current column config:', columnConfig);
            console.log('Saved in localStorage:', localStorage.getItem('columnConfig'));
            console.log('Available columns:', columnConfig.columns.map(c => c.name));
            return columnConfig;
        }

        // Drag and drop handlers
        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (this !== draggedElement) {
                const draggedIndex = parseInt(draggedElement.dataset.index);
                const targetIndex = parseInt(this.dataset.index);
                
                // Reorder columns in config
                const draggedColumn = columnConfig.columns.splice(draggedIndex, 1)[0];
                columnConfig.columns.splice(targetIndex, 0, draggedColumn);
                
                // Refresh the modal display
                showColumnConfigModal();
            }
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.column-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('columnConfigModal');
            if (e.target === modal) {
                closeColumnConfigModal();
            }
        });

        // Force update column config for new columns
        function forceUpdateColumnConfig() {
            // Clear old config to ensure new columns are loaded
            localStorage.removeItem('columnConfig');
            loadColumnConfig();
            saveColumnConfig();
            console.log('Column config updated with new columns:', columnConfig.columns.map(c => c.name));
            
            // Refresh UI if column config modal is open
            const modal = document.getElementById('columnConfigModal');
            if (modal && modal.style.display !== 'none') {
                showColumnConfigModal();
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            loadColumnConfig();
            
            // Check if we need to add new columns (for existing users)
            const hasPrerequisiteColumn = columnConfig.columns.some(col => col.id === 'hocTruoc');
            if (!hasPrerequisiteColumn) {
                console.log('Adding new prerequisite column...');
                forceUpdateColumnConfig();
            }
            
            // Setup global event delegation for add-to-program buttons
            setupGlobalEventDelegation();
            
            initializeApp();
        });

        // Prerequisite Course Management System
        


        
        // Create search box for prerequisite courses
        function createPrerequisiteSearchBox(courseCode, currentPrerequisite = '') {
            const searchBoxId = `prerequisite_${courseCode.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const suggestionsId = `suggestions_${courseCode.replace(/[^a-zA-Z0-9]/g, '_')}`;
            
            return `
                <div class="prerequisite-search-container" style="position: relative; width: 100%;">
                    <input type="text" 
                           id="${searchBoxId}"
                           class="prerequisite-search-input"
                           value="${currentPrerequisite}"
                           placeholder="Nhập mã HP..."
                           style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; box-sizing: border-box;"
                           oninput="handlePrerequisiteSearch('${searchBoxId}', '${suggestionsId}', '${courseCode}')"
                           onfocus="showPrerequisiteSuggestions('${searchBoxId}', '${suggestionsId}', '${courseCode}')"
                           onblur="hidePrerequisiteSuggestions('${suggestionsId}')"
                           onkeydown="handlePrerequisiteKeydown(event, '${suggestionsId}', '${courseCode}')">
                    <div id="${suggestionsId}" 
                         class="prerequisite-suggestions"
                         style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; max-height: 200px; overflow-y: auto; z-index: 9999; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 0 0 4px 4px;">
                    </div>
                </div>
            `;
        }
        
        // Handle prerequisite search input
        function handlePrerequisiteSearch(inputId, suggestionsId, targetCourseCode) {
            const input = document.getElementById(inputId);
            const suggestionsDiv = document.getElementById(suggestionsId);
            const query = input.value.toLowerCase().trim();
            
            if (query === '') {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            // Search through all available courses using existing fuzzy logic
            const matches = [];
            if (dictionaryData && dictionaryData.length > 0) {
                ensureFieldDetection();
                
                const searchLower = query.toLowerCase();
                const searchFuzzy = removeDiacritics(searchLower);
                
                dictionaryData.forEach(course => {
                    const courseCode = course[Object.keys(course).find(key => 
                        key.toLowerCase().includes('mã') && key.toLowerCase().includes('hp')
                    )] || '';
                    const courseName = course[Object.keys(course).find(key => 
                        key.toLowerCase().includes('tên') && key.toLowerCase().includes('việt')
                    )] || '';
                    
                    // Skip if this is the same course (can't be prerequisite of itself)
                    if (courseCode === targetCourseCode) return;
                    
                    // Use same fuzzy search logic as main search
                    const codeText = courseCode.toLowerCase();
                    const nameText = courseName.toLowerCase();
                    const codeFuzzy = removeDiacritics(codeText);
                    const nameFuzzy = removeDiacritics(nameText);
                    
                    const codeMatch = codeText.includes(searchLower) || codeFuzzy.includes(searchFuzzy);
                    const nameMatch = nameText.includes(searchLower) || nameFuzzy.includes(searchFuzzy);
                    
                    if (codeMatch || nameMatch) {
                        // Simple scoring for relevance
                        let score = 0;
                        if (codeText === searchLower) score += 100;
                        else if (codeText.startsWith(searchLower)) score += 50;
                        else if (codeMatch) score += 25;
                        if (nameMatch) score += 10;
                        
                        matches.push({ 
                            code: courseCode, 
                            name: courseName, 
                            score: score 
                        });
                    }
                });
                
                // Sort by score (highest first)
                matches.sort((a, b) => b.score - a.score);
            }
            
            // Limit to top 10 matches
            const limitedMatches = matches.slice(0, 10);
            
            if (limitedMatches.length > 0) {
                let suggestionsHTML = '';
                limitedMatches.forEach(match => {
                    suggestionsHTML += `
                        <div class="suggestion-item" 
                             style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 12px;"
                             onmousedown="selectPrerequisite('${inputId}', '${suggestionsId}', '${match.code}', '${targetCourseCode}')"
                             onmouseover="this.style.backgroundColor='#f8f9fa'"
                             onmouseout="this.style.backgroundColor='white'">
                            <div style="font-weight: 600; color: #495057;">${match.code}</div>
                            <div style="color: #6c757d; margin-top: 2px;">${match.name}</div>
                        </div>
                    `;
                });
                suggestionsDiv.innerHTML = suggestionsHTML;
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.innerHTML = '<div style="padding: 12px; color: #6c757d; font-size: 12px; text-align: center;">Không tìm thấy học phần</div>';
                suggestionsDiv.style.display = 'block';
            }
        }
        

        
        // Show prerequisite suggestions
        function showPrerequisiteSuggestions(inputId, suggestionsId, targetCourseCode) {
            const input = document.getElementById(inputId);
            if (input.value.trim() !== '') {
                handlePrerequisiteSearch(inputId, suggestionsId, targetCourseCode);
            }
        }
        
        // Hide prerequisite suggestions
        function hidePrerequisiteSuggestions(suggestionsId) {
            setTimeout(() => {
                const suggestionsDiv = document.getElementById(suggestionsId);
                if (suggestionsDiv) {
                    suggestionsDiv.style.display = 'none';
                }
            }, 200);
        }
        

        
        // Hide all prerequisite suggestions when clicking outside
        document.addEventListener('click', function(event) {
            // Check if click is inside any prerequisite search container
            const clickedInsideSearch = event.target.closest('.prerequisite-search-container');
            
            if (!clickedInsideSearch) {
                // Click outside all search containers - hide all dropdowns
                const allDropdowns = document.querySelectorAll('.prerequisite-suggestions');
                allDropdowns.forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });
        
        // Handle keyboard navigation in suggestions
        function handlePrerequisiteKeydown(event, suggestionsId, targetCourseCode) {
            const suggestionsDiv = document.getElementById(suggestionsId);
            const suggestions = suggestionsDiv.querySelectorAll('.suggestion-item');
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                // Navigate down through suggestions
                let activeIndex = -1;
                suggestions.forEach((item, index) => {
                    if (item.style.backgroundColor === 'rgb(248, 249, 250)') {
                        activeIndex = index;
                        item.style.backgroundColor = 'white';
                    }
                });
                const nextIndex = Math.min(activeIndex + 1, suggestions.length - 1);
                if (suggestions[nextIndex]) {
                    suggestions[nextIndex].style.backgroundColor = '#f8f9fa';
                }
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                // Navigate up through suggestions
                let activeIndex = -1;
                suggestions.forEach((item, index) => {
                    if (item.style.backgroundColor === 'rgb(248, 249, 250)') {
                        activeIndex = index;
                        item.style.backgroundColor = 'white';
                    }
                });
                const prevIndex = Math.max(activeIndex - 1, 0);
                if (suggestions[prevIndex]) {
                    suggestions[prevIndex].style.backgroundColor = '#f8f9fa';
                }
            } else if (event.key === 'Enter') {
                event.preventDefault();
                // Select highlighted suggestion
                const activeSuggestion = suggestionsDiv.querySelector('.suggestion-item[style*="rgb(248, 249, 250)"]');
                if (activeSuggestion) {
                    const courseCode = activeSuggestion.querySelector('div').textContent;
                    const inputId = event.target.id;
                    selectPrerequisite(inputId, suggestionsId, courseCode, targetCourseCode);
                }
            } else if (event.key === 'Escape') {
                suggestionsDiv.style.display = 'none';
            }
        }
        
        // Select a prerequisite course
        function selectPrerequisite(inputId, suggestionsId, prerequisiteCode, targetCourseCode) {
            const input = document.getElementById(inputId);
            const suggestionsDiv = document.getElementById(suggestionsId);
            
            input.value = prerequisiteCode;
            suggestionsDiv.style.display = 'none';
            
            // Save prerequisite data
            savePrerequisiteData(targetCourseCode, prerequisiteCode);
            
            // Update the course item in selectedProgram
            updateCoursePrerequisite(targetCourseCode, prerequisiteCode);
            
            // Show success feedback
            showStatus(`Đã cập nhật học phần điều kiện: ${prerequisiteCode} cho ${targetCourseCode}`, 'success');
            
            // Focus back to input for better UX
            setTimeout(() => input.focus(), 10);
        }
        
        // Save prerequisite data to localStorage
        function savePrerequisiteData(courseCode, prerequisiteCode) {
            let prerequisiteData = {};
            const saved = localStorage.getItem('prerequisiteData');
            if (saved) {
                try {
                    prerequisiteData = JSON.parse(saved);
                } catch (e) {
                    prerequisiteData = {};
                }
            }
            
            prerequisiteData[courseCode] = prerequisiteCode;
            localStorage.setItem('prerequisiteData', JSON.stringify(prerequisiteData));
        }
        
        // Load prerequisite data from localStorage
        function loadPrerequisiteData() {
            const saved = localStorage.getItem('prerequisiteData');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    return {};
                }
            }
            return {};
        }
        

        
        // Load prerequisite for a specific course
        function loadPrerequisiteForCourse(courseCode) {
            const prerequisiteData = loadPrerequisiteData();
            return prerequisiteData[courseCode] || '';
        }
        
        // Update course prerequisite in selectedProgram
        function updateCoursePrerequisite(courseCode, prerequisiteCode) {
            ensureFieldDetection();
            const fields = Object.keys(dataStructure);
            const maHPField = fields.find(field => 
                field.toLowerCase().includes('mã') && field.toLowerCase().includes('hp')
            );
            
            if (maHPField) {
                selectedProgram.forEach(item => {
                    if (item[maHPField] === courseCode) {
                        item.__prerequisite = prerequisiteCode;
                    }
                });
                
                // Save updated program
                localStorage.setItem('selectedProgram', JSON.stringify(selectedProgram));
            }
        }

    </script>

    <!-- Column Configuration Modal -->
    <div id="columnConfigModal" class="column-config-modal">
        <div class="column-config-content">
            <h3 style="margin: 0 0 20px 0; color: #333; text-align: center;">⚙️ Cấu hình cột hiển thị</h3>
            <p style="color: #666; text-align: center; margin-bottom: 25px;">Chọn cột hiển thị và sắp xếp thứ tự bằng cách kéo thả</p>
            
            <div class="column-list" id="columnList">
                <!-- Will be populated dynamically -->
            </div>
            
            <div class="config-buttons">
                <button class="config-btn reset" onclick="resetColumnConfig()">🔄 Mặc định</button>
                <button class="config-btn secondary" onclick="closeColumnConfigModal()">❌ Hủy</button>
                <button class="config-btn primary" onclick="applyColumnConfig()">✅ Áp dụng</button>
            </div>
        </div>
    </div>

</body>
</html>

